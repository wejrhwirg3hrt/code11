<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠå¤©ä¼šè¯ - è§†é¢‘åˆ†äº«å¹³å°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/css/chat.css" rel="stylesheet">
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-video me-2"></i>è§†é¢‘åˆ†äº«å¹³å°
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">
                    <i class="fas fa-home me-1"></i>é¦–é¡µ
                </a>
                <a class="nav-link active" href="/chat">
                    <i class="fas fa-comments me-1"></i>èŠå¤©
                    <span class="badge bg-danger ms-1" id="totalUnreadCount" style="display: none;">0</span>
                </a>
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <img th:src="${currentUser.avatar}" alt="å¤´åƒ" class="rounded-circle me-1" width="24" height="24">
                        <span th:text="${currentUser.username}">ç”¨æˆ·å</span>
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="/profile">ä¸ªäººèµ„æ–™</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="/logout">é€€å‡ºç™»å½•</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <!-- èŠå¤©ç•Œé¢ -->
    <div class="container-fluid chat-container">
        <div class="row h-100">
            <!-- ä¼šè¯åˆ—è¡¨ -->
            <div class="col-md-4 col-lg-3 chat-sidebar">
                <div class="chat-header">
                    <h5 class="mb-0">
                        <i class="fas fa-comments me-2"></i>èŠå¤©
                    </h5>
                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#newChatModal">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                
                <!-- æœç´¢æ¡† -->
                <div class="search-box">
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" class="form-control" placeholder="æœç´¢ä¼šè¯..." id="searchInput">
                    </div>
                </div>

                <!-- ä¼šè¯åˆ—è¡¨ -->
                <div class="conversation-list" id="conversationList">
                    <!-- ä¼šè¯é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                </div>
            </div>

            <!-- èŠå¤©åŒºåŸŸ -->
            <div class="col-md-8 col-lg-9 chat-main">
                <!-- èŠå¤©å¤´éƒ¨ -->
                <div class="chat-header">
                    <div class="d-flex align-items-center">
                        <img src="/images/default-avatar.png" alt="å¤´åƒ" class="rounded-circle me-3" width="40" height="40" id="chatAvatar">
                        <div>
                            <h6 class="mb-0" id="chatTitle">èŠå¤©å¯¹è±¡</h6>
                            <small class="text-muted" id="chatStatus">åœ¨çº¿</small>
                        </div>
                    </div>
                    <div class="chat-actions">
                        <button class="btn btn-sm btn-outline-secondary me-2" title="è§†é¢‘é€šè¯" onclick="alert('è§†é¢‘é€šè¯æŒ‰é’®è¢«ç‚¹å‡»ï¼')" id="videoCallBtn">
                            <i class="fas fa-video"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary me-2" title="è¯­éŸ³é€šè¯" onclick="alert('è¯­éŸ³é€šè¯æŒ‰é’®è¢«ç‚¹å‡»ï¼')" id="audioCallBtn">
                            <i class="fas fa-phone"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info me-2" title="è°ƒè¯•ä¿¡æ¯" onclick="simpleTest()">
                            <i class="fas fa-bug"></i>
                        </button>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="pinConversation()"><i class="fas fa-thumbtack me-2"></i>ç½®é¡¶ä¼šè¯</a></li>
                                <li><a class="dropdown-item" href="#" onclick="muteConversation()"><i class="fas fa-volume-mute me-2"></i>é™éŸ³é€šçŸ¥</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-warning" href="#" onclick="clearChatMessages()"><i class="fas fa-broom me-2"></i>æ¸…ç©ºèŠå¤©è®°å½•</a></li>
                                <li><a class="dropdown-item text-info" href="#" onclick="unfollowUser()"><i class="fas fa-user-minus me-2"></i>å–æ¶ˆå…³æ³¨</a></li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="deleteConversation()"><i class="fas fa-trash me-2"></i>åˆ é™¤ä¼šè¯</a></li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- æ¶ˆæ¯åŒºåŸŸ -->
                <div class="messages-container" id="messagesContainer">
                    <div class="messages-list" id="messagesList">
                        <!-- æ¶ˆæ¯å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                    </div>
                </div>

                <!-- æ–‡ä»¶é¢„è§ˆåŒºåŸŸ -->
                <div class="file-preview-area" id="filePreviewArea" style="display: none;">
                    <div class="file-preview-content">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted">å‡†å¤‡å‘é€çš„æ–‡ä»¶ï¼š</span>
                            <button class="btn btn-sm btn-outline-danger" onclick="clearFilePreview()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div id="filePreviewList">
                            <!-- æ–‡ä»¶é¢„è§ˆé¡¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                    </div>
                </div>

                <!-- è¾“å…¥åŒºåŸŸ -->
                <div class="message-input-area">
                    <div class="input-toolbar">
                        <button class="btn btn-sm btn-outline-secondary" title="è¡¨æƒ…" onclick="toggleEmojiPicker()">
                            <i class="fas fa-smile"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" title="å›¾ç‰‡" onclick="selectFile('image')">
                            <i class="fas fa-image"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" title="æ–‡ä»¶" onclick="selectFile('file')">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" title="è§†é¢‘æ–‡ä»¶" onclick="selectFile('video')">
                            <i class="fas fa-film"></i>
                        </button>
                        <!-- WebRTCé€šè¯æŒ‰é’® -->
                        <button class="btn btn-sm btn-outline-success" title="è¯­éŸ³é€šè¯" onclick="startAudioCall()">
                            <i class="fas fa-phone"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-primary" title="è§†é¢‘é€šè¯" onclick="startVideoCall()">
                            <i class="fas fa-video"></i>
                        </button>
                        <!-- è°ƒè¯•æŒ‰é’® -->
                        <button class="btn btn-sm btn-outline-warning" title="è°ƒè¯•ä¿¡æ¯" onclick="debugWebRTC()">
                            <i class="fas fa-bug"></i>
                        </button>
                    </div>
                    
                    <div class="input-group">
                        <textarea class="form-control" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." rows="1" 
                                  onkeydown="handleMessageInput(event)" oninput="autoResize(this)"></textarea>
                        <button class="btn btn-primary" id="sendButton" onclick="sendMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è¡¨æƒ…é€‰æ‹©å™¨ -->
    <div class="emoji-picker" id="emojiPicker" style="display: none;">
        <div class="emoji-categories">
            <button class="emoji-category active" data-category="faces">ğŸ˜Š</button>
            <button class="emoji-category" data-category="gestures">ğŸ‘</button>
            <button class="emoji-category" data-category="hearts">â¤ï¸</button>
            <button class="emoji-category" data-category="animals">ğŸ±</button>
        </div>
        <div class="emoji-grid" id="emojiGrid">
            <!-- è¡¨æƒ…å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
        </div>
    </div>

    <!-- æ–‡ä»¶è¾“å…¥ -->
    <input type="file" id="fileInput" style="display: none;" multiple accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.txt,.zip,.rar">

    <!-- æ–‡ä»¶é¢„è§ˆæç¤º -->
    <div class="file-upload-tips" style="display: none;">
        <small class="text-muted">
            <i class="fas fa-info-circle me-1"></i>
            æœ€å¤šå¯é€‰æ‹©9ä¸ªæ–‡ä»¶ï¼Œå•ä¸ªæ–‡ä»¶ä¸è¶…è¿‡50MB
        </small>
    </div>

    <!-- é€šè¯ç•Œé¢ -->
    <div id="callInterface" class="call-interface" style="display: none;">
        <div class="call-overlay">
            <div class="call-container">
                <div class="call-header">
                    <h5 id="callTitle">è§†é¢‘é€šè¯</h5>
                    <span id="callStatus">è¿æ¥ä¸­...</span>
                    <span id="callTimer">00:00</span>
                </div>

                <div class="video-container">
                    <video id="remoteVideo" autoplay playsinline class="remote-video"></video>
                    <video id="localVideo" autoplay playsinline muted class="local-video"></video>
                </div>

                <div class="call-controls">
                    <button class="btn btn-secondary" id="muteBtn" onclick="toggleMute()" title="é™éŸ³">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button class="btn btn-secondary" id="videoBtn" onclick="toggleVideo()" title="å…³é—­æ‘„åƒå¤´">
                        <i class="fas fa-video"></i>
                    </button>
                    <button class="btn btn-danger" id="hangupBtn" onclick="endCall()" title="æŒ‚æ–­">
                        <i class="fas fa-phone-slash"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ–°å»ºèŠå¤©æ¨¡æ€æ¡† -->
    <div class="modal fade" id="newChatModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">æ–°å»ºèŠå¤©</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">æœç´¢ç”¨æˆ·</label>
                        <input type="text" class="form-control" id="userSearchInput" placeholder="è¾“å…¥ç”¨æˆ·åæœç´¢...">
                    </div>
                    <div id="userSearchResults" class="user-search-results">
                        <!-- æœç´¢ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è„šæœ¬ -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/lib/sockjs.min.js"></script>
    <script src="/lib/stomp.min.js"></script>
    <script src="/js/chat.js"></script>
    <script src="/js/global-call-popup.js"></script>
    <script src="/js/webrtc-client.js"></script>
    <script src="/js/chat-webrtc-manager.js"></script>
    
    <script>
        // ç®€å•æµ‹è¯•å‡½æ•°
        function simpleTest() {
            try {
                console.log('=== ç®€å•æµ‹è¯•å¼€å§‹ ===');
                alert('JavaScriptæ­£å¸¸å·¥ä½œï¼\n\n' +
                      'å½“å‰ç”¨æˆ·: ' + (window.currentUser ? window.currentUser.username : 'æœªå®šä¹‰') + '\n' +
                      'ä¼šè¯ID: ' + (window.currentConversationId || 'æœªå®šä¹‰') + '\n' +
                      'ChatApp: ' + (typeof ChatApp !== 'undefined' ? 'å·²åŠ è½½' : 'æœªåŠ è½½') + '\n' +
                      'ChatAppå­˜åœ¨: ' + (!!ChatApp ? 'æ˜¯' : 'å¦'));
            } catch (error) {
                alert('JavaScripté”™è¯¯: ' + error.message);
                console.error('æµ‹è¯•é”™è¯¯:', error);
            }
        }

        // åˆå§‹åŒ–èŠå¤©é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯å’Œä¼šè¯ID
            window.currentUser = {
                id: [[${currentUser.id}]],
                username: '[[${currentUser.username}]]',
                avatar: '[[${currentUser.avatar}]]'
            };
            
            window.currentConversationId = [[${conversationId}]];
            
            // åˆå§‹åŒ–èŠå¤©åŠŸèƒ½
            if (typeof ChatApp !== 'undefined') {
                ChatApp.init();

                // ç­‰å¾…ChatAppåˆå§‹åŒ–å®Œæˆåå†åŠ è½½ä¼šè¯
                setTimeout(async () => {
                    await ChatApp.loadConversation(window.currentConversationId);
                    console.log('ä¼šè¯åŠ è½½å®Œæˆï¼Œç›®æ ‡ç”¨æˆ·:', ChatApp.targetUser);
                }, 1000);
            } else {
                console.error('ChatAppæœªå®šä¹‰');
            }

            // å»¶è¿Ÿåˆå§‹åŒ–WebRTCåŠŸèƒ½ï¼Œç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½
            setTimeout(() => {
                initBasicWebRTC();
                initWebRTCManager();
            }, 1000);
        });

        // åŸºç¡€WebRTCå˜é‡
        let localStream = null;
        let isWebRTCReady = false;

        // åŸºç¡€WebRTCåˆå§‹åŒ–
        async function initBasicWebRTC() {
            if (isWebRTCReady) {
                console.log('WebRTCå·²å°±ç»ª');
                return;
            }

            console.log('å¼€å§‹åŸºç¡€WebRTCåˆå§‹åŒ–...');

            try {
                // è·å–åª’ä½“æµ
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });

                // æ˜¾ç¤ºæœ¬åœ°è§†é¢‘
                const localVideo = document.getElementById('localVideo');
                if (localVideo) {
                    localVideo.srcObject = localStream;
                    localVideo.muted = true;
                    console.log('æœ¬åœ°è§†é¢‘æ˜¾ç¤ºæˆåŠŸ');
                }

                isWebRTCReady = true;
                console.log('åŸºç¡€WebRTCåˆå§‹åŒ–å®Œæˆ');

                // æ˜¾ç¤ºæ§åˆ¶æŒ‰é’®
                const controls = document.getElementById('videoControls');
                if (controls) {
                    controls.style.display = 'block';
                }

            } catch (error) {
                console.error('WebRTCåˆå§‹åŒ–å¤±è´¥:', error);
                alert('æ— æ³•è®¿é—®æ‘„åƒå¤´å’Œéº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™');
            }
        }

        // æ³¨æ„ï¼šå®é™…çš„é€šè¯å‡½æ•°åœ¨é¡µé¢åº•éƒ¨å®šä¹‰

        function debugWebRTC() {
            console.log('=== WebRTCè°ƒè¯•ä¿¡æ¯ ===');
            console.log('WebRTCå°±ç»ªçŠ¶æ€:', isWebRTCReady);
            console.log('æœ¬åœ°æµ:', localStream);
            console.log('æœ¬åœ°è§†é¢‘å…ƒç´ :', document.getElementById('localVideo'));
            console.log('ChatWebRTCManagerå­˜åœ¨:', !!window.chatWebRTCManager);
            console.log('ChatWebRTCManagerå·²åˆå§‹åŒ–:', window.chatWebRTCManager?.isInitialized);
            console.log('WebRTCå®¢æˆ·ç«¯å­˜åœ¨:', !!window.chatWebRTCManager?.webrtcClient);
            console.log('WebSocketè¿æ¥çŠ¶æ€:', window.chatWebRTCManager?.stompClient?.connected);
            console.log('å½“å‰ç”¨æˆ·:', window.chatWebRTCManager?.currentUser);
            console.log('ç›®æ ‡ç”¨æˆ·ID:', getTargetUserId());

            // æ˜¾ç¤ºçŠ¶æ€å¼¹çª—
            const status = {
                webrtcReady: isWebRTCReady,
                managerExists: !!window.chatWebRTCManager,
                managerInitialized: window.chatWebRTCManager?.isInitialized,
                webrtcClient: !!window.chatWebRTCManager?.webrtcClient,
                websocketConnected: window.chatWebRTCManager?.stompClient?.connected,
                currentUser: window.chatWebRTCManager?.currentUser?.username,
                targetUserId: getTargetUserId()
            };

            alert('WebRTCçŠ¶æ€:\n' + JSON.stringify(status, null, 2));

            if (localStream) {
                console.log('è§†é¢‘è½¨é“:', localStream.getVideoTracks());
                console.log('éŸ³é¢‘è½¨é“:', localStream.getAudioTracks());
            }
        }

        // æµ‹è¯•è§†é¢‘é€šè¯å‡½æ•°
        function testStartVideoCall() {
            console.log('=== æµ‹è¯•è§†é¢‘é€šè¯ ===');
            console.log('å½“å‰ç”¨æˆ·:', window.currentUser);

            const targetUserId = getTargetUserId();
            console.log('ç›®æ ‡ç”¨æˆ·ID:', targetUserId);
            console.log('WebRTCç®¡ç†å™¨:', window.chatWebRTCManager);
            console.log('WebSocket:', window.chatWebSocket);
            console.log('ChatApp:', ChatApp);
            console.log('ChatApp.targetUser:', ChatApp?.targetUser);

            if (!targetUserId) {
                alert('è¯·å…ˆé€‰æ‹©èŠå¤©å¯¹è±¡\n\nè°ƒè¯•ä¿¡æ¯:\n' +
                      '- ChatAppå­˜åœ¨: ' + !!ChatApp + '\n' +
                      '- ChatApp.targetUser: ' + (ChatApp?.targetUser || 'æ— ') + '\n' +
                      '- å½“å‰ä¼šè¯ID: ' + (window.currentConversationId || 'æ— '));
                return;
            }

            if (!window.currentUser) {
                alert('ç”¨æˆ·æœªç™»å½•');
                return;
            }

            console.log('å¼€å§‹å‘èµ·è§†é¢‘é€šè¯...');
            startVideoCall();
        }

        // æµ‹è¯•è¯­éŸ³é€šè¯å‡½æ•°
        function testStartAudioCall() {
            console.log('=== æµ‹è¯•è¯­éŸ³é€šè¯ ===');
            console.log('å½“å‰ç”¨æˆ·:', window.currentUser);

            const targetUserId = getTargetUserId();
            console.log('ç›®æ ‡ç”¨æˆ·ID:', targetUserId);
            console.log('WebRTCç®¡ç†å™¨:', window.chatWebRTCManager);
            console.log('WebSocket:', window.chatWebSocket);
            console.log('ChatApp:', ChatApp);
            console.log('ChatApp.targetUser:', ChatApp?.targetUser);

            if (!targetUserId) {
                alert('è¯·å…ˆé€‰æ‹©èŠå¤©å¯¹è±¡\n\nè°ƒè¯•ä¿¡æ¯:\n' +
                      '- ChatAppå­˜åœ¨: ' + !!ChatApp + '\n' +
                      '- ChatApp.targetUser: ' + (ChatApp?.targetUser || 'æ— ') + '\n' +
                      '- å½“å‰ä¼šè¯ID: ' + (window.currentConversationId || 'æ— '));
                return;
            }

            if (!window.currentUser) {
                alert('ç”¨æˆ·æœªç™»å½•');
                return;
            }

            console.log('å¼€å§‹å‘èµ·è¯­éŸ³é€šè¯...');
            startAudioCall();
        }

        // æ˜¾ç¤ºè¯¦ç»†è°ƒè¯•ä¿¡æ¯
        function showDetailedDebugInfo() {
            console.log('=== è¯¦ç»†è°ƒè¯•ä¿¡æ¯ ===');

            const debugInfo = {
                'é¡µé¢åŸºæœ¬ä¿¡æ¯': {
                    'å½“å‰ç”¨æˆ·': window.currentUser,
                    'å½“å‰ä¼šè¯ID': window.currentConversationId,
                    'URLå‚æ•°': window.location.search
                },
                'ChatAppçŠ¶æ€': {
                    'ChatAppå­˜åœ¨': !!ChatApp,
                    'ChatAppåˆå§‹åŒ–': ChatApp ? 'yes' : 'no',
                    'ChatApp.currentUser': ChatApp?.currentUser,
                    'ChatApp.currentConversationId': ChatApp?.currentConversationId,
                    'ChatApp.targetUser': ChatApp?.targetUser,
                    'ChatApp.conversationsé•¿åº¦': ChatApp?.conversations?.length,
                    'ChatApp.connected': ChatApp?.connected
                },
                'WebRTCçŠ¶æ€': {
                    'WebRTCç®¡ç†å™¨å­˜åœ¨': !!window.chatWebRTCManager,
                    'WebRTCç®¡ç†å™¨åˆå§‹åŒ–': window.chatWebRTCManager?.isInitialized,
                    'WebRTCå®¢æˆ·ç«¯': !!window.chatWebRTCManager?.webrtcClient,
                    'WebSocketè¿æ¥': window.chatWebRTCManager?.stompClient?.connected
                },
                'ç›®æ ‡ç”¨æˆ·è·å–': {
                    'getTargetUserId()ç»“æœ': getTargetUserId(),
                    'è·å–æ–¹æ³•æµ‹è¯•': testGetTargetUserId()
                }
            };

            console.log('è°ƒè¯•ä¿¡æ¯:', debugInfo);

            // æ˜¾ç¤ºæ ¼å¼åŒ–çš„è°ƒè¯•ä¿¡æ¯
            let debugText = '=== èŠå¤©ç³»ç»Ÿè°ƒè¯•ä¿¡æ¯ ===\n\n';

            for (const [category, data] of Object.entries(debugInfo)) {
                debugText += `ã€${category}ã€‘\n`;
                for (const [key, value] of Object.entries(data)) {
                    debugText += `  ${key}: ${JSON.stringify(value)}\n`;
                }
                debugText += '\n';
            }

            alert(debugText);
        }

        // æµ‹è¯•è·å–ç›®æ ‡ç”¨æˆ·IDçš„å„ç§æ–¹æ³•
        function testGetTargetUserId() {
            const results = {};

            // æ–¹æ³•1: ChatApp.targetUser
            if (ChatApp && ChatApp.targetUser && ChatApp.targetUser.id) {
                results.method1_ChatApp_targetUser = ChatApp.targetUser.id;
            }

            // æ–¹æ³•2: ChatApp.currentConversation
            if (ChatApp && ChatApp.currentConversation && ChatApp.currentConversation.participants) {
                const otherParticipant = ChatApp.currentConversation.participants.find(
                    p => p.user.id !== window.currentUser.id
                );
                if (otherParticipant) {
                    results.method2_currentConversation = otherParticipant.user.id;
                }
            }

            // æ–¹æ³•3: conversationsåˆ—è¡¨
            const conversationId = window.currentConversationId || ChatApp?.currentConversationId;
            if (ChatApp && ChatApp.conversations && conversationId) {
                const conversation = ChatApp.conversations.find(c => c.id === conversationId);
                if (conversation && conversation.participants) {
                    const otherParticipant = conversation.participants.find(
                        p => p.user.id !== window.currentUser.id
                    );
                    if (otherParticipant) {
                        results.method3_conversations_list = otherParticipant.user.id;
                    }
                }
            }

            return results;
        }

        // WebRTCç›¸å…³åŠŸèƒ½
        let webrtcClient = null;
        let webrtcStompClient = null;
        let webrtcManager = null;

        // åˆå§‹åŒ–WebRTCåŠŸèƒ½ï¼ˆå¢å¼ºç‰ˆæœ¬ï¼‰
        async function initWebRTCForChat() {
            try {
                console.log('=== å¼€å§‹åˆå§‹åŒ–èŠå¤©é¡µé¢WebRTCåŠŸèƒ½ ===');

                // 1. å¼ºåˆ¶åˆå§‹åŒ–å…¨å±€å¼¹çª—
                if (typeof GlobalCallPopup !== 'undefined') {
                    window.globalCallPopup = new GlobalCallPopup();
                    console.log('âœ… å¼ºåˆ¶åˆå§‹åŒ–å…¨å±€å¼¹çª—');
                } else {
                    console.error('âŒ GlobalCallPopupç±»æœªæ‰¾åˆ°');
                }

                // 2. ç¡®ä¿ç”¨æˆ·ä¿¡æ¯å­˜åœ¨
                if (!window.currentUser) {
                    console.log('ğŸ”„ ç”¨æˆ·ä¿¡æ¯ç¼ºå¤±ï¼Œå°è¯•è·å–...');
                    await getCurrentUserForWebRTC();
                }

                if (!window.currentUser || !window.currentUser.id) {
                    console.error('âŒ æ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯ï¼ŒWebRTCåˆå§‹åŒ–å¤±è´¥');
                    return;
                }

                console.log('âœ… ç”¨æˆ·ä¿¡æ¯ç¡®è®¤:', window.currentUser);

                // 3. å¼ºåˆ¶åˆ›å»ºç‹¬ç«‹WebSocketè¿æ¥
                console.log('ğŸ”Œ åˆ›å»ºWebSocketè¿æ¥...');
                await createForceWebSocketConnection();

                // 4. å¼ºåˆ¶è®¢é˜…æ¶ˆæ¯
                console.log('ğŸ“¡ è®¢é˜…WebRTCæ¶ˆæ¯...');
                forceSubscribeMessages();

                // 5. åˆå§‹åŒ–WebRTCå®¢æˆ·ç«¯
                console.log('ğŸ¥ åˆå§‹åŒ–WebRTCå®¢æˆ·ç«¯...');
                await initWebRTCClient();

                console.log('=== âœ… èŠå¤©é¡µé¢WebRTCå¼ºåˆ¶åˆå§‹åŒ–å®Œæˆ ===');

            } catch (error) {
                console.error('âŒ WebRTCåˆå§‹åŒ–å¤±è´¥:', error);
                // é‡è¯•æœºåˆ¶
                setTimeout(() => {
                    console.log('ğŸ”„ 5ç§’åé‡è¯•WebRTCåˆå§‹åŒ–...');
                    initWebRTCForChat();
                }, 5000);
            }
        }

        // åˆå§‹åŒ–WebRTCå®¢æˆ·ç«¯
        async function initWebRTCClient() {
            try {
                if (typeof WebRTCClient === 'undefined') {
                    throw new Error('WebRTCClientç±»æœªåŠ è½½');
                }

                webrtcClient = new WebRTCClient();
                webrtcClient.stompClient = webrtcStompClient;
                webrtcClient.currentUserId = window.currentUser.id.toString();

                // è®¾ç½®å…¨å±€å˜é‡
                window.webrtcClient = webrtcClient;

                // è®¾ç½®äº‹ä»¶å›è°ƒ
                setupWebRTCCallbacks();

                console.log('âœ… WebRTCå®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ');
            } catch (error) {
                console.error('âŒ WebRTCå®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥:', error);
                throw error;
            }
        }

        // å¼ºåˆ¶åˆ›å»ºWebSocketè¿æ¥ï¼ˆå¢å¼ºç‰ˆï¼‰
        function createForceWebSocketConnection() {
            return new Promise((resolve, reject) => {
                try {
                    console.log('ğŸ”¥ å¼ºåˆ¶åˆ›å»ºWebSocketè¿æ¥...');

                    // å¦‚æœå·²æœ‰è¿æ¥ï¼Œå…ˆæ–­å¼€
                    if (webrtcStompClient && webrtcStompClient.connected) {
                        console.log('ğŸ”„ æ–­å¼€ç°æœ‰WebSocketè¿æ¥...');
                        webrtcStompClient.disconnect();
                    }

                    const socket = new SockJS('/ws');
                    webrtcStompClient = Stomp.over(socket);

                    // å¯ç”¨è°ƒè¯•æ—¥å¿—ä»¥ä¾¿æ’æŸ¥é—®é¢˜
                    webrtcStompClient.debug = function(str) {
                        console.log('STOMP Debug:', str);
                    };

                    // è®¾ç½®å¿ƒè·³ä¿æŒè¿æ¥
                    webrtcStompClient.heartbeat.outgoing = 10000;  // 10ç§’å‘é€å¿ƒè·³
                    webrtcStompClient.heartbeat.incoming = 10000;  // 10ç§’æ¥æ”¶å¿ƒè·³

                    webrtcStompClient.connect({}, function(frame) {
                        console.log('âœ… å¼ºåˆ¶WebSocketè¿æ¥æˆåŠŸ: ' + frame);
                        window.stompClient = webrtcStompClient;

                        // å»¶è¿Ÿä¸€ä¸‹ç¡®ä¿è¿æ¥ç¨³å®š
                        setTimeout(() => {
                            resolve();
                        }, 500);

                    }, function(error) {
                        console.error('âŒ å¼ºåˆ¶WebSocketè¿æ¥å¤±è´¥:', error);
                        reject(error);
                    });

                    // ç›‘å¬è¿æ¥æ–­å¼€äº‹ä»¶
                    socket.onclose = function(event) {
                        console.warn('âš ï¸ WebSocketè¿æ¥æ–­å¼€:', event);
                        // è‡ªåŠ¨é‡è¿
                        setTimeout(() => {
                            console.log('ğŸ”„ å°è¯•é‡æ–°è¿æ¥WebSocket...');
                            createForceWebSocketConnection().catch(console.error);
                        }, 3000);
                    };

                } catch (error) {
                    console.error('âŒ åˆ›å»ºWebSocketè¿æ¥å¼‚å¸¸:', error);
                    reject(error);
                }
            });
        }

        // å¼ºåˆ¶è®¢é˜…æ¶ˆæ¯ï¼ˆå¢å¼ºç‰ˆï¼‰
        function forceSubscribeMessages() {
            if (!webrtcStompClient || !window.currentUser) {
                console.error('âŒ æ— æ³•è®¢é˜…ï¼šè¿æ¥æˆ–ç”¨æˆ·ç¼ºå¤±');
                return;
            }

            console.log('ğŸ”¥ å¼ºåˆ¶è®¢é˜…WebRTCæ¶ˆæ¯...');
            console.log('å½“å‰ç”¨æˆ·ID:', window.currentUser.id);

            try {
                // 1. è®¢é˜…é€šè¯é‚€è¯·ï¼ˆç”¨æˆ·é˜Ÿåˆ—ï¼‰
                const userQueueSub = webrtcStompClient.subscribe(`/user/queue/webrtc/call-invitation`, function(message) {
                    const data = JSON.parse(message.body);
                    console.log('ğŸ”” æ”¶åˆ°é€šè¯é‚€è¯·(ç”¨æˆ·é˜Ÿåˆ—):', data);
                    forceShowCallPopup(data);
                });
                console.log('âœ… è®¢é˜…ç”¨æˆ·é˜Ÿåˆ—æˆåŠŸ:', userQueueSub.id);

                // 2. è®¢é˜…é€šè¯é‚€è¯·ï¼ˆå¹¿æ’­é¢‘é“ï¼‰
                const topicSub = webrtcStompClient.subscribe(`/topic/webrtc/call-invitation/${window.currentUser.id}`, function(message) {
                    const data = JSON.parse(message.body);
                    console.log('ğŸ”” æ”¶åˆ°é€šè¯é‚€è¯·(å¹¿æ’­é¢‘é“):', data);
                    forceShowCallPopup(data);
                });
                console.log('âœ… è®¢é˜…å¹¿æ’­é¢‘é“æˆåŠŸ:', topicSub.id);

                // 3. è®¢é˜…å¼ºåˆ¶å¹¿æ’­é¢‘é“ï¼ˆæ–°å¢ï¼‰
                const broadcastSub = webrtcStompClient.subscribe(`/topic/webrtc/call-invitation-broadcast`, function(message) {
                    const data = JSON.parse(message.body);
                    console.log('ğŸ”” æ”¶åˆ°é€šè¯é‚€è¯·(å¼ºåˆ¶å¹¿æ’­):', data);
                    // æ£€æŸ¥æ˜¯å¦æ˜¯å‘ç»™å½“å‰ç”¨æˆ·çš„
                    if (data.calleeId === window.currentUser.id.toString()) {
                        forceShowCallPopup(data);
                    }
                });
                console.log('âœ… è®¢é˜…å¼ºåˆ¶å¹¿æ’­é¢‘é“æˆåŠŸ:', broadcastSub.id);

                // 4. è®¢é˜…åŠ å…¥æˆåŠŸæ¶ˆæ¯
                const joinedSub = webrtcStompClient.subscribe(`/user/queue/webrtc/joined`, function(message) {
                    const data = JSON.parse(message.body);
                    console.log('âœ… åŠ å…¥ä¿¡ä»¤æœåŠ¡å™¨æˆåŠŸ:', data);
                });
                console.log('âœ… è®¢é˜…åŠ å…¥æˆåŠŸæ¶ˆæ¯:', joinedSub.id);

                // 5. è®¢é˜…é€šè¯æ¥å—
                const acceptSub = webrtcStompClient.subscribe(`/user/queue/webrtc/call-accepted`, function(message) {
                    const data = JSON.parse(message.body);
                    console.log('âœ… é€šè¯è¢«æ¥å—:', data);
                    if (webrtcClient && webrtcClient.onCallAccepted) {
                        webrtcClient.onCallAccepted(data);
                    }
                });
                console.log('âœ… è®¢é˜…é€šè¯æ¥å—æˆåŠŸ:', acceptSub.id);

                // 6. è®¢é˜…é€šè¯æ‹’ç»
                const rejectSub = webrtcStompClient.subscribe(`/user/queue/webrtc/call-rejected`, function(message) {
                    const data = JSON.parse(message.body);
                    console.log('âŒ é€šè¯è¢«æ‹’ç»:', data);
                    if (webrtcClient && webrtcClient.onCallRejected) {
                        webrtcClient.onCallRejected(data);
                    }
                });
                console.log('âœ… è®¢é˜…é€šè¯æ‹’ç»æˆåŠŸ:', rejectSub.id);

                // 7. è®¢é˜…é€šè¯ç»“æŸ
                const endSub = webrtcStompClient.subscribe(`/user/queue/webrtc/call-ended`, function(message) {
                    const data = JSON.parse(message.body);
                    console.log('ğŸ”š é€šè¯ç»“æŸ:', data);
                    if (webrtcClient && webrtcClient.onCallEnded) {
                        webrtcClient.onCallEnded(data);
                    }
                });
                console.log('âœ… è®¢é˜…é€šè¯ç»“æŸæˆåŠŸ:', endSub.id);

                console.log('âœ… æ‰€æœ‰æ¶ˆæ¯è®¢é˜…å®Œæˆï¼Œå‡†å¤‡å‘é€åŠ å…¥æ¶ˆæ¯...');

                // å»¶è¿Ÿå‘é€åŠ å…¥æ¶ˆæ¯ï¼Œç¡®ä¿è®¢é˜…å®Œæˆ
                setTimeout(() => {
                    webrtcStompClient.send('/app/webrtc/join', {}, JSON.stringify({
                        userId: window.currentUser.id.toString()
                    }));
                    console.log('ğŸ“¤ å‘é€åŠ å…¥æ¶ˆæ¯ï¼Œç”¨æˆ·ID:', window.currentUser.id);
                }, 500);

            } catch (error) {
                console.error('âŒ è®¢é˜…æ¶ˆæ¯å¤±è´¥:', error);
                throw error;
            }
        }

        // å¼ºåˆ¶æ˜¾ç¤ºé€šè¯å¼¹çª—
        function forceShowCallPopup(data) {
            console.log('ğŸš¨ å¼ºåˆ¶æ˜¾ç¤ºé€šè¯å¼¹çª—:', data);

            if (window.globalCallPopup) {
                window.globalCallPopup.show(data);
                console.log('âœ… å¼¹çª—å·²æ˜¾ç¤º');
            } else {
                // ç«‹å³åˆ›å»ºå¼¹çª—
                if (typeof GlobalCallPopup !== 'undefined') {
                    window.globalCallPopup = new GlobalCallPopup();
                    window.globalCallPopup.show(data);
                    console.log('âœ… ä¸´æ—¶åˆ›å»ºå¼¹çª—å¹¶æ˜¾ç¤º');
                } else {
                    // æœ€åçš„å¤‡ç”¨æ–¹æ¡ˆ
                    const accept = confirm(`ğŸ”” æ”¶åˆ°æ¥è‡ª ${data.callerName} çš„${data.callType}é€šè¯é‚€è¯·ï¼Œæ˜¯å¦æ¥å¬ï¼Ÿ`);
                    if (accept) {
                        acceptCall(data.roomId);
                    } else {
                        rejectCall(data.roomId);
                    }
                }
            }
        }

        // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼ˆç”¨äºWebRTCï¼‰
        async function getCurrentUserForWebRTC() {
            try {
                // å¦‚æœå·²ç»æœ‰ç”¨æˆ·ä¿¡æ¯ï¼Œç›´æ¥ä½¿ç”¨
                if (window.currentUser && window.currentUser.id) {
                    console.log('ä½¿ç”¨ç°æœ‰ç”¨æˆ·ä¿¡æ¯:', window.currentUser);
                    return;
                }

                // å¦åˆ™ä»APIè·å–
                const response = await fetch('/api/chat/user');
                if (response.ok) {
                    const userData = await response.json();
                    window.currentUser = userData;
                    console.log('ä»APIè·å–ç”¨æˆ·ä¿¡æ¯æˆåŠŸ:', userData);
                } else {
                    throw new Error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥');
                }
            } catch (error) {
                console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                throw error;
            }
        }

        // ç­‰å¾…èŠå¤©WebSocketè¿æ¥å°±ç»ªï¼Œç„¶åå¤ç”¨å®ƒ
        function waitForChatWebSocket() {
            return new Promise((resolve, reject) => {
                console.log('ç­‰å¾…èŠå¤©WebSocketè¿æ¥å°±ç»ª...');

                let attempts = 0;
                const maxAttempts = 20; // 10ç§’ï¼Œæ¯500msæ£€æŸ¥ä¸€æ¬¡

                // æ£€æŸ¥ChatAppæ˜¯å¦å·²è¿æ¥
                function checkConnection() {
                    attempts++;
                    console.log(`æ£€æŸ¥è¿æ¥çŠ¶æ€ (${attempts}/${maxAttempts}):`, {
                        'window.ChatApp': !!window.ChatApp,
                        'ChatApp.stompClient': !!(window.ChatApp && window.ChatApp.stompClient),
                        'ChatApp.connected': !!(window.ChatApp && window.ChatApp.connected)
                    });

                    if (window.ChatApp && window.ChatApp.stompClient) {
                        console.log('èŠå¤©WebSocketå·²è¿æ¥ï¼Œå¤ç”¨è¿æ¥');

                        // ä½¿ç”¨èŠå¤©çš„WebSocketè¿æ¥
                        webrtcStompClient = window.ChatApp.stompClient;
                        window.stompClient = webrtcStompClient;

                        // ç«‹å³è®¢é˜…WebRTCæ¶ˆæ¯
                        subscribeToWebRTCMessages();

                        resolve();
                    } else if (attempts >= maxAttempts) {
                        console.error('ç­‰å¾…èŠå¤©WebSocketè¿æ¥è¶…æ—¶ï¼Œå°è¯•ç‹¬ç«‹è¿æ¥');
                        // å›é€€åˆ°ç‹¬ç«‹è¿æ¥
                        initSimpleWebSocket().then(resolve).catch(reject);
                    } else {
                        // ç»§ç»­ç­‰å¾…
                        setTimeout(checkConnection, 500);
                    }
                }

                checkConnection();
            });
        }

        // ç®€å•ç›´æ¥çš„WebSocketè¿æ¥ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
        function initSimpleWebSocket() {
            return new Promise((resolve, reject) => {
                try {
                    console.log('å¼€å§‹è¿æ¥WebSocketï¼ˆç®€å•æ¨¡å¼ï¼‰...');

                    const socket = new SockJS('/ws');
                    webrtcStompClient = Stomp.over(socket);

                    // ç¦ç”¨è°ƒè¯•æ—¥å¿—ï¼ˆå‚è€ƒæµ‹è¯•é¡µé¢ï¼‰
                    webrtcStompClient.debug = null;

                    webrtcStompClient.connect({}, function(frame) {
                        console.log('WebSocketè¿æ¥æˆåŠŸ: ' + frame);

                        // è®¾ç½®å…¨å±€å˜é‡ä¾›WebRTCClientä½¿ç”¨
                        window.stompClient = webrtcStompClient;

                        // ç«‹å³è®¢é˜…æ¶ˆæ¯ï¼ˆå‚è€ƒæµ‹è¯•é¡µé¢ï¼‰
                        subscribeToWebRTCMessages();

                        resolve();
                    }, function(error) {
                        console.error('WebSocketè¿æ¥å¤±è´¥: ' + error);
                        reject(new Error('WebSocketè¿æ¥å¤±è´¥'));
                    });
                } catch (error) {
                    console.error('WebSocketåˆå§‹åŒ–å¼‚å¸¸: ' + error.message);
                    reject(error);
                }
            });
        }

        // åŸæ¥çš„å¤æ‚WebSocketè¿æ¥ï¼ˆå¤‡ç”¨ï¼‰
        function initWebRTCWebSocket() {
            return new Promise((resolve, reject) => {
                try {
                    console.log('åˆ›å»ºWebRTCä¸“ç”¨WebSocketè¿æ¥...');

                    const socket = new SockJS('/ws');
                    webrtcStompClient = Stomp.over(socket);

                    // å¯ç”¨è°ƒè¯•æ—¥å¿—ä»¥ä¾¿æ’æŸ¥é—®é¢˜
                    webrtcStompClient.debug = function(str) {
                        console.log('STOMP Debug:', str);
                    };

                    // è®¾ç½®å¼ºåŠ›å¿ƒè·³ä¿æŒè¿æ¥
                    webrtcStompClient.heartbeat.outgoing = 5000;  // 5ç§’å‘é€å¿ƒè·³
                    webrtcStompClient.heartbeat.incoming = 5000;  // 5ç§’æ¥æ”¶å¿ƒè·³

                    webrtcStompClient.connect({}, function(frame) {
                        console.log('WebRTC WebSocketè¿æ¥æˆåŠŸ: ' + frame);

                        // è®¾ç½®å…¨å±€å˜é‡ä¾›WebRTCClientä½¿ç”¨
                        window.stompClient = webrtcStompClient;

                        // å»¶è¿Ÿè®¢é˜…æ¶ˆæ¯ï¼Œç¡®ä¿è¿æ¥ç¨³å®š
                        setTimeout(() => {
                            subscribeToWebRTCMessages();

                            // å¯åŠ¨ä¿æ´»æœºåˆ¶
                            startWebRTCKeepAlive();

                            resolve();
                        }, 1000);

                    }, function(error) {
                        console.error('WebRTC WebSocketè¿æ¥å¤±è´¥: ' + error);
                        reject(new Error('WebRTC WebSocketè¿æ¥å¤±è´¥'));
                    });

                    // ç›‘å¬è¿æ¥æ–­å¼€äº‹ä»¶
                    socket.onclose = function(event) {
                        console.warn('WebSocketè¿æ¥æ–­å¼€:', event);
                        // è‡ªåŠ¨é‡è¿
                        setTimeout(() => {
                            console.log('å°è¯•é‡æ–°è¿æ¥WebSocket...');
                            initWebRTCWebSocket();
                        }, 3000);
                    };

                } catch (error) {
                    console.error('WebRTC WebSocketåˆå§‹åŒ–å¼‚å¸¸: ' + error.message);
                    reject(error);
                }
            });
        }

        // WebRTCä¿æ´»æœºåˆ¶
        function startWebRTCKeepAlive() {
            // æ¸…é™¤ä¹‹å‰çš„ä¿æ´»å®šæ—¶å™¨
            if (window.webrtcKeepAliveInterval) {
                clearInterval(window.webrtcKeepAliveInterval);
            }

            console.log('å¯åŠ¨WebRTCä¿æ´»æœºåˆ¶');

            window.webrtcKeepAliveInterval = setInterval(() => {
                if (webrtcStompClient && webrtcStompClient.connected && window.currentUser) {
                    try {
                        // å‘é€ä¿æ´»æ¶ˆæ¯
                        webrtcStompClient.send('/app/webrtc/keepalive', {}, JSON.stringify({
                            userId: window.currentUser.id,
                            timestamp: Date.now()
                        }));
                        console.log('å‘é€WebRTCä¿æ´»æ¶ˆæ¯');
                    } catch (error) {
                        console.error('å‘é€ä¿æ´»æ¶ˆæ¯å¤±è´¥:', error);
                        // å¦‚æœå‘é€å¤±è´¥ï¼Œå°è¯•é‡è¿
                        setTimeout(() => {
                            initWebRTCWebSocket();
                        }, 1000);
                    }
                } else {
                    console.warn('WebSocketæœªè¿æ¥ï¼Œåœæ­¢ä¿æ´»å¹¶å°è¯•é‡è¿');
                    clearInterval(window.webrtcKeepAliveInterval);

                    // å°è¯•é‡è¿
                    setTimeout(() => {
                        initWebRTCWebSocket();
                    }, 2000);
                }
            }, 15000); // 15ç§’å‘é€ä¸€æ¬¡ä¿æ´»æ¶ˆæ¯
        }

        // è®¢é˜…WebRTCæ¶ˆæ¯ï¼ˆç®€åŒ–ç‰ˆï¼Œå‚è€ƒæµ‹è¯•é¡µé¢ï¼‰
        function subscribeToWebRTCMessages() {
            if (!webrtcStompClient || !window.currentUser) {
                console.error('WebRTC WebSocketæœªè¿æ¥æˆ–ç”¨æˆ·ä¿¡æ¯ç¼ºå¤±');
                return;
            }

            console.log('å¼€å§‹è®¢é˜…æ¶ˆæ¯...');

            // è®¢é˜…é€šè¯é‚€è¯·ï¼ˆç”¨æˆ·é˜Ÿåˆ—ï¼‰
            webrtcStompClient.subscribe(`/user/queue/webrtc/call-invitation`, function(message) {
                const data = JSON.parse(message.body);
                console.log('æ”¶åˆ°é€šè¯é‚€è¯·(ç”¨æˆ·é˜Ÿåˆ—): ' + JSON.stringify(data));
                handleCallInvitation(data);
            });

            // è®¢é˜…é€šè¯é‚€è¯·ï¼ˆå¹¿æ’­é¢‘é“ï¼‰
            webrtcStompClient.subscribe(`/topic/webrtc/call-invitation/${window.currentUser.id}`, function(message) {
                const data = JSON.parse(message.body);
                console.log('æ”¶åˆ°é€šè¯é‚€è¯·(å¹¿æ’­é¢‘é“): ' + JSON.stringify(data));
                handleCallInvitation(data);
            });

            // è®¢é˜…é€šè¯æ¥å—
            webrtcStompClient.subscribe(`/user/queue/webrtc/call-accepted`, function(message) {
                const data = JSON.parse(message.body);
                console.log('é€šè¯è¢«æ¥å—: ' + JSON.stringify(data));
                if (webrtcClient && webrtcClient.onCallAccepted) {
                    webrtcClient.onCallAccepted(data);
                }
            });

            // è®¢é˜…é€šè¯æ‹’ç»
            webrtcStompClient.subscribe(`/user/queue/webrtc/call-rejected`, function(message) {
                const data = JSON.parse(message.body);
                console.log('é€šè¯è¢«æ‹’ç»: ' + JSON.stringify(data));
                if (webrtcClient && webrtcClient.onCallRejected) {
                    webrtcClient.onCallRejected(data);
                }
            });

            // è®¢é˜…é€šè¯ç»“æŸ
            webrtcStompClient.subscribe(`/user/queue/webrtc/call-ended`, function(message) {
                const data = JSON.parse(message.body);
                console.log('é€šè¯ç»“æŸ: ' + JSON.stringify(data));
                if (webrtcClient && webrtcClient.onCallEnded) {
                    webrtcClient.onCallEnded(data);
                }
            });

            console.log('æ¶ˆæ¯è®¢é˜…å®Œæˆ');
        }

        // å¤„ç†æ¥ç”µé‚€è¯·
        function handleCallInvitation(data) {
            console.log('å¤„ç†æ¥ç”µé‚€è¯·: ', data);
            forceShowCallPopup(data);
        }

        // æ¥å—é€šè¯
        function acceptCall(roomId) {
            console.log('âœ… æ¥å—é€šè¯:', roomId);

            // ä½¿ç”¨webrtcClientæ¥å—é€šè¯ï¼ˆè¿™ä¼šå¤„ç†åª’ä½“æµå’ŒWebRTCè¿æ¥ï¼‰
            if (webrtcClient) {
                webrtcClient.acceptCall(roomId).then(() => {
                    console.log('âœ… WebRTCé€šè¯è¿æ¥å»ºç«‹æˆåŠŸ');
                    // æ˜¾ç¤ºé€šè¯ç•Œé¢
                    showCallInterface('video', {roomId: roomId}, 'connected');
                }).catch(error => {
                    console.error('âŒ WebRTCé€šè¯è¿æ¥å¤±è´¥:', error);
                });
            } else {
                console.error('âŒ webrtcClientæœªåˆå§‹åŒ–');
            }
        }

        // æ‹’ç»é€šè¯
        function rejectCall(roomId) {
            console.log('âŒ æ‹’ç»é€šè¯:', roomId);

            // ä½¿ç”¨webrtcClientæ‹’ç»é€šè¯
            if (webrtcClient) {
                webrtcClient.rejectCall(roomId);
                console.log('âŒ å·²é€šè¿‡webrtcClientæ‹’ç»é€šè¯');
            } else if (webrtcStompClient) {
                // å¤‡ç”¨æ–¹æ¡ˆï¼šç›´æ¥å‘é€æ‹’ç»æ¶ˆæ¯
                webrtcStompClient.send('/app/webrtc/reject', {}, JSON.stringify({
                    roomId: roomId,
                    calleeId: window.currentUser.id.toString()
                }));
                console.log('âŒ å·²å‘é€æ‹’ç»é€šè¯æ¶ˆæ¯');
            }
        }

        // è®¾ç½®WebRTCäº‹ä»¶å›è°ƒ
        function setupWebRTCCallbacks() {
            if (!webrtcClient) return;

            // é€šè¯è¢«æ¥å—
            webrtcClient.onCallAccepted = function(data) {
                console.log('é€šè¯è¢«æ¥å—:', data);
                updateCallStatus('é€šè¯å·²æ¥é€š');

                // æ˜¾ç¤ºé€šè¯ç•Œé¢
                const callType = webrtcClient.currentCallType || 'video';
                showCallInterface(callType, data, 'connected');
            };

            // é€šè¯è¢«æ‹’ç»
            webrtcClient.onCallRejected = function(data) {
                console.log('é€šè¯è¢«æ‹’ç»:', data);
                updateCallStatus('é€šè¯è¢«æ‹’ç»');
                resetCallButtons();
            };

            // é€šè¯ç»“æŸ
            webrtcClient.onCallEnded = function(data) {
                console.log('é€šè¯ç»“æŸ:', data);
                updateCallStatus('é€šè¯å·²ç»“æŸ');
                resetCallButtons();
            };

            // è¿œç¨‹åª’ä½“æµ
            webrtcClient.onRemoteStream = function(stream) {
                console.log('æ”¶åˆ°è¿œç¨‹åª’ä½“æµ');

                // æ˜¾ç¤ºè¿œç¨‹è§†é¢‘
                const remoteVideo = document.getElementById('remoteVideo');
                if (remoteVideo && stream) {
                    remoteVideo.srcObject = stream;
                    console.log('è¿œç¨‹è§†é¢‘æµå·²è®¾ç½®');
                }
            };
        }

        // å‘èµ·è§†é¢‘é€šè¯ï¼ˆå¢å¼ºç‰ˆï¼‰
        async function startVideoCall() {
            console.log('ğŸš€ å¼€å§‹å‘èµ·è§†é¢‘é€šè¯');

            // ä¼˜å…ˆä½¿ç”¨WebRTCç®¡ç†å™¨
            if (window.chatWebRTCManager && window.chatWebRTCManager.isInitialized) {
                try {
                    const targetUserId = getTargetUserId();
                    if (!targetUserId) {
                        alert('æ— æ³•è·å–èŠå¤©å¯¹è±¡IDï¼Œè¯·ç¡®ä¿å·²é€‰æ‹©èŠå¤©å¯¹è±¡');
                        return;
                    }

                    console.log('ä½¿ç”¨WebRTCç®¡ç†å™¨å‘èµ·è§†é¢‘é€šè¯');
                    await window.chatWebRTCManager.initiateCall(targetUserId, 'video');
                    return;
                } catch (error) {
                    console.error('WebRTCç®¡ç†å™¨å‘èµ·é€šè¯å¤±è´¥:', error);
                    // ç»§ç»­ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
                }
            }

            // å¤‡ç”¨æ–¹æ¡ˆï¼šç›´æ¥ä½¿ç”¨WebSocket
            console.log('ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆå‘èµ·è§†é¢‘é€šè¯');

            // 1. æ£€æŸ¥WebSocketè¿æ¥
            if (!webrtcStompClient || !webrtcStompClient.connected) {
                console.error('âŒ WebSocketæœªè¿æ¥');
                alert('WebSocketæœªè¿æ¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return;
            }

            // 2. æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯
            if (!window.currentUser || !window.currentUser.id) {
                console.error('âŒ å½“å‰ç”¨æˆ·ä¿¡æ¯ç¼ºå¤±');
                alert('ç”¨æˆ·ä¿¡æ¯ç¼ºå¤±ï¼Œè¯·é‡æ–°ç™»å½•');
                return;
            }

            // 3. è·å–ç›®æ ‡ç”¨æˆ·ID
            const targetUserId = getTargetUserId();
            if (!targetUserId) {
                console.error('âŒ æ— æ³•è·å–èŠå¤©å¯¹è±¡ID');
                alert('æ— æ³•è·å–èŠå¤©å¯¹è±¡IDï¼Œè¯·ç¡®ä¿å·²é€‰æ‹©èŠå¤©å¯¹è±¡');
                return;
            }

            try {
                console.log('ğŸ¥ å‘èµ·è§†é¢‘é€šè¯è¯¦æƒ…:');
                console.log('  - å‘èµ·è€…ID:', window.currentUser.id);
                console.log('  - æ¥æ”¶è€…ID:', targetUserId);
                console.log('  - é€šè¯ç±»å‹: video');

                // æ„å»ºé€šè¯é‚€è¯·æ•°æ®
                const callData = {
                    callerId: window.currentUser.id.toString(),
                    calleeId: targetUserId.toString(),
                    callType: 'video'
                };

                console.log('ğŸ“¤ å‘é€é€šè¯é‚€è¯·æ•°æ®:', callData);

                // å‘é€é€šè¯é‚€è¯·
                webrtcStompClient.send('/app/webrtc/call', {}, JSON.stringify(callData));

                console.log('âœ… è§†é¢‘é€šè¯é‚€è¯·å·²å‘é€');
                updateCallStatus('è§†é¢‘é€šè¯é‚€è¯·å·²å‘é€ï¼Œç­‰å¾…å¯¹æ–¹å“åº”...');

                // æ˜¾ç¤ºå‘èµ·é€šè¯çš„çŠ¶æ€
                showCallStatus('æ­£åœ¨å‘¼å«...', 'video');

            } catch (error) {
                console.error('âŒ å‘èµ·è§†é¢‘é€šè¯å¤±è´¥:', error);
                alert('å‘èµ·è§†é¢‘é€šè¯å¤±è´¥: ' + error.message);
            }
        }

        // å‘èµ·è¯­éŸ³é€šè¯ï¼ˆå¢å¼ºç‰ˆï¼‰
        async function startAudioCall() {
            console.log('ğŸš€ å¼€å§‹å‘èµ·è¯­éŸ³é€šè¯');

            // ä¼˜å…ˆä½¿ç”¨WebRTCç®¡ç†å™¨
            if (window.chatWebRTCManager && window.chatWebRTCManager.isInitialized) {
                try {
                    const targetUserId = getTargetUserId();
                    if (!targetUserId) {
                        alert('æ— æ³•è·å–èŠå¤©å¯¹è±¡IDï¼Œè¯·ç¡®ä¿å·²é€‰æ‹©èŠå¤©å¯¹è±¡');
                        return;
                    }

                    console.log('ä½¿ç”¨WebRTCç®¡ç†å™¨å‘èµ·è¯­éŸ³é€šè¯');
                    await window.chatWebRTCManager.initiateCall(targetUserId, 'audio');
                    return;
                } catch (error) {
                    console.error('WebRTCç®¡ç†å™¨å‘èµ·é€šè¯å¤±è´¥:', error);
                    // ç»§ç»­ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
                }
            }

            // å¤‡ç”¨æ–¹æ¡ˆï¼šç›´æ¥ä½¿ç”¨WebSocket
            console.log('ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆå‘èµ·è¯­éŸ³é€šè¯');

            // 1. æ£€æŸ¥WebSocketè¿æ¥
            if (!webrtcStompClient || !webrtcStompClient.connected) {
                console.error('âŒ WebSocketæœªè¿æ¥');
                alert('WebSocketæœªè¿æ¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return;
            }

            // 2. æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯
            if (!window.currentUser || !window.currentUser.id) {
                console.error('âŒ å½“å‰ç”¨æˆ·ä¿¡æ¯ç¼ºå¤±');
                alert('ç”¨æˆ·ä¿¡æ¯ç¼ºå¤±ï¼Œè¯·é‡æ–°ç™»å½•');
                return;
            }

            // 3. è·å–ç›®æ ‡ç”¨æˆ·ID
            const targetUserId = getTargetUserId();
            if (!targetUserId) {
                console.error('âŒ æ— æ³•è·å–èŠå¤©å¯¹è±¡ID');
                alert('æ— æ³•è·å–èŠå¤©å¯¹è±¡IDï¼Œè¯·ç¡®ä¿å·²é€‰æ‹©èŠå¤©å¯¹è±¡');
                return;
            }

            try {
                console.log('ğŸ“ å‘èµ·è¯­éŸ³é€šè¯è¯¦æƒ…:');
                console.log('  - å‘èµ·è€…ID:', window.currentUser.id);
                console.log('  - æ¥æ”¶è€…ID:', targetUserId);
                console.log('  - é€šè¯ç±»å‹: audio');

                // æ„å»ºé€šè¯é‚€è¯·æ•°æ®
                const callData = {
                    callerId: window.currentUser.id.toString(),
                    calleeId: targetUserId.toString(),
                    callType: 'audio'
                };

                console.log('ğŸ“¤ å‘é€é€šè¯é‚€è¯·æ•°æ®:', callData);

                // å‘é€é€šè¯é‚€è¯·
                webrtcStompClient.send('/app/webrtc/call', {}, JSON.stringify(callData));

                console.log('âœ… è¯­éŸ³é€šè¯é‚€è¯·å·²å‘é€');
                updateCallStatus('è¯­éŸ³é€šè¯é‚€è¯·å·²å‘é€ï¼Œç­‰å¾…å¯¹æ–¹å“åº”...');

                // æ˜¾ç¤ºå‘èµ·é€šè¯çš„çŠ¶æ€
                showCallStatus('æ­£åœ¨å‘¼å«...', 'audio');

            } catch (error) {
                console.error('âŒ å‘èµ·è¯­éŸ³é€šè¯å¤±è´¥:', error);
                alert('å‘èµ·è¯­éŸ³é€šè¯å¤±è´¥: ' + error.message);
            }
        }

        // è·å–èŠå¤©å¯¹è±¡çš„ç”¨æˆ·ID
        function getTargetUserId() {
            console.log('å¼€å§‹è·å–ç›®æ ‡ç”¨æˆ·ID...');
            console.log('ChatApp:', ChatApp);
            console.log('ChatApp.targetUser:', ChatApp?.targetUser);
            console.log('window.currentConversationId:', window.currentConversationId);
            console.log('ChatApp.currentConversationId:', ChatApp?.currentConversationId);

            // æ–¹æ³•1: ä»ChatApp.targetUserè·å–
            if (ChatApp && ChatApp.targetUser && ChatApp.targetUser.id) {
                console.log('ä»ChatApp.targetUserè·å–åˆ°ID:', ChatApp.targetUser.id);
                return ChatApp.targetUser.id;
            }

            // æ–¹æ³•2: ä»å½“å‰ä¼šè¯çš„å‚ä¸è€…ä¸­è·å–
            if (ChatApp && ChatApp.currentConversation && ChatApp.currentConversation.participants) {
                const otherParticipant = ChatApp.currentConversation.participants.find(
                    p => p.user.id !== window.currentUser.id
                );
                if (otherParticipant) {
                    console.log('ä»currentConversation.participantsè·å–åˆ°ID:', otherParticipant.user.id);
                    return otherParticipant.user.id;
                }
            }

            // æ–¹æ³•3: ä»conversationsåˆ—è¡¨ä¸­è·å–
            const conversationId = window.currentConversationId || ChatApp?.currentConversationId;
            if (ChatApp && ChatApp.conversations && conversationId) {
                const conversation = ChatApp.conversations.find(c => c.id === conversationId);
                console.log('æ‰¾åˆ°çš„ä¼šè¯:', conversation);
                if (conversation && conversation.participants) {
                    const otherParticipant = conversation.participants.find(
                        p => p.user.id !== window.currentUser.id
                    );
                    if (otherParticipant) {
                        console.log('ä»conversationsåˆ—è¡¨è·å–åˆ°ID:', otherParticipant.user.id);
                        // åŒæ—¶è®¾ç½®targetUserä»¥ä¾¿ä¸‹æ¬¡ä½¿ç”¨
                        if (ChatApp) {
                            ChatApp.targetUser = otherParticipant.user;
                        }
                        return otherParticipant.user.id;
                    }
                }
            }

            console.error('æ— æ³•è·å–èŠå¤©å¯¹è±¡ID');
            console.error('è°ƒè¯•ä¿¡æ¯:', {
                ChatApp: !!ChatApp,
                targetUser: ChatApp?.targetUser,
                currentConversation: ChatApp?.currentConversation,
                conversations: ChatApp?.conversations?.length,
                conversationId: conversationId,
                currentUser: window.currentUser
            });
            return null;
        }

        // æ›´æ–°é€šè¯çŠ¶æ€æ˜¾ç¤º
        function updateCallStatus(message) {
            // å¯ä»¥åœ¨èŠå¤©å¤´éƒ¨æ˜¾ç¤ºé€šè¯çŠ¶æ€
            const statusElement = document.getElementById('chatStatus');
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.className = 'text-info';
            }
        }

        // ç¦ç”¨é€šè¯æŒ‰é’®
        function disableCallButtons() {
            const videoBtn = document.getElementById('videoCallBtn');
            const audioBtn = document.getElementById('audioCallBtn');

            if (videoBtn) {
                videoBtn.disabled = true;
                videoBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            }

            if (audioBtn) {
                audioBtn.disabled = true;
                audioBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            }
        }

        // é‡ç½®é€šè¯æŒ‰é’®
        function resetCallButtons() {
            const videoBtn = document.getElementById('videoCallBtn');
            const audioBtn = document.getElementById('audioCallBtn');

            if (videoBtn) {
                videoBtn.disabled = false;
                videoBtn.innerHTML = '<i class="fas fa-video"></i>';
            }

            if (audioBtn) {
                audioBtn.disabled = false;
                audioBtn.innerHTML = '<i class="fas fa-phone"></i>';
            }

            // é‡ç½®çŠ¶æ€æ˜¾ç¤º
            const statusElement = document.getElementById('chatStatus');
            if (statusElement) {
                statusElement.textContent = 'åœ¨çº¿';
                statusElement.className = 'text-muted';
            }
        }

        // è°ƒè¯•WebRTCçŠ¶æ€
        function debugWebRTC() {
            const targetUserId = getTargetUserId();
            const debugInfo = {
                'WebRTCç®¡ç†å™¨': !!webrtcManager,
                'WebRTCç®¡ç†å™¨åˆå§‹åŒ–': webrtcManager?.isInitialized,
                'WebRTCå®¢æˆ·ç«¯': !!webrtcClient,
                'WebRTCä¸“ç”¨WebSocket': webrtcStompClient?.connected,
                'èŠå¤©WebSocket': stompClient?.connected,
                'å…¨å±€WebSocket': window.stompClient?.connected,
                'å½“å‰ç”¨æˆ·': window.currentUser,
                'å½“å‰ä¼šè¯ID': window.currentConversationId,
                'ChatAppå­˜åœ¨': !!ChatApp,
                'ChatAppç›®æ ‡ç”¨æˆ·': ChatApp?.targetUser,
                'ChatAppå½“å‰ä¼šè¯': ChatApp?.currentConversation,
                'ChatAppä¼šè¯åˆ—è¡¨é•¿åº¦': ChatApp?.conversations?.length,
                'è·å–åˆ°çš„ç›®æ ‡ç”¨æˆ·ID': targetUserId,
                'GlobalCallPopup': !!window.globalCallPopup,
                'WebRTCClientç±»': typeof WebRTCClient,
                'ChatWebRTCManagerç±»': typeof ChatWebRTCManager,
                'SockJS': typeof SockJS,
                'Stomp': typeof Stomp
            };

            console.log('=== WebRTCè°ƒè¯•ä¿¡æ¯ ===');
            console.table(debugInfo);

            if (webrtcManager) {
                console.log('WebRTCç®¡ç†å™¨è¯¦ç»†çŠ¶æ€:', webrtcManager.getStatus());

                // æµ‹è¯•æ¶ˆæ¯å‘é€
                if (webrtcManager.stompClient && window.currentUser) {
                    console.log('æµ‹è¯•å‘é€ä¿æ´»æ¶ˆæ¯...');
                    webrtcManager.stompClient.send('/app/webrtc/keepalive', {}, JSON.stringify({
                        userId: window.currentUser.id.toString()
                    }));
                }
            }

            // é¢å¤–çš„è¯¦ç»†ä¿¡æ¯
            console.log('=== è¯¦ç»†ä¿¡æ¯ ===');
            console.log('window.currentUser:', window.currentUser);
            console.log('ChatApp.targetUser:', ChatApp?.targetUser);
            console.log('ChatApp.conversations:', ChatApp?.conversations);
            console.log('webrtcClient:', webrtcClient);

            // æµ‹è¯•WebSocketè¿æ¥
            testWebSocketConnection();

            alert('è°ƒè¯•ä¿¡æ¯å·²è¾“å‡ºåˆ°æ§åˆ¶å°ï¼Œè¯·æŒ‰F12æŸ¥çœ‹');
        }

        // æµ‹è¯•WebSocketè¿æ¥
        function testWebSocketConnection() {
            console.log('=== æµ‹è¯•WebSocketè¿æ¥ ===');

            if (webrtcStompClient && webrtcStompClient.connected) {
                console.log('å‘é€æµ‹è¯•æ¶ˆæ¯åˆ°WebRTCä¿¡ä»¤æœåŠ¡å™¨...');

                try {
                    // å‘é€åŠ å…¥ä¿¡ä»¤çš„æ¶ˆæ¯
                    webrtcStompClient.send('/app/webrtc/join', {}, JSON.stringify({
                        userId: window.currentUser.id
                    }));
                    console.log('æµ‹è¯•æ¶ˆæ¯å‘é€æˆåŠŸ');
                } catch (error) {
                    console.error('å‘é€æµ‹è¯•æ¶ˆæ¯å¤±è´¥:', error);
                }
            } else {
                console.error('WebSocketæœªè¿æ¥ï¼Œæ— æ³•å‘é€æµ‹è¯•æ¶ˆæ¯');
            }
        }

        // é€šè¯ç•Œé¢ç›¸å…³å‡½æ•°
        let callTimer = null;
        let callStartTime = null;
        let isMuted = false;
        let isVideoOff = false;

        // æ˜¾ç¤ºé€šè¯ç•Œé¢
        function showCallInterface(callType, callData, status = 'connecting') {
            console.log('æ˜¾ç¤ºé€šè¯ç•Œé¢:', callType, callData, status);

            const callInterface = document.getElementById('callInterface');
            const callTitle = document.getElementById('callTitle');
            const callStatus = document.getElementById('callStatus');

            if (callInterface && callTitle && callStatus) {
                callTitle.textContent = callType === 'video' ? 'è§†é¢‘é€šè¯' : 'è¯­éŸ³é€šè¯';
                callStatus.textContent = status === 'connecting' ? 'è¿æ¥ä¸­...' :
                                       status === 'connected' ? 'å·²è¿æ¥' : 'é€šè¯ä¸­';

                callInterface.style.display = 'block';

                // å¦‚æœæ˜¯è¯­éŸ³é€šè¯ï¼Œéšè—è§†é¢‘å…ƒç´ 
                const remoteVideo = document.getElementById('remoteVideo');
                const localVideo = document.getElementById('localVideo');
                if (callType === 'audio') {
                    if (remoteVideo) remoteVideo.style.display = 'none';
                    if (localVideo) localVideo.style.display = 'none';
                } else {
                    if (remoteVideo) remoteVideo.style.display = 'block';
                    if (localVideo) localVideo.style.display = 'block';
                }

                // å¼€å§‹è®¡æ—¶
                if (status === 'connected') {
                    startCallTimer();
                }
            }
        }

        // éšè—é€šè¯ç•Œé¢
        function hideCallInterface() {
            console.log('éšè—é€šè¯ç•Œé¢');

            const callInterface = document.getElementById('callInterface');
            if (callInterface) {
                callInterface.style.display = 'none';
            }

            // åœæ­¢è®¡æ—¶
            stopCallTimer();

            // é‡ç½®çŠ¶æ€
            isMuted = false;
            isVideoOff = false;
            updateCallButtons();
        }

        // å¼€å§‹é€šè¯è®¡æ—¶
        function startCallTimer() {
            callStartTime = Date.now();
            callTimer = setInterval(updateCallTimer, 1000);
        }

        // åœæ­¢é€šè¯è®¡æ—¶
        function stopCallTimer() {
            if (callTimer) {
                clearInterval(callTimer);
                callTimer = null;
            }
            callStartTime = null;
        }

        // æ›´æ–°é€šè¯è®¡æ—¶æ˜¾ç¤º
        function updateCallTimer() {
            if (!callStartTime) return;

            const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;

            const timerElement = document.getElementById('callTimer');
            if (timerElement) {
                timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        // åˆ‡æ¢é™éŸ³
        function toggleMute() {
            isMuted = !isMuted;
            console.log('åˆ‡æ¢é™éŸ³:', isMuted);

            if (webrtcClient && webrtcClient.localStream) {
                const audioTracks = webrtcClient.localStream.getAudioTracks();
                audioTracks.forEach(track => {
                    track.enabled = !isMuted;
                });
            }

            updateCallButtons();
        }

        // åˆ‡æ¢è§†é¢‘
        function toggleVideo() {
            isVideoOff = !isVideoOff;
            console.log('åˆ‡æ¢è§†é¢‘:', isVideoOff);

            if (webrtcClient && webrtcClient.localStream) {
                const videoTracks = webrtcClient.localStream.getVideoTracks();
                videoTracks.forEach(track => {
                    track.enabled = !isVideoOff;
                });
            }

            updateCallButtons();
        }

        // ç»“æŸé€šè¯
        function endCall() {
            console.log('ç»“æŸé€šè¯');

            if (webrtcClient) {
                webrtcClient.endCall();
            }

            hideCallInterface();
        }

        // æ˜¾ç¤ºé€šè¯çŠ¶æ€
        function showCallStatus(message, callType) {
            console.log(`${callType}é€šè¯çŠ¶æ€:`, message);

            // åˆ›å»ºçŠ¶æ€æç¤º
            const statusDiv = document.createElement('div');
            statusDiv.className = 'call-status-popup position-fixed top-0 start-50 translate-middle-x mt-3';
            statusDiv.style.zIndex = '9999';
            statusDiv.innerHTML = `
                <div class="alert alert-primary alert-dismissible">
                    <i class="fas fa-${callType === 'video' ? 'video' : 'phone'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;

            document.body.appendChild(statusDiv);

            // 5ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                if (statusDiv && statusDiv.parentNode) {
                    statusDiv.parentNode.removeChild(statusDiv);
                }
            }, 5000);
        }

        // æ›´æ–°é€šè¯æŒ‰é’®çŠ¶æ€
        function updateCallButtons() {
            const muteBtn = document.getElementById('muteBtn');
            const videoBtn = document.getElementById('videoBtn');

            if (muteBtn) {
                const icon = muteBtn.querySelector('i');
                if (isMuted) {
                    muteBtn.classList.add('muted');
                    icon.className = 'fas fa-microphone-slash';
                } else {
                    muteBtn.classList.remove('muted');
                    icon.className = 'fas fa-microphone';
                }
            }

            if (videoBtn) {
                const icon = videoBtn.querySelector('i');
                if (isVideoOff) {
                    videoBtn.classList.add('muted');
                    icon.className = 'fas fa-video-slash';
                } else {
                    videoBtn.classList.remove('muted');
                    icon.className = 'fas fa-video';
                }
            }
        }

        // åˆå§‹åŒ–WebRTCç®¡ç†å™¨
        async function initWebRTCManager() {
            try {
                console.log('å¼€å§‹åˆå§‹åŒ–WebRTCç®¡ç†å™¨...');

                // æ£€æŸ¥å¿…è¦çš„ç±»æ˜¯å¦å­˜åœ¨
                if (typeof ChatWebRTCManager === 'undefined') {
                    console.error('ChatWebRTCManagerç±»æœªå®šä¹‰ï¼Œè¯·æ£€æŸ¥chat-webrtc-manager.jsæ˜¯å¦æ­£ç¡®åŠ è½½');
                    return;
                }

                // åˆ›å»ºWebRTCç®¡ç†å™¨å®ä¾‹
                if (!window.chatWebRTCManager) {
                    window.chatWebRTCManager = new ChatWebRTCManager();
                    console.log('WebRTCç®¡ç†å™¨å®ä¾‹å·²åˆ›å»º');
                }

                // åˆå§‹åŒ–ç®¡ç†å™¨
                await window.chatWebRTCManager.initialize();
                console.log('âœ… WebRTCç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸ');

            } catch (error) {
                console.error('âŒ WebRTCç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥:', error);
            }
        }
    </script>
</body>
</html>
