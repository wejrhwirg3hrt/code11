<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ËÅäÂ§©‰ºöËØù - ËßÜÈ¢ëÂàÜ‰∫´Âπ≥Âè∞</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/css/chat.css" rel="stylesheet">
</head>
<body>
    <!-- ÂØºËà™Ê†è -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-video me-2"></i>ËßÜÈ¢ëÂàÜ‰∫´Âπ≥Âè∞
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">
                    <i class="fas fa-home me-1"></i>È¶ñÈ°µ
                </a>
                <a class="nav-link active" href="/chat">
                    <i class="fas fa-comments me-1"></i>ËÅäÂ§©
                    <span class="badge bg-danger ms-1" id="totalUnreadCount" style="display: none;">0</span>
                </a>
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <img th:src="${currentUser.avatar}" alt="Â§¥ÂÉè" class="rounded-circle me-1" width="24" height="24">
                        <span th:text="${currentUser.username}">Áî®Êà∑Âêç</span>
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="/profile">‰∏™‰∫∫ËµÑÊñô</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="/logout">ÈÄÄÂá∫ÁôªÂΩï</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <!-- ËÅäÂ§©ÁïåÈù¢ -->
    <div class="container-fluid chat-container">
        <div class="row h-100">
            <!-- ‰ºöËØùÂàóË°® -->
            <div class="col-md-4 col-lg-3 chat-sidebar">
                <div class="chat-header">
                    <h5 class="mb-0">
                        <i class="fas fa-comments me-2"></i>ËÅäÂ§©
                    </h5>
                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#newChatModal">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                
                <!-- ÊêúÁ¥¢Ê°Ü -->
                <div class="search-box">
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" class="form-control" placeholder="ÊêúÁ¥¢‰ºöËØù..." id="searchInput">
                    </div>
                </div>

                <!-- ‰ºöËØùÂàóË°® -->
                <div class="conversation-list" id="conversationList">
                    <!-- ‰ºöËØùÈ°πÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÂä†ËΩΩ -->
                </div>
            </div>

            <!-- ËÅäÂ§©Âå∫Âüü -->
            <div class="col-md-8 col-lg-9 chat-main">
                <!-- ËÅäÂ§©Â§¥ÈÉ® -->
                <div class="chat-header">
                    <div class="d-flex align-items-center">
                        <img src="/images/default-avatar.png" alt="Â§¥ÂÉè" class="rounded-circle me-3" width="40" height="40" id="chatAvatar">
                        <div>
                            <h6 class="mb-0" id="chatTitle">ËÅäÂ§©ÂØπË±°</h6>
                            <small class="text-muted" id="chatStatus">Âú®Á∫ø</small>
                        </div>
                    </div>
                    <div class="chat-actions">
                        <button class="btn btn-sm btn-outline-secondary me-2" title="ËßÜÈ¢ëÈÄöËØù" onclick="alert('ËßÜÈ¢ëÈÄöËØùÊåâÈíÆË¢´ÁÇπÂáªÔºÅ')" id="videoCallBtn">
                            <i class="fas fa-video"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary me-2" title="ËØ≠Èü≥ÈÄöËØù" onclick="alert('ËØ≠Èü≥ÈÄöËØùÊåâÈíÆË¢´ÁÇπÂáªÔºÅ')" id="audioCallBtn">
                            <i class="fas fa-phone"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info me-2" title="Ë∞ÉËØï‰ø°ÊÅØ" onclick="simpleTest()">
                            <i class="fas fa-bug"></i>
                        </button>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="pinConversation()"><i class="fas fa-thumbtack me-2"></i>ÁΩÆÈ°∂‰ºöËØù</a></li>
                                <li><a class="dropdown-item" href="#" onclick="muteConversation()"><i class="fas fa-volume-mute me-2"></i>ÈùôÈü≥ÈÄöÁü•</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-warning" href="#" onclick="clearChatMessages()"><i class="fas fa-broom me-2"></i>Ê∏ÖÁ©∫ËÅäÂ§©ËÆ∞ÂΩï</a></li>
                                <li><a class="dropdown-item text-info" href="#" onclick="unfollowUser()"><i class="fas fa-user-minus me-2"></i>ÂèñÊ∂àÂÖ≥Ê≥®</a></li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="deleteConversation()"><i class="fas fa-trash me-2"></i>Âà†Èô§‰ºöËØù</a></li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Ê∂àÊÅØÂå∫Âüü -->
                <div class="messages-container" id="messagesContainer">
                    <div class="messages-list" id="messagesList">
                        <!-- Ê∂àÊÅØÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÂä†ËΩΩ -->
                    </div>
                </div>

                <!-- Êñá‰ª∂È¢ÑËßàÂå∫Âüü -->
                <div class="file-preview-area" id="filePreviewArea" style="display: none;">
                    <div class="file-preview-content">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted">ÂáÜÂ§áÂèëÈÄÅÁöÑÊñá‰ª∂Ôºö</span>
                            <button class="btn btn-sm btn-outline-danger" onclick="clearFilePreview()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div id="filePreviewList">
                            <!-- Êñá‰ª∂È¢ÑËßàÈ°πÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
                        </div>
                    </div>
                </div>

                <!-- ËæìÂÖ•Âå∫Âüü -->
                <div class="message-input-area">
                    <div class="input-toolbar">
                        <button class="btn btn-sm btn-outline-secondary" title="Ë°®ÊÉÖ" onclick="toggleEmojiPicker()">
                            <i class="fas fa-smile"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" title="ÂõæÁâá" onclick="selectFile('image')">
                            <i class="fas fa-image"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" title="Êñá‰ª∂" onclick="selectFile('file')">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" title="ËßÜÈ¢ëÊñá‰ª∂" onclick="selectFile('video')">
                            <i class="fas fa-film"></i>
                        </button>
                        <!-- WebRTCÈÄöËØùÊåâÈíÆ -->
                        <button class="btn btn-sm btn-outline-success" title="ËØ≠Èü≥ÈÄöËØù" onclick="startAudioCall()">
                            <i class="fas fa-phone"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-primary" title="ËßÜÈ¢ëÈÄöËØù" onclick="startVideoCall()">
                            <i class="fas fa-video"></i>
                        </button>
                        <!-- Ë∞ÉËØïÊåâÈíÆ -->
                        <button class="btn btn-sm btn-outline-warning" title="Ë∞ÉËØï‰ø°ÊÅØ" onclick="debugWebRTC()">
                            <i class="fas fa-bug"></i>
                        </button>
                    </div>
                    
                    <div class="input-group">
                        <textarea class="form-control" id="messageInput" placeholder="ËæìÂÖ•Ê∂àÊÅØ..." rows="1" 
                                  onkeydown="handleMessageInput(event)" oninput="autoResize(this)"></textarea>
                        <button class="btn btn-primary" id="sendButton" onclick="sendMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ë°®ÊÉÖÈÄâÊã©Âô® -->
    <div class="emoji-picker" id="emojiPicker" style="display: none;">
        <div class="emoji-categories">
            <button class="emoji-category active" data-category="faces">üòä</button>
            <button class="emoji-category" data-category="gestures">üëç</button>
            <button class="emoji-category" data-category="hearts">‚ù§Ô∏è</button>
            <button class="emoji-category" data-category="animals">üê±</button>
        </div>
        <div class="emoji-grid" id="emojiGrid">
            <!-- Ë°®ÊÉÖÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÂä†ËΩΩ -->
        </div>
    </div>

    <!-- Êñá‰ª∂ËæìÂÖ• -->
    <input type="file" id="fileInput" style="display: none;" multiple accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.txt,.zip,.rar">

    <!-- Êñá‰ª∂È¢ÑËßàÊèêÁ§∫ -->
    <div class="file-upload-tips" style="display: none;">
        <small class="text-muted">
            <i class="fas fa-info-circle me-1"></i>
            ÊúÄÂ§öÂèØÈÄâÊã©9‰∏™Êñá‰ª∂ÔºåÂçï‰∏™Êñá‰ª∂‰∏çË∂ÖËøá50MB
        </small>
    </div>

    <!-- ÈÄöËØùÁïåÈù¢ -->
    <div id="callInterface" class="call-interface" style="display: none;">
        <div class="call-overlay">
            <div class="call-container">
                <div class="call-header">
                    <h5 id="callTitle">ËßÜÈ¢ëÈÄöËØù</h5>
                    <span id="callStatus">ËøûÊé•‰∏≠...</span>
                    <span id="callTimer">00:00</span>
                </div>

                <div class="video-container">
                    <video id="remoteVideo" autoplay playsinline class="remote-video"></video>
                    <video id="localVideo" autoplay playsinline muted class="local-video"></video>
                </div>

                <div class="call-controls">
                    <button class="btn btn-secondary" id="muteBtn" onclick="toggleMute()" title="ÈùôÈü≥">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button class="btn btn-secondary" id="videoBtn" onclick="toggleVideo()" title="ÂÖ≥Èó≠ÊëÑÂÉèÂ§¥">
                        <i class="fas fa-video"></i>
                    </button>
                    <button class="btn btn-danger" id="hangupBtn" onclick="endCall()" title="ÊåÇÊñ≠">
                        <i class="fas fa-phone-slash"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Êñ∞Âª∫ËÅäÂ§©Ê®°ÊÄÅÊ°Ü -->
    <div class="modal fade" id="newChatModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Êñ∞Âª∫ËÅäÂ§©</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">ÊêúÁ¥¢Áî®Êà∑</label>
                        <input type="text" class="form-control" id="userSearchInput" placeholder="ËæìÂÖ•Áî®Êà∑ÂêçÊêúÁ¥¢...">
                    </div>
                    <div id="userSearchResults" class="user-search-results">
                        <!-- ÊêúÁ¥¢ÁªìÊûúÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ËÑöÊú¨ -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/lib/sockjs.min.js"></script>
    <script src="/lib/stomp.min.js"></script>
    <script src="/js/chat.js"></script>
    <script src="/js/global-call-popup.js"></script>
    <script src="/js/webrtc-client.js"></script>
    <script src="/js/chat-webrtc-manager.js"></script>
    
    <script>
        // ÁÆÄÂçïÊµãËØïÂáΩÊï∞
        function simpleTest() {
            try {
                console.log('=== ÁÆÄÂçïÊµãËØïÂºÄÂßã ===');
                alert('JavaScriptÊ≠£Â∏∏Â∑•‰ΩúÔºÅ\n\n' +
                      'ÂΩìÂâçÁî®Êà∑: ' + (window.currentUser ? window.currentUser.username : 'Êú™ÂÆö‰πâ') + '\n' +
                      '‰ºöËØùID: ' + (window.currentConversationId || 'Êú™ÂÆö‰πâ') + '\n' +
                      'ChatApp: ' + (typeof ChatApp !== 'undefined' ? 'Â∑≤Âä†ËΩΩ' : 'Êú™Âä†ËΩΩ') + '\n' +
                      'ChatAppÂ≠òÂú®: ' + (!!ChatApp ? 'ÊòØ' : 'Âê¶'));
            } catch (error) {
                alert('JavaScriptÈîôËØØ: ' + error.message);
                console.error('ÊµãËØïÈîôËØØ:', error);
            }
        }

        // ÂàùÂßãÂåñËÅäÂ§©È°µÈù¢
        document.addEventListener('DOMContentLoaded', function() {
            // Ëé∑ÂèñÂΩìÂâçÁî®Êà∑‰ø°ÊÅØÂíå‰ºöËØùID
            window.currentUser = {
                id: [[${currentUser.id}]],
                username: '[[${currentUser.username}]]',
                avatar: '[[${currentUser.avatar}]]'
            };
            
            window.currentConversationId = [[${conversationId}]];
            
            // ÂàùÂßãÂåñËÅäÂ§©ÂäüËÉΩ
            if (typeof ChatApp !== 'undefined') {
                ChatApp.init();

                // Á≠âÂæÖChatAppÂàùÂßãÂåñÂÆåÊàêÂêéÂÜçÂä†ËΩΩ‰ºöËØù
                setTimeout(async () => {
                    await ChatApp.loadConversation(window.currentConversationId);
                    console.log('‰ºöËØùÂä†ËΩΩÂÆåÊàêÔºåÁõÆÊ†áÁî®Êà∑:', ChatApp.targetUser);
                }, 1000);
            } else {
                console.error('ChatAppÊú™ÂÆö‰πâ');
            }

            // Âª∂ËøüÂàùÂßãÂåñWebRTCÂäüËÉΩÔºåÁ°Æ‰øùÈ°µÈù¢ÂÆåÂÖ®Âä†ËΩΩ
            setTimeout(() => {
                initBasicWebRTC();
                initWebRTCManager();
            }, 1000);
        });

        // Âü∫Á°ÄWebRTCÂèòÈáè
        let localStream = null;
        let isWebRTCReady = false;

        // Âü∫Á°ÄWebRTCÂàùÂßãÂåñ
        async function initBasicWebRTC() {
            if (isWebRTCReady) {
                console.log('WebRTCÂ∑≤Â∞±Áª™');
                return;
            }

            console.log('ÂºÄÂßãÂü∫Á°ÄWebRTCÂàùÂßãÂåñ...');

            try {
                // Ëé∑ÂèñÂ™í‰ΩìÊµÅ
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });

                // ÊòæÁ§∫Êú¨Âú∞ËßÜÈ¢ë
                const localVideo = document.getElementById('localVideo');
                if (localVideo) {
                    localVideo.srcObject = localStream;
                    localVideo.muted = true;
                    console.log('Êú¨Âú∞ËßÜÈ¢ëÊòæÁ§∫ÊàêÂäü');
                }

                isWebRTCReady = true;
                console.log('Âü∫Á°ÄWebRTCÂàùÂßãÂåñÂÆåÊàê');

                // ÊòæÁ§∫ÊéßÂà∂ÊåâÈíÆ
                const controls = document.getElementById('videoControls');
                if (controls) {
                    controls.style.display = 'block';
                }

            } catch (error) {
                console.error('WebRTCÂàùÂßãÂåñÂ§±Ë¥•:', error);
                alert('Êó†Ê≥ïËÆøÈóÆÊëÑÂÉèÂ§¥ÂíåÈ∫¶ÂÖãÈ£éÔºåËØ∑Ê£ÄÊü•ÊµèËßàÂô®ÊùÉÈôê');
            }
        }

        // Ê≥®ÊÑèÔºöÂÆûÈôÖÁöÑÈÄöËØùÂáΩÊï∞Âú®È°µÈù¢Â∫ïÈÉ®ÂÆö‰πâ

        function debugWebRTC() {
            console.log('=== WebRTCË∞ÉËØï‰ø°ÊÅØ ===');
            console.log('WebRTCÂ∞±Áª™Áä∂ÊÄÅ:', isWebRTCReady);
            console.log('Êú¨Âú∞ÊµÅ:', localStream);
            console.log('Êú¨Âú∞ËßÜÈ¢ëÂÖÉÁ¥†:', document.getElementById('localVideo'));
            console.log('ChatWebRTCManagerÂ≠òÂú®:', !!window.chatWebRTCManager);
            console.log('ChatWebRTCManagerÂ∑≤ÂàùÂßãÂåñ:', window.chatWebRTCManager?.isInitialized);
            console.log('WebRTCÂÆ¢Êà∑Á´ØÂ≠òÂú®:', !!window.chatWebRTCManager?.webrtcClient);
            console.log('WebSocketËøûÊé•Áä∂ÊÄÅ:', window.chatWebRTCManager?.stompClient?.connected);
            console.log('ÂΩìÂâçÁî®Êà∑:', window.chatWebRTCManager?.currentUser);
            console.log('ÁõÆÊ†áÁî®Êà∑ID:', getTargetUserId());

            // ÊòæÁ§∫Áä∂ÊÄÅÂºπÁ™ó
            const status = {
                webrtcReady: isWebRTCReady,
                managerExists: !!window.chatWebRTCManager,
                managerInitialized: window.chatWebRTCManager?.isInitialized,
                webrtcClient: !!window.chatWebRTCManager?.webrtcClient,
                websocketConnected: window.chatWebRTCManager?.stompClient?.connected,
                currentUser: window.chatWebRTCManager?.currentUser?.username,
                targetUserId: getTargetUserId()
            };

            alert('WebRTCÁä∂ÊÄÅ:\n' + JSON.stringify(status, null, 2));

            if (localStream) {
                console.log('ËßÜÈ¢ëËΩ®ÈÅì:', localStream.getVideoTracks());
                console.log('Èü≥È¢ëËΩ®ÈÅì:', localStream.getAudioTracks());
            }
        }

        // ÊµãËØïËßÜÈ¢ëÈÄöËØùÂáΩÊï∞
        function testStartVideoCall() {
            console.log('=== ÊµãËØïËßÜÈ¢ëÈÄöËØù ===');
            console.log('ÂΩìÂâçÁî®Êà∑:', window.currentUser);

            const targetUserId = getTargetUserId();
            console.log('ÁõÆÊ†áÁî®Êà∑ID:', targetUserId);
            console.log('WebRTCÁÆ°ÁêÜÂô®:', window.chatWebRTCManager);
            console.log('WebSocket:', window.chatWebSocket);
            console.log('ChatApp:', ChatApp);
            console.log('ChatApp.targetUser:', ChatApp?.targetUser);

            if (!targetUserId) {
                alert('ËØ∑ÂÖàÈÄâÊã©ËÅäÂ§©ÂØπË±°\n\nË∞ÉËØï‰ø°ÊÅØ:\n' +
                      '- ChatAppÂ≠òÂú®: ' + !!ChatApp + '\n' +
                      '- ChatApp.targetUser: ' + (ChatApp?.targetUser || 'Êó†') + '\n' +
                      '- ÂΩìÂâç‰ºöËØùID: ' + (window.currentConversationId || 'Êó†'));
                return;
            }

            if (!window.currentUser) {
                alert('Áî®Êà∑Êú™ÁôªÂΩï');
                return;
            }

            console.log('ÂºÄÂßãÂèëËµ∑ËßÜÈ¢ëÈÄöËØù...');
            startVideoCall();
        }

        // ÊµãËØïËØ≠Èü≥ÈÄöËØùÂáΩÊï∞
        function testStartAudioCall() {
            console.log('=== ÊµãËØïËØ≠Èü≥ÈÄöËØù ===');
            console.log('ÂΩìÂâçÁî®Êà∑:', window.currentUser);

            const targetUserId = getTargetUserId();
            console.log('ÁõÆÊ†áÁî®Êà∑ID:', targetUserId);
            console.log('WebRTCÁÆ°ÁêÜÂô®:', window.chatWebRTCManager);
            console.log('WebSocket:', window.chatWebSocket);
            console.log('ChatApp:', ChatApp);
            console.log('ChatApp.targetUser:', ChatApp?.targetUser);

            if (!targetUserId) {
                alert('ËØ∑ÂÖàÈÄâÊã©ËÅäÂ§©ÂØπË±°\n\nË∞ÉËØï‰ø°ÊÅØ:\n' +
                      '- ChatAppÂ≠òÂú®: ' + !!ChatApp + '\n' +
                      '- ChatApp.targetUser: ' + (ChatApp?.targetUser || 'Êó†') + '\n' +
                      '- ÂΩìÂâç‰ºöËØùID: ' + (window.currentConversationId || 'Êó†'));
                return;
            }

            if (!window.currentUser) {
                alert('Áî®Êà∑Êú™ÁôªÂΩï');
                return;
            }

            console.log('ÂºÄÂßãÂèëËµ∑ËØ≠Èü≥ÈÄöËØù...');
            startAudioCall();
        }

        // ÊòæÁ§∫ËØ¶ÁªÜË∞ÉËØï‰ø°ÊÅØ
        function showDetailedDebugInfo() {
            console.log('=== ËØ¶ÁªÜË∞ÉËØï‰ø°ÊÅØ ===');

            const debugInfo = {
                'È°µÈù¢Âü∫Êú¨‰ø°ÊÅØ': {
                    'ÂΩìÂâçÁî®Êà∑': window.currentUser,
                    'ÂΩìÂâç‰ºöËØùID': window.currentConversationId,
                    'URLÂèÇÊï∞': window.location.search
                },
                'ChatAppÁä∂ÊÄÅ': {
                    'ChatAppÂ≠òÂú®': !!ChatApp,
                    'ChatAppÂàùÂßãÂåñ': ChatApp ? 'yes' : 'no',
                    'ChatApp.currentUser': ChatApp?.currentUser,
                    'ChatApp.currentConversationId': ChatApp?.currentConversationId,
                    'ChatApp.targetUser': ChatApp?.targetUser,
                    'ChatApp.conversationsÈïøÂ∫¶': ChatApp?.conversations?.length,
                    'ChatApp.connected': ChatApp?.connected
                },
                'WebRTCÁä∂ÊÄÅ': {
                    'WebRTCÁÆ°ÁêÜÂô®Â≠òÂú®': !!window.chatWebRTCManager,
                    'WebRTCÁÆ°ÁêÜÂô®ÂàùÂßãÂåñ': window.chatWebRTCManager?.isInitialized,
                    'WebRTCÂÆ¢Êà∑Á´Ø': !!window.chatWebRTCManager?.webrtcClient,
                    'WebSocketËøûÊé•': window.chatWebRTCManager?.stompClient?.connected
                },
                'ÁõÆÊ†áÁî®Êà∑Ëé∑Âèñ': {
                    'getTargetUserId()ÁªìÊûú': getTargetUserId(),
                    'Ëé∑ÂèñÊñπÊ≥ïÊµãËØï': testGetTargetUserId()
                }
            };

            console.log('Ë∞ÉËØï‰ø°ÊÅØ:', debugInfo);

            // ÊòæÁ§∫Ê†ºÂºèÂåñÁöÑË∞ÉËØï‰ø°ÊÅØ
            let debugText = '=== ËÅäÂ§©Á≥ªÁªüË∞ÉËØï‰ø°ÊÅØ ===\n\n';

            for (const [category, data] of Object.entries(debugInfo)) {
                debugText += `„Äê${category}„Äë\n`;
                for (const [key, value] of Object.entries(data)) {
                    debugText += `  ${key}: ${JSON.stringify(value)}\n`;
                }
                debugText += '\n';
            }

            alert(debugText);
        }

        // ÊµãËØïËé∑ÂèñÁõÆÊ†áÁî®Êà∑IDÁöÑÂêÑÁßçÊñπÊ≥ï
        function testGetTargetUserId() {
            const results = {};

            // ÊñπÊ≥ï1: ChatApp.targetUser
            if (ChatApp && ChatApp.targetUser && ChatApp.targetUser.id) {
                results.method1_ChatApp_targetUser = ChatApp.targetUser.id;
            }

            // ÊñπÊ≥ï2: ChatApp.currentConversation
            if (ChatApp && ChatApp.currentConversation && ChatApp.currentConversation.participants) {
                const otherParticipant = ChatApp.currentConversation.participants.find(
                    p => p.user.id !== window.currentUser.id
                );
                if (otherParticipant) {
                    results.method2_currentConversation = otherParticipant.user.id;
                }
            }

            // ÊñπÊ≥ï3: conversationsÂàóË°®
            const conversationId = window.currentConversationId || ChatApp?.currentConversationId;
            if (ChatApp && ChatApp.conversations && conversationId) {
                const conversation = ChatApp.conversations.find(c => c.id === conversationId);
                if (conversation && conversation.participants) {
                    const otherParticipant = conversation.participants.find(
                        p => p.user.id !== window.currentUser.id
                    );
                    if (otherParticipant) {
                        results.method3_conversations_list = otherParticipant.user.id;
                    }
                }
            }

            return results;
        }

        // WebRTCÁõ∏ÂÖ≥ÂäüËÉΩ
        let webrtcClient = null;
        let webrtcStompClient = null;
        let webrtcManager = null;

        // ÂàùÂßãÂåñWebRTCÂäüËÉΩÔºàÂ¢ûÂº∫ÁâàÊú¨Ôºâ
        async function initWebRTCForChat() {
            try {
                console.log('=== ÂºÄÂßãÂàùÂßãÂåñËÅäÂ§©È°µÈù¢WebRTCÂäüËÉΩ ===');

                // 1. Âº∫Âà∂ÂàùÂßãÂåñÂÖ®Â±ÄÂºπÁ™ó
                if (typeof GlobalCallPopup !== 'undefined') {
                    window.globalCallPopup = new GlobalCallPopup();
                    console.log('‚úÖ Âº∫Âà∂ÂàùÂßãÂåñÂÖ®Â±ÄÂºπÁ™ó');
                } else {
                    console.error('‚ùå GlobalCallPopupÁ±ªÊú™ÊâæÂà∞');
                }

                // 2. Á°Æ‰øùÁî®Êà∑‰ø°ÊÅØÂ≠òÂú®
                if (!window.currentUser) {
                    console.log('üîÑ Áî®Êà∑‰ø°ÊÅØÁº∫Â§±ÔºåÂ∞ùËØïËé∑Âèñ...');
                    await getCurrentUserForWebRTC();
                }

                if (!window.currentUser || !window.currentUser.id) {
                    console.error('‚ùå Êó†Ê≥ïËé∑ÂèñÁî®Êà∑‰ø°ÊÅØÔºåWebRTCÂàùÂßãÂåñÂ§±Ë¥•');
                    return;
                }

                console.log('‚úÖ Áî®Êà∑‰ø°ÊÅØÁ°ÆËÆ§:', window.currentUser);

                // 3. Âº∫Âà∂ÂàõÂª∫Áã¨Á´ãWebSocketËøûÊé•
                console.log('üîå ÂàõÂª∫WebSocketËøûÊé•...');
                await createForceWebSocketConnection();

                // 4. Âº∫Âà∂ËÆ¢ÈòÖÊ∂àÊÅØ
                console.log('üì° ËÆ¢ÈòÖWebRTCÊ∂àÊÅØ...');
                forceSubscribeMessages();

                // 5. ÂàùÂßãÂåñWebRTCÂÆ¢Êà∑Á´Ø
                console.log('üé• ÂàùÂßãÂåñWebRTCÂÆ¢Êà∑Á´Ø...');
                await initWebRTCClient();

                console.log('=== ‚úÖ ËÅäÂ§©È°µÈù¢WebRTCÂº∫Âà∂ÂàùÂßãÂåñÂÆåÊàê ===');

            } catch (error) {
                console.error('‚ùå WebRTCÂàùÂßãÂåñÂ§±Ë¥•:', error);
                // ÈáçËØïÊú∫Âà∂
                setTimeout(() => {
                    console.log('üîÑ 5ÁßíÂêéÈáçËØïWebRTCÂàùÂßãÂåñ...');
                    initWebRTCForChat();
                }, 5000);
            }
        }

        // ÂàùÂßãÂåñWebRTCÂÆ¢Êà∑Á´Ø
        async function initWebRTCClient() {
            try {
                if (typeof WebRTCClient === 'undefined') {
                    throw new Error('WebRTCClientÁ±ªÊú™Âä†ËΩΩ');
                }

                webrtcClient = new WebRTCClient();
                webrtcClient.stompClient = webrtcStompClient;
                webrtcClient.currentUserId = window.currentUser.id.toString();

                // ËÆæÁΩÆÂÖ®Â±ÄÂèòÈáè
                window.webrtcClient = webrtcClient;

                // ËÆæÁΩÆ‰∫ã‰ª∂ÂõûË∞É
                setupWebRTCCallbacks();

                console.log('‚úÖ WebRTCÂÆ¢Êà∑Á´ØÂàùÂßãÂåñÊàêÂäü');
            } catch (error) {
                console.error('‚ùå WebRTCÂÆ¢Êà∑Á´ØÂàùÂßãÂåñÂ§±Ë¥•:', error);
                throw error;
            }
        }

        // Âº∫Âà∂ÂàõÂª∫WebSocketËøûÊé•ÔºàÂ¢ûÂº∫ÁâàÔºâ
        function createForceWebSocketConnection() {
            return new Promise((resolve, reject) => {
                try {
                    console.log('üî• Âº∫Âà∂ÂàõÂª∫WebSocketËøûÊé•...');

                    // Â¶ÇÊûúÂ∑≤ÊúâËøûÊé•ÔºåÂÖàÊñ≠ÂºÄ
                    if (webrtcStompClient && webrtcStompClient.connected) {
                        console.log('üîÑ Êñ≠ÂºÄÁé∞ÊúâWebSocketËøûÊé•...');
                        webrtcStompClient.disconnect();
                    }

                    const socket = new SockJS('/ws');
                    webrtcStompClient = Stomp.over(socket);

                    // ÂêØÁî®Ë∞ÉËØïÊó•Âøó‰ª•‰æøÊéíÊü•ÈóÆÈ¢ò
                    webrtcStompClient.debug = function(str) {
                        console.log('STOMP Debug:', str);
                    };

                    // ËÆæÁΩÆÂøÉË∑≥‰øùÊåÅËøûÊé•
                    webrtcStompClient.heartbeat.outgoing = 10000;  // 10ÁßíÂèëÈÄÅÂøÉË∑≥
                    webrtcStompClient.heartbeat.incoming = 10000;  // 10ÁßíÊé•Êî∂ÂøÉË∑≥

                    webrtcStompClient.connect({}, function(frame) {
                        console.log('‚úÖ Âº∫Âà∂WebSocketËøûÊé•ÊàêÂäü: ' + frame);
                        window.stompClient = webrtcStompClient;

                        // Âª∂Ëøü‰∏Ä‰∏ãÁ°Æ‰øùËøûÊé•Á®≥ÂÆö
                        setTimeout(() => {
                            resolve();
                        }, 500);

                    }, function(error) {
                        console.error('‚ùå Âº∫Âà∂WebSocketËøûÊé•Â§±Ë¥•:', error);
                        reject(error);
                    });

                    // ÁõëÂê¨ËøûÊé•Êñ≠ÂºÄ‰∫ã‰ª∂
                    socket.onclose = function(event) {
                        console.warn('‚ö†Ô∏è WebSocketËøûÊé•Êñ≠ÂºÄ:', event);
                        // Ëá™Âä®ÈáçËøû
                        setTimeout(() => {
                            console.log('üîÑ Â∞ùËØïÈáçÊñ∞ËøûÊé•WebSocket...');
                            createForceWebSocketConnection().catch(console.error);
                        }, 3000);
                    };

                } catch (error) {
                    console.error('‚ùå ÂàõÂª∫WebSocketËøûÊé•ÂºÇÂ∏∏:', error);
                    reject(error);
                }
            });
        }

        // Âº∫Âà∂ËÆ¢ÈòÖÊ∂àÊÅØÔºàÂ¢ûÂº∫ÁâàÔºâ
        function forceSubscribeMessages() {
            if (!webrtcStompClient || !window.currentUser) {
                console.error('‚ùå Êó†Ê≥ïËÆ¢ÈòÖÔºöËøûÊé•ÊàñÁî®Êà∑Áº∫Â§±');
                return;
            }

            console.log('üî• Âº∫Âà∂ËÆ¢ÈòÖWebRTCÊ∂àÊÅØ...');
            console.log('ÂΩìÂâçÁî®Êà∑ID:', window.currentUser.id);

            try {
                // 1. ËÆ¢ÈòÖÈÄöËØùÈÇÄËØ∑ÔºàÁî®Êà∑ÈòüÂàóÔºâ
                const userQueueSub = webrtcStompClient.subscribe(`/user/queue/webrtc/call-invitation`, function(message) {
                    const data = JSON.parse(message.body);
                    console.log('üîî Êî∂Âà∞ÈÄöËØùÈÇÄËØ∑(Áî®Êà∑ÈòüÂàó):', data);
                    forceShowCallPopup(data);
                });
                console.log('‚úÖ ËÆ¢ÈòÖÁî®Êà∑ÈòüÂàóÊàêÂäü:', userQueueSub.id);

                // 2. ËÆ¢ÈòÖÈÄöËØùÈÇÄËØ∑ÔºàÂπøÊí≠È¢ëÈÅìÔºâ
                const topicSub = webrtcStompClient.subscribe(`/topic/webrtc/call-invitation/${window.currentUser.id}`, function(message) {
                    const data = JSON.parse(message.body);
                    console.log('üîî Êî∂Âà∞ÈÄöËØùÈÇÄËØ∑(ÂπøÊí≠È¢ëÈÅì):', data);
                    forceShowCallPopup(data);
                });
                console.log('‚úÖ ËÆ¢ÈòÖÂπøÊí≠È¢ëÈÅìÊàêÂäü:', topicSub.id);

                // 3. ËÆ¢ÈòÖÂº∫Âà∂ÂπøÊí≠È¢ëÈÅìÔºàÊñ∞Â¢ûÔºâ
                const broadcastSub = webrtcStompClient.subscribe(`/topic/webrtc/call-invitation-broadcast`, function(message) {
                    const data = JSON.parse(message.body);
                    console.log('üîî Êî∂Âà∞ÈÄöËØùÈÇÄËØ∑(Âº∫Âà∂ÂπøÊí≠):', data);
                    // Ê£ÄÊü•ÊòØÂê¶ÊòØÂèëÁªôÂΩìÂâçÁî®Êà∑ÁöÑ
                    if (data.calleeId === window.currentUser.id.toString()) {
                        forceShowCallPopup(data);
                    }
                });
                console.log('‚úÖ ËÆ¢ÈòÖÂº∫Âà∂ÂπøÊí≠È¢ëÈÅìÊàêÂäü:', broadcastSub.id);

                // 4. ËÆ¢ÈòÖÂä†ÂÖ•ÊàêÂäüÊ∂àÊÅØ
                const joinedSub = webrtcStompClient.subscribe(`/user/queue/webrtc/joined`, function(message) {
                    const data = JSON.parse(message.body);
                    console.log('‚úÖ Âä†ÂÖ•‰ø°‰ª§ÊúçÂä°Âô®ÊàêÂäü:', data);
                });
                console.log('‚úÖ ËÆ¢ÈòÖÂä†ÂÖ•ÊàêÂäüÊ∂àÊÅØ:', joinedSub.id);

                // 5. ËÆ¢ÈòÖÈÄöËØùÊé•Âèó
                const acceptSub = webrtcStompClient.subscribe(`/user/queue/webrtc/call-accepted`, function(message) {
                    const data = JSON.parse(message.body);
                    console.log('‚úÖ ÈÄöËØùË¢´Êé•Âèó:', data);
                    if (webrtcClient && webrtcClient.onCallAccepted) {
                        webrtcClient.onCallAccepted(data);
                    }
                });
                console.log('‚úÖ ËÆ¢ÈòÖÈÄöËØùÊé•ÂèóÊàêÂäü:', acceptSub.id);

                // 6. ËÆ¢ÈòÖÈÄöËØùÊãíÁªù
                const rejectSub = webrtcStompClient.subscribe(`/user/queue/webrtc/call-rejected`, function(message) {
                    const data = JSON.parse(message.body);
                    console.log('‚ùå ÈÄöËØùË¢´ÊãíÁªù:', data);
                    if (webrtcClient && webrtcClient.onCallRejected) {
                        webrtcClient.onCallRejected(data);
                    }
                });
                console.log('‚úÖ ËÆ¢ÈòÖÈÄöËØùÊãíÁªùÊàêÂäü:', rejectSub.id);

                // 7. ËÆ¢ÈòÖÈÄöËØùÁªìÊùü
                const endSub = webrtcStompClient.subscribe(`/user/queue/webrtc/call-ended`, function(message) {
                    const data = JSON.parse(message.body);
                    console.log('üîö ÈÄöËØùÁªìÊùü:', data);
                    if (webrtcClient && webrtcClient.onCallEnded) {
                        webrtcClient.onCallEnded(data);
                    }
                });
                console.log('‚úÖ ËÆ¢ÈòÖÈÄöËØùÁªìÊùüÊàêÂäü:', endSub.id);

                console.log('‚úÖ ÊâÄÊúâÊ∂àÊÅØËÆ¢ÈòÖÂÆåÊàêÔºåÂáÜÂ§áÂèëÈÄÅÂä†ÂÖ•Ê∂àÊÅØ...');

                // Âª∂ËøüÂèëÈÄÅÂä†ÂÖ•Ê∂àÊÅØÔºåÁ°Æ‰øùËÆ¢ÈòÖÂÆåÊàê
                setTimeout(() => {
                    webrtcStompClient.send('/app/webrtc/join', {}, JSON.stringify({
                        userId: window.currentUser.id.toString()
                    }));
                    console.log('üì§ ÂèëÈÄÅÂä†ÂÖ•Ê∂àÊÅØÔºåÁî®Êà∑ID:', window.currentUser.id);
                }, 500);

            } catch (error) {
                console.error('‚ùå ËÆ¢ÈòÖÊ∂àÊÅØÂ§±Ë¥•:', error);
                throw error;
            }
        }

        // Âº∫Âà∂ÊòæÁ§∫ÈÄöËØùÂºπÁ™ó
        function forceShowCallPopup(data) {
            console.log('üö® Âº∫Âà∂ÊòæÁ§∫ÈÄöËØùÂºπÁ™ó:', data);

            if (window.globalCallPopup) {
                window.globalCallPopup.show(data);
                console.log('‚úÖ ÂºπÁ™óÂ∑≤ÊòæÁ§∫');
            } else {
                // Á´ãÂç≥ÂàõÂª∫ÂºπÁ™ó
                if (typeof GlobalCallPopup !== 'undefined') {
                    window.globalCallPopup = new GlobalCallPopup();
                    window.globalCallPopup.show(data);
                    console.log('‚úÖ ‰∏¥Êó∂ÂàõÂª∫ÂºπÁ™óÂπ∂ÊòæÁ§∫');
                } else {
                    // ÊúÄÂêéÁöÑÂ§áÁî®ÊñπÊ°à
                    const accept = confirm(`üîî Êî∂Âà∞Êù•Ëá™ ${data.callerName} ÁöÑ${data.callType}ÈÄöËØùÈÇÄËØ∑ÔºåÊòØÂê¶Êé•Âê¨Ôºü`);
                    if (accept) {
                        acceptCall(data.roomId);
                    } else {
                        rejectCall(data.roomId);
                    }
                }
            }
        }

        // Ëé∑ÂèñÂΩìÂâçÁî®Êà∑‰ø°ÊÅØÔºàÁî®‰∫éWebRTCÔºâ
        async function getCurrentUserForWebRTC() {
            try {
                // Â¶ÇÊûúÂ∑≤ÁªèÊúâÁî®Êà∑‰ø°ÊÅØÔºåÁõ¥Êé•‰ΩøÁî®
                if (window.currentUser && window.currentUser.id) {
                    console.log('‰ΩøÁî®Áé∞ÊúâÁî®Êà∑‰ø°ÊÅØ:', window.currentUser);
                    return;
                }

                // Âê¶Âàô‰ªéAPIËé∑Âèñ
                const response = await fetch('/api/chat/user');
                if (response.ok) {
                    const userData = await response.json();
                    window.currentUser = userData;
                    console.log('‰ªéAPIËé∑ÂèñÁî®Êà∑‰ø°ÊÅØÊàêÂäü:', userData);
                } else {
                    throw new Error('Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØÂ§±Ë¥•');
                }
            } catch (error) {
                console.error('Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØÂ§±Ë¥•:', error);
                throw error;
            }
        }

        // Á≠âÂæÖËÅäÂ§©WebSocketËøûÊé•Â∞±Áª™ÔºåÁÑ∂ÂêéÂ§çÁî®ÂÆÉ
        function waitForChatWebSocket() {
            return new Promise((resolve, reject) => {
                console.log('Á≠âÂæÖËÅäÂ§©WebSocketËøûÊé•Â∞±Áª™...');

                let attempts = 0;
                const maxAttempts = 20; // 10ÁßíÔºåÊØè500msÊ£ÄÊü•‰∏ÄÊ¨°

                // Ê£ÄÊü•ChatAppÊòØÂê¶Â∑≤ËøûÊé•
                function checkConnection() {
                    attempts++;
                    console.log(`Ê£ÄÊü•ËøûÊé•Áä∂ÊÄÅ (${attempts}/${maxAttempts}):`, {
                        'window.ChatApp': !!window.ChatApp,
                        'ChatApp.stompClient': !!(window.ChatApp && window.ChatApp.stompClient),
                        'ChatApp.connected': !!(window.ChatApp && window.ChatApp.connected)
                    });

                    if (window.ChatApp && window.ChatApp.stompClient) {
                        console.log('ËÅäÂ§©WebSocketÂ∑≤ËøûÊé•ÔºåÂ§çÁî®ËøûÊé•');

                        // ‰ΩøÁî®ËÅäÂ§©ÁöÑWebSocketËøûÊé•
                        webrtcStompClient = window.ChatApp.stompClient;
                        window.stompClient = webrtcStompClient;

                        // Á´ãÂç≥ËÆ¢ÈòÖWebRTCÊ∂àÊÅØ
                        subscribeToWebRTCMessages();

                        resolve();
                    } else if (attempts >= maxAttempts) {
                        console.error('Á≠âÂæÖËÅäÂ§©WebSocketËøûÊé•Ë∂ÖÊó∂ÔºåÂ∞ùËØïÁã¨Á´ãËøûÊé•');
                        // ÂõûÈÄÄÂà∞Áã¨Á´ãËøûÊé•
                        initSimpleWebSocket().then(resolve).catch(reject);
                    } else {
                        // ÁªßÁª≠Á≠âÂæÖ
                        setTimeout(checkConnection, 500);
                    }
                }

                checkConnection();
            });
        }

        // ÁÆÄÂçïÁõ¥Êé•ÁöÑWebSocketËøûÊé•ÔºàÂ§áÁî®ÊñπÊ°àÔºâ
        function initSimpleWebSocket() {
            return new Promise((resolve, reject) => {
                try {
                    console.log('ÂºÄÂßãËøûÊé•WebSocketÔºàÁÆÄÂçïÊ®°ÂºèÔºâ...');

                    const socket = new SockJS('/ws');
                    webrtcStompClient = Stomp.over(socket);

                    // Á¶ÅÁî®Ë∞ÉËØïÊó•ÂøóÔºàÂèÇËÄÉÊµãËØïÈ°µÈù¢Ôºâ
                    webrtcStompClient.debug = null;

                    webrtcStompClient.connect({}, function(frame) {
                        console.log('WebSocketËøûÊé•ÊàêÂäü: ' + frame);

                        // ËÆæÁΩÆÂÖ®Â±ÄÂèòÈáè‰æõWebRTCClient‰ΩøÁî®
                        window.stompClient = webrtcStompClient;

                        // Á´ãÂç≥ËÆ¢ÈòÖÊ∂àÊÅØÔºàÂèÇËÄÉÊµãËØïÈ°µÈù¢Ôºâ
                        subscribeToWebRTCMessages();

                        resolve();
                    }, function(error) {
                        console.error('WebSocketËøûÊé•Â§±Ë¥•: ' + error);
                        reject(new Error('WebSocketËøûÊé•Â§±Ë¥•'));
                    });
                } catch (error) {
                    console.error('WebSocketÂàùÂßãÂåñÂºÇÂ∏∏: ' + error.message);
                    reject(error);
                }
            });
        }

        // ÂéüÊù•ÁöÑÂ§çÊùÇWebSocketËøûÊé•ÔºàÂ§áÁî®Ôºâ
        function initWebRTCWebSocket() {
            return new Promise((resolve, reject) => {
                try {
                    console.log('ÂàõÂª∫WebRTC‰∏ìÁî®WebSocketËøûÊé•...');

                    const socket = new SockJS('/ws');
                    webrtcStompClient = Stomp.over(socket);

                    // ÂêØÁî®Ë∞ÉËØïÊó•Âøó‰ª•‰æøÊéíÊü•ÈóÆÈ¢ò
                    webrtcStompClient.debug = function(str) {
                        console.log('STOMP Debug:', str);
                    };

                    // ËÆæÁΩÆÂº∫ÂäõÂøÉË∑≥‰øùÊåÅËøûÊé•
                    webrtcStompClient.heartbeat.outgoing = 5000;  // 5ÁßíÂèëÈÄÅÂøÉË∑≥
                    webrtcStompClient.heartbeat.incoming = 5000;  // 5ÁßíÊé•Êî∂ÂøÉË∑≥

                    webrtcStompClient.connect({}, function(frame) {
                        console.log('WebRTC WebSocketËøûÊé•ÊàêÂäü: ' + frame);

                        // ËÆæÁΩÆÂÖ®Â±ÄÂèòÈáè‰æõWebRTCClient‰ΩøÁî®
                        window.stompClient = webrtcStompClient;

                        // Âª∂ËøüËÆ¢ÈòÖÊ∂àÊÅØÔºåÁ°Æ‰øùËøûÊé•Á®≥ÂÆö
                        setTimeout(() => {
                            subscribeToWebRTCMessages();

                            // ÂêØÂä®‰øùÊ¥ªÊú∫Âà∂
                            startWebRTCKeepAlive();

                            resolve();
                        }, 1000);

                    }, function(error) {
                        console.error('WebRTC WebSocketËøûÊé•Â§±Ë¥•: ' + error);
                        reject(new Error('WebRTC WebSocketËøûÊé•Â§±Ë¥•'));
                    });

                    // ÁõëÂê¨ËøûÊé•Êñ≠ÂºÄ‰∫ã‰ª∂
                    socket.onclose = function(event) {
                        console.warn('WebSocketËøûÊé•Êñ≠ÂºÄ:', event);
                        // Ëá™Âä®ÈáçËøû
                        setTimeout(() => {
                            console.log('Â∞ùËØïÈáçÊñ∞ËøûÊé•WebSocket...');
                            initWebRTCWebSocket();
                        }, 3000);
                    };

                } catch (error) {
                    console.error('WebRTC WebSocketÂàùÂßãÂåñÂºÇÂ∏∏: ' + error.message);
                    reject(error);
                }
            });
        }

        // WebRTC‰øùÊ¥ªÊú∫Âà∂
        function startWebRTCKeepAlive() {
            // Ê∏ÖÈô§‰πãÂâçÁöÑ‰øùÊ¥ªÂÆöÊó∂Âô®
            if (window.webrtcKeepAliveInterval) {
                clearInterval(window.webrtcKeepAliveInterval);
            }

            console.log('ÂêØÂä®WebRTC‰øùÊ¥ªÊú∫Âà∂');

            window.webrtcKeepAliveInterval = setInterval(() => {
                if (webrtcStompClient && webrtcStompClient.connected && window.currentUser) {
                    try {
                        // ÂèëÈÄÅ‰øùÊ¥ªÊ∂àÊÅØ
                        webrtcStompClient.send('/app/webrtc/keepalive', {}, JSON.stringify({
                            userId: window.currentUser.id,
                            timestamp: Date.now()
                        }));
                        console.log('ÂèëÈÄÅWebRTC‰øùÊ¥ªÊ∂àÊÅØ');
                    } catch (error) {
                        console.error('ÂèëÈÄÅ‰øùÊ¥ªÊ∂àÊÅØÂ§±Ë¥•:', error);
                        // Â¶ÇÊûúÂèëÈÄÅÂ§±Ë¥•ÔºåÂ∞ùËØïÈáçËøû
                        setTimeout(() => {
                            initWebRTCWebSocket();
                        }, 1000);
                    }
                } else {
                    console.warn('WebSocketÊú™ËøûÊé•ÔºåÂÅúÊ≠¢‰øùÊ¥ªÂπ∂Â∞ùËØïÈáçËøû');
                    clearInterval(window.webrtcKeepAliveInterval);

                    // Â∞ùËØïÈáçËøû
                    setTimeout(() => {
                        initWebRTCWebSocket();
                    }, 2000);
                }
            }, 15000); // 15ÁßíÂèëÈÄÅ‰∏ÄÊ¨°‰øùÊ¥ªÊ∂àÊÅØ
        }

        // ËÆ¢ÈòÖWebRTCÊ∂àÊÅØÔºàÁÆÄÂåñÁâàÔºåÂèÇËÄÉÊµãËØïÈ°µÈù¢Ôºâ
        function subscribeToWebRTCMessages() {
            if (!webrtcStompClient || !window.currentUser) {
                console.error('WebRTC WebSocketÊú™ËøûÊé•ÊàñÁî®Êà∑‰ø°ÊÅØÁº∫Â§±');
                return;
            }

            console.log('ÂºÄÂßãËÆ¢ÈòÖÊ∂àÊÅØ...');

            // ËÆ¢ÈòÖÈÄöËØùÈÇÄËØ∑ÔºàÁî®Êà∑ÈòüÂàóÔºâ
            webrtcStompClient.subscribe(`/user/queue/webrtc/call-invitation`, function(message) {
                const data = JSON.parse(message.body);
                console.log('Êî∂Âà∞ÈÄöËØùÈÇÄËØ∑(Áî®Êà∑ÈòüÂàó): ' + JSON.stringify(data));
                handleCallInvitation(data);
            });

            // ËÆ¢ÈòÖÈÄöËØùÈÇÄËØ∑ÔºàÂπøÊí≠È¢ëÈÅìÔºâ
            webrtcStompClient.subscribe(`/topic/webrtc/call-invitation/${window.currentUser.id}`, function(message) {
                const data = JSON.parse(message.body);
                console.log('Êî∂Âà∞ÈÄöËØùÈÇÄËØ∑(ÂπøÊí≠È¢ëÈÅì): ' + JSON.stringify(data));
                handleCallInvitation(data);
            });

            // ËÆ¢ÈòÖÈÄöËØùÊé•Âèó
            webrtcStompClient.subscribe(`/user/queue/webrtc/call-accepted`, function(message) {
                const data = JSON.parse(message.body);
                console.log('ÈÄöËØùË¢´Êé•Âèó: ' + JSON.stringify(data));
                if (webrtcClient && webrtcClient.onCallAccepted) {
                    webrtcClient.onCallAccepted(data);
                }
            });

            // ËÆ¢ÈòÖÈÄöËØùÊãíÁªù
            webrtcStompClient.subscribe(`/user/queue/webrtc/call-rejected`, function(message) {
                const data = JSON.parse(message.body);
                console.log('ÈÄöËØùË¢´ÊãíÁªù: ' + JSON.stringify(data));
                if (webrtcClient && webrtcClient.onCallRejected) {
                    webrtcClient.onCallRejected(data);
                }
            });

            // ËÆ¢ÈòÖÈÄöËØùÁªìÊùü
            webrtcStompClient.subscribe(`/user/queue/webrtc/call-ended`, function(message) {
                const data = JSON.parse(message.body);
                console.log('ÈÄöËØùÁªìÊùü: ' + JSON.stringify(data));
                if (webrtcClient && webrtcClient.onCallEnded) {
                    webrtcClient.onCallEnded(data);
                }
            });

            console.log('Ê∂àÊÅØËÆ¢ÈòÖÂÆåÊàê');
        }

        // Â§ÑÁêÜÊù•ÁîµÈÇÄËØ∑
        function handleCallInvitation(data) {
            console.log('Â§ÑÁêÜÊù•ÁîµÈÇÄËØ∑: ', data);
            forceShowCallPopup(data);
        }

        // Êé•ÂèóÈÄöËØù
        function acceptCall(roomId) {
            console.log('‚úÖ Êé•ÂèóÈÄöËØù:', roomId);

            // ‰ΩøÁî®webrtcClientÊé•ÂèóÈÄöËØùÔºàËøô‰ºöÂ§ÑÁêÜÂ™í‰ΩìÊµÅÂíåWebRTCËøûÊé•Ôºâ
            if (webrtcClient) {
                webrtcClient.acceptCall(roomId).then(() => {
                    console.log('‚úÖ WebRTCÈÄöËØùËøûÊé•Âª∫Á´ãÊàêÂäü');
                    // ÊòæÁ§∫ÈÄöËØùÁïåÈù¢
                    showCallInterface('video', {roomId: roomId}, 'connected');
                }).catch(error => {
                    console.error('‚ùå WebRTCÈÄöËØùËøûÊé•Â§±Ë¥•:', error);
                });
            } else {
                console.error('‚ùå webrtcClientÊú™ÂàùÂßãÂåñ');
            }
        }

        // ÊãíÁªùÈÄöËØù
        function rejectCall(roomId) {
            console.log('‚ùå ÊãíÁªùÈÄöËØù:', roomId);

            // ‰ΩøÁî®webrtcClientÊãíÁªùÈÄöËØù
            if (webrtcClient) {
                webrtcClient.rejectCall(roomId);
                console.log('‚ùå Â∑≤ÈÄöËøáwebrtcClientÊãíÁªùÈÄöËØù');
            } else if (webrtcStompClient) {
                // Â§áÁî®ÊñπÊ°àÔºöÁõ¥Êé•ÂèëÈÄÅÊãíÁªùÊ∂àÊÅØ
                webrtcStompClient.send('/app/webrtc/reject', {}, JSON.stringify({
                    roomId: roomId,
                    calleeId: window.currentUser.id.toString()
                }));
                console.log('‚ùå Â∑≤ÂèëÈÄÅÊãíÁªùÈÄöËØùÊ∂àÊÅØ');
            }
        }

        // ËÆæÁΩÆWebRTC‰∫ã‰ª∂ÂõûË∞É
        function setupWebRTCCallbacks() {
            if (!webrtcClient) return;

            // ÈÄöËØùË¢´Êé•Âèó
            webrtcClient.onCallAccepted = function(data) {
                console.log('ÈÄöËØùË¢´Êé•Âèó:', data);
                updateCallStatus('ÈÄöËØùÂ∑≤Êé•ÈÄö');

                // ÊòæÁ§∫ÈÄöËØùÁïåÈù¢
                const callType = webrtcClient.currentCallType || 'video';
                showCallInterface(callType, data, 'connected');
            };

            // ÈÄöËØùË¢´ÊãíÁªù
            webrtcClient.onCallRejected = function(data) {
                console.log('ÈÄöËØùË¢´ÊãíÁªù:', data);
                updateCallStatus('ÈÄöËØùË¢´ÊãíÁªù');
                resetCallButtons();
            };

            // ÈÄöËØùÁªìÊùü
            webrtcClient.onCallEnded = function(data) {
                console.log('ÈÄöËØùÁªìÊùü:', data);
                updateCallStatus('ÈÄöËØùÂ∑≤ÁªìÊùü');
                resetCallButtons();
            };

            // ËøúÁ®ãÂ™í‰ΩìÊµÅ
            webrtcClient.onRemoteStream = function(stream) {
                console.log('Êî∂Âà∞ËøúÁ®ãÂ™í‰ΩìÊµÅ');

                // ÊòæÁ§∫ËøúÁ®ãËßÜÈ¢ë
                const remoteVideo = document.getElementById('remoteVideo');
                if (remoteVideo && stream) {
                    remoteVideo.srcObject = stream;
                    console.log('ËøúÁ®ãËßÜÈ¢ëÊµÅÂ∑≤ËÆæÁΩÆ');
                }
            };
        }

        // ÂèëËµ∑ËßÜÈ¢ëÈÄöËØùÔºàÂ¢ûÂº∫ÁâàÔºâ
        async function startVideoCall() {
            console.log('üöÄ ÂºÄÂßãÂèëËµ∑ËßÜÈ¢ëÈÄöËØù');

            // ‰ºòÂÖà‰ΩøÁî®WebRTCÁÆ°ÁêÜÂô®
            if (window.chatWebRTCManager && window.chatWebRTCManager.isInitialized) {
                try {
                    const targetUserId = getTargetUserId();
                    if (!targetUserId) {
                        alert('Êó†Ê≥ïËé∑ÂèñËÅäÂ§©ÂØπË±°IDÔºåËØ∑Á°Æ‰øùÂ∑≤ÈÄâÊã©ËÅäÂ§©ÂØπË±°');
                        return;
                    }

                    console.log('‰ΩøÁî®WebRTCÁÆ°ÁêÜÂô®ÂèëËµ∑ËßÜÈ¢ëÈÄöËØù');
                    await window.chatWebRTCManager.initiateCall(targetUserId, 'video');
                    return;
                } catch (error) {
                    console.error('WebRTCÁÆ°ÁêÜÂô®ÂèëËµ∑ÈÄöËØùÂ§±Ë¥•:', error);
                    // ÁªßÁª≠‰ΩøÁî®Â§áÁî®ÊñπÊ°à
                }
            }

            // Â§áÁî®ÊñπÊ°àÔºöÁõ¥Êé•‰ΩøÁî®WebSocket
            console.log('‰ΩøÁî®Â§áÁî®ÊñπÊ°àÂèëËµ∑ËßÜÈ¢ëÈÄöËØù');

            // 1. Ê£ÄÊü•WebSocketËøûÊé•
            if (!webrtcStompClient || !webrtcStompClient.connected) {
                console.error('‚ùå WebSocketÊú™ËøûÊé•');
                alert('WebSocketÊú™ËøûÊé•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
                return;
            }

            // 2. Ê£ÄÊü•Áî®Êà∑‰ø°ÊÅØ
            if (!window.currentUser || !window.currentUser.id) {
                console.error('‚ùå ÂΩìÂâçÁî®Êà∑‰ø°ÊÅØÁº∫Â§±');
                alert('Áî®Êà∑‰ø°ÊÅØÁº∫Â§±ÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï');
                return;
            }

            // 3. Ëé∑ÂèñÁõÆÊ†áÁî®Êà∑ID
            const targetUserId = getTargetUserId();
            if (!targetUserId) {
                console.error('‚ùå Êó†Ê≥ïËé∑ÂèñËÅäÂ§©ÂØπË±°ID');
                alert('Êó†Ê≥ïËé∑ÂèñËÅäÂ§©ÂØπË±°IDÔºåËØ∑Á°Æ‰øùÂ∑≤ÈÄâÊã©ËÅäÂ§©ÂØπË±°');
                return;
            }

            try {
                console.log('üé• ÂèëËµ∑ËßÜÈ¢ëÈÄöËØùËØ¶ÊÉÖ:');
                console.log('  - ÂèëËµ∑ËÄÖID:', window.currentUser.id);
                console.log('  - Êé•Êî∂ËÄÖID:', targetUserId);
                console.log('  - ÈÄöËØùÁ±ªÂûã: video');

                // ÊûÑÂª∫ÈÄöËØùÈÇÄËØ∑Êï∞ÊçÆ
                const callData = {
                    callerId: window.currentUser.id.toString(),
                    calleeId: targetUserId.toString(),
                    callType: 'video'
                };

                console.log('üì§ ÂèëÈÄÅÈÄöËØùÈÇÄËØ∑Êï∞ÊçÆ:', callData);

                // ÂèëÈÄÅÈÄöËØùÈÇÄËØ∑
                webrtcStompClient.send('/app/webrtc/call', {}, JSON.stringify(callData));

                console.log('‚úÖ ËßÜÈ¢ëÈÄöËØùÈÇÄËØ∑Â∑≤ÂèëÈÄÅ');
                updateCallStatus('ËßÜÈ¢ëÈÄöËØùÈÇÄËØ∑Â∑≤ÂèëÈÄÅÔºåÁ≠âÂæÖÂØπÊñπÂìçÂ∫î...');

                // ÊòæÁ§∫ÂèëËµ∑ÈÄöËØùÁöÑÁä∂ÊÄÅ
                showCallStatus('Ê≠£Âú®ÂëºÂè´...', 'video');

            } catch (error) {
                console.error('‚ùå ÂèëËµ∑ËßÜÈ¢ëÈÄöËØùÂ§±Ë¥•:', error);
                alert('ÂèëËµ∑ËßÜÈ¢ëÈÄöËØùÂ§±Ë¥•: ' + error.message);
            }
        }

        // ÂèëËµ∑ËØ≠Èü≥ÈÄöËØùÔºàÂ¢ûÂº∫ÁâàÔºâ
        async function startAudioCall() {
            console.log('üöÄ ÂºÄÂßãÂèëËµ∑ËØ≠Èü≥ÈÄöËØù');

            // ‰ºòÂÖà‰ΩøÁî®WebRTCÁÆ°ÁêÜÂô®
            if (window.chatWebRTCManager && window.chatWebRTCManager.isInitialized) {
                try {
                    const targetUserId = getTargetUserId();
                    if (!targetUserId) {
                        alert('Êó†Ê≥ïËé∑ÂèñËÅäÂ§©ÂØπË±°IDÔºåËØ∑Á°Æ‰øùÂ∑≤ÈÄâÊã©ËÅäÂ§©ÂØπË±°');
                        return;
                    }

                    console.log('‰ΩøÁî®WebRTCÁÆ°ÁêÜÂô®ÂèëËµ∑ËØ≠Èü≥ÈÄöËØù');
                    await window.chatWebRTCManager.initiateCall(targetUserId, 'audio');
                    return;
                } catch (error) {
                    console.error('WebRTCÁÆ°ÁêÜÂô®ÂèëËµ∑ÈÄöËØùÂ§±Ë¥•:', error);
                    // ÁªßÁª≠‰ΩøÁî®Â§áÁî®ÊñπÊ°à
                }
            }

            // Â§áÁî®ÊñπÊ°àÔºöÁõ¥Êé•‰ΩøÁî®WebSocket
            console.log('‰ΩøÁî®Â§áÁî®ÊñπÊ°àÂèëËµ∑ËØ≠Èü≥ÈÄöËØù');

            // 1. Ê£ÄÊü•WebSocketËøûÊé•
            if (!webrtcStompClient || !webrtcStompClient.connected) {
                console.error('‚ùå WebSocketÊú™ËøûÊé•');
                alert('WebSocketÊú™ËøûÊé•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
                return;
            }

            // 2. Ê£ÄÊü•Áî®Êà∑‰ø°ÊÅØ
            if (!window.currentUser || !window.currentUser.id) {
                console.error('‚ùå ÂΩìÂâçÁî®Êà∑‰ø°ÊÅØÁº∫Â§±');
                alert('Áî®Êà∑‰ø°ÊÅØÁº∫Â§±ÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï');
                return;
            }

            // 3. Ëé∑ÂèñÁõÆÊ†áÁî®Êà∑ID
            const targetUserId = getTargetUserId();
            if (!targetUserId) {
                console.error('‚ùå Êó†Ê≥ïËé∑ÂèñËÅäÂ§©ÂØπË±°ID');
                alert('Êó†Ê≥ïËé∑ÂèñËÅäÂ§©ÂØπË±°IDÔºåËØ∑Á°Æ‰øùÂ∑≤ÈÄâÊã©ËÅäÂ§©ÂØπË±°');
                return;
            }

            try {
                console.log('üìû ÂèëËµ∑ËØ≠Èü≥ÈÄöËØùËØ¶ÊÉÖ:');
                console.log('  - ÂèëËµ∑ËÄÖID:', window.currentUser.id);
                console.log('  - Êé•Êî∂ËÄÖID:', targetUserId);
                console.log('  - ÈÄöËØùÁ±ªÂûã: audio');

                // ÊûÑÂª∫ÈÄöËØùÈÇÄËØ∑Êï∞ÊçÆ
                const callData = {
                    callerId: window.currentUser.id.toString(),
                    calleeId: targetUserId.toString(),
                    callType: 'audio'
                };

                console.log('üì§ ÂèëÈÄÅÈÄöËØùÈÇÄËØ∑Êï∞ÊçÆ:', callData);

                // ÂèëÈÄÅÈÄöËØùÈÇÄËØ∑
                webrtcStompClient.send('/app/webrtc/call', {}, JSON.stringify(callData));

                console.log('‚úÖ ËØ≠Èü≥ÈÄöËØùÈÇÄËØ∑Â∑≤ÂèëÈÄÅ');
                updateCallStatus('ËØ≠Èü≥ÈÄöËØùÈÇÄËØ∑Â∑≤ÂèëÈÄÅÔºåÁ≠âÂæÖÂØπÊñπÂìçÂ∫î...');

                // ÊòæÁ§∫ÂèëËµ∑ÈÄöËØùÁöÑÁä∂ÊÄÅ
                showCallStatus('Ê≠£Âú®ÂëºÂè´...', 'audio');

            } catch (error) {
                console.error('‚ùå ÂèëËµ∑ËØ≠Èü≥ÈÄöËØùÂ§±Ë¥•:', error);
                alert('ÂèëËµ∑ËØ≠Èü≥ÈÄöËØùÂ§±Ë¥•: ' + error.message);
            }
        }

        // Ëé∑ÂèñËÅäÂ§©ÂØπË±°ÁöÑÁî®Êà∑ID
        function getTargetUserId() {
            console.log('ÂºÄÂßãËé∑ÂèñÁõÆÊ†áÁî®Êà∑ID...');
            console.log('ChatApp:', ChatApp);
            console.log('ChatApp.targetUser:', ChatApp?.targetUser);
            console.log('window.currentConversationId:', window.currentConversationId);
            console.log('ChatApp.currentConversationId:', ChatApp?.currentConversationId);

            // ÊñπÊ≥ï1: ‰ªéChatApp.targetUserËé∑Âèñ
            if (ChatApp && ChatApp.targetUser && ChatApp.targetUser.id) {
                console.log('‰ªéChatApp.targetUserËé∑ÂèñÂà∞ID:', ChatApp.targetUser.id);
                return ChatApp.targetUser.id;
            }

            // ÊñπÊ≥ï2: ‰ªéÂΩìÂâç‰ºöËØùÁöÑÂèÇ‰∏éËÄÖ‰∏≠Ëé∑Âèñ
            if (ChatApp && ChatApp.currentConversation && ChatApp.currentConversation.participants) {
                const otherParticipant = ChatApp.currentConversation.participants.find(
                    p => p.user.id !== window.currentUser.id
                );
                if (otherParticipant) {
                    console.log('‰ªécurrentConversation.participantsËé∑ÂèñÂà∞ID:', otherParticipant.user.id);
                    return otherParticipant.user.id;
                }
            }

            // ÊñπÊ≥ï3: ‰ªéconversationsÂàóË°®‰∏≠Ëé∑Âèñ
            const conversationId = window.currentConversationId || ChatApp?.currentConversationId;
            if (ChatApp && ChatApp.conversations && conversationId) {
                const conversation = ChatApp.conversations.find(c => c.id === conversationId);
                console.log('ÊâæÂà∞ÁöÑ‰ºöËØù:', conversation);
                if (conversation && conversation.participants) {
                    const otherParticipant = conversation.participants.find(
                        p => p.user.id !== window.currentUser.id
                    );
                    if (otherParticipant) {
                        console.log('‰ªéconversationsÂàóË°®Ëé∑ÂèñÂà∞ID:', otherParticipant.user.id);
                        // ÂêåÊó∂ËÆæÁΩÆtargetUser‰ª•‰æø‰∏ãÊ¨°‰ΩøÁî®
                        if (ChatApp) {
                            ChatApp.targetUser = otherParticipant.user;
                        }
                        return otherParticipant.user.id;
                    }
                }
            }

            console.error('Êó†Ê≥ïËé∑ÂèñËÅäÂ§©ÂØπË±°ID');
            console.error('Ë∞ÉËØï‰ø°ÊÅØ:', {
                ChatApp: !!ChatApp,
                targetUser: ChatApp?.targetUser,
                currentConversation: ChatApp?.currentConversation,
                conversations: ChatApp?.conversations?.length,
                conversationId: conversationId,
                currentUser: window.currentUser
            });
            return null;
        }

        // Êõ¥Êñ∞ÈÄöËØùÁä∂ÊÄÅÊòæÁ§∫
        function updateCallStatus(message) {
            // ÂèØ‰ª•Âú®ËÅäÂ§©Â§¥ÈÉ®ÊòæÁ§∫ÈÄöËØùÁä∂ÊÄÅ
            const statusElement = document.getElementById('chatStatus');
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.className = 'text-info';
            }
        }

        // Á¶ÅÁî®ÈÄöËØùÊåâÈíÆ
        function disableCallButtons() {
            const videoBtn = document.getElementById('videoCallBtn');
            const audioBtn = document.getElementById('audioCallBtn');

            if (videoBtn) {
                videoBtn.disabled = true;
                videoBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            }

            if (audioBtn) {
                audioBtn.disabled = true;
                audioBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            }
        }

        // ÈáçÁΩÆÈÄöËØùÊåâÈíÆ
        function resetCallButtons() {
            const videoBtn = document.getElementById('videoCallBtn');
            const audioBtn = document.getElementById('audioCallBtn');

            if (videoBtn) {
                videoBtn.disabled = false;
                videoBtn.innerHTML = '<i class="fas fa-video"></i>';
            }

            if (audioBtn) {
                audioBtn.disabled = false;
                audioBtn.innerHTML = '<i class="fas fa-phone"></i>';
            }

            // ÈáçÁΩÆÁä∂ÊÄÅÊòæÁ§∫
            const statusElement = document.getElementById('chatStatus');
            if (statusElement) {
                statusElement.textContent = 'Âú®Á∫ø';
                statusElement.className = 'text-muted';
            }
        }

        // Ë∞ÉËØïWebRTCÁä∂ÊÄÅ
        function debugWebRTC() {
            const targetUserId = getTargetUserId();
            const debugInfo = {
                'WebRTCÁÆ°ÁêÜÂô®': !!webrtcManager,
                'WebRTCÁÆ°ÁêÜÂô®ÂàùÂßãÂåñ': webrtcManager?.isInitialized,
                'WebRTCÂÆ¢Êà∑Á´Ø': !!webrtcClient,
                'WebRTC‰∏ìÁî®WebSocket': webrtcStompClient?.connected,
                'ËÅäÂ§©WebSocket': stompClient?.connected,
                'ÂÖ®Â±ÄWebSocket': window.stompClient?.connected,
                'ÂΩìÂâçÁî®Êà∑': window.currentUser,
                'ÂΩìÂâç‰ºöËØùID': window.currentConversationId,
                'ChatAppÂ≠òÂú®': !!ChatApp,
                'ChatAppÁõÆÊ†áÁî®Êà∑': ChatApp?.targetUser,
                'ChatAppÂΩìÂâç‰ºöËØù': ChatApp?.currentConversation,
                'ChatApp‰ºöËØùÂàóË°®ÈïøÂ∫¶': ChatApp?.conversations?.length,
                'Ëé∑ÂèñÂà∞ÁöÑÁõÆÊ†áÁî®Êà∑ID': targetUserId,
                'GlobalCallPopup': !!window.globalCallPopup,
                'WebRTCClientÁ±ª': typeof WebRTCClient,
                'ChatWebRTCManagerÁ±ª': typeof ChatWebRTCManager,
                'SockJS': typeof SockJS,
                'Stomp': typeof Stomp
            };

            console.log('=== WebRTCË∞ÉËØï‰ø°ÊÅØ ===');
            console.table(debugInfo);

            if (webrtcManager) {
                console.log('WebRTCÁÆ°ÁêÜÂô®ËØ¶ÁªÜÁä∂ÊÄÅ:', webrtcManager.getStatus());

                // ÊµãËØïÊ∂àÊÅØÂèëÈÄÅ
                if (webrtcManager.stompClient && window.currentUser) {
                    console.log('ÊµãËØïÂèëÈÄÅ‰øùÊ¥ªÊ∂àÊÅØ...');
                    webrtcManager.stompClient.send('/app/webrtc/keepalive', {}, JSON.stringify({
                        userId: window.currentUser.id.toString()
                    }));
                }
            }

            // È¢ùÂ§ñÁöÑËØ¶ÁªÜ‰ø°ÊÅØ
            console.log('=== ËØ¶ÁªÜ‰ø°ÊÅØ ===');
            console.log('window.currentUser:', window.currentUser);
            console.log('ChatApp.targetUser:', ChatApp?.targetUser);
            console.log('ChatApp.conversations:', ChatApp?.conversations);
            console.log('webrtcClient:', webrtcClient);

            // ÊµãËØïWebSocketËøûÊé•
            testWebSocketConnection();

            alert('Ë∞ÉËØï‰ø°ÊÅØÂ∑≤ËæìÂá∫Âà∞ÊéßÂà∂Âè∞ÔºåËØ∑ÊåâF12Êü•Áúã');
        }

        // ÊµãËØïWebSocketËøûÊé•
        function testWebSocketConnection() {
            console.log('=== ÊµãËØïWebSocketËøûÊé• ===');

            if (webrtcStompClient && webrtcStompClient.connected) {
                console.log('ÂèëÈÄÅÊµãËØïÊ∂àÊÅØÂà∞WebRTC‰ø°‰ª§ÊúçÂä°Âô®...');

                try {
                    // ÂèëÈÄÅÂä†ÂÖ•‰ø°‰ª§ÁöÑÊ∂àÊÅØ
                    webrtcStompClient.send('/app/webrtc/join', {}, JSON.stringify({
                        userId: window.currentUser.id
                    }));
                    console.log('ÊµãËØïÊ∂àÊÅØÂèëÈÄÅÊàêÂäü');
                } catch (error) {
                    console.error('ÂèëÈÄÅÊµãËØïÊ∂àÊÅØÂ§±Ë¥•:', error);
                }
            } else {
                console.error('WebSocketÊú™ËøûÊé•ÔºåÊó†Ê≥ïÂèëÈÄÅÊµãËØïÊ∂àÊÅØ');
            }
        }

        // ÈÄöËØùÁïåÈù¢Áõ∏ÂÖ≥ÂáΩÊï∞
        let callTimer = null;
        let callStartTime = null;
        let isMuted = false;
        let isVideoOff = false;

        // ÊòæÁ§∫ÈÄöËØùÁïåÈù¢
        function showCallInterface(callType, callData, status = 'connecting') {
            console.log('ÊòæÁ§∫ÈÄöËØùÁïåÈù¢:', callType, callData, status);

            const callInterface = document.getElementById('callInterface');
            const callTitle = document.getElementById('callTitle');
            const callStatus = document.getElementById('callStatus');

            if (callInterface && callTitle && callStatus) {
                callTitle.textContent = callType === 'video' ? 'ËßÜÈ¢ëÈÄöËØù' : 'ËØ≠Èü≥ÈÄöËØù';
                callStatus.textContent = status === 'connecting' ? 'ËøûÊé•‰∏≠...' :
                                       status === 'connected' ? 'Â∑≤ËøûÊé•' : 'ÈÄöËØù‰∏≠';

                callInterface.style.display = 'block';

                // Â¶ÇÊûúÊòØËØ≠Èü≥ÈÄöËØùÔºåÈöêËóèËßÜÈ¢ëÂÖÉÁ¥†
                const remoteVideo = document.getElementById('remoteVideo');
                const localVideo = document.getElementById('localVideo');
                if (callType === 'audio') {
                    if (remoteVideo) remoteVideo.style.display = 'none';
                    if (localVideo) localVideo.style.display = 'none';
                } else {
                    if (remoteVideo) remoteVideo.style.display = 'block';
                    if (localVideo) localVideo.style.display = 'block';
                }

                // ÂºÄÂßãËÆ°Êó∂
                if (status === 'connected') {
                    startCallTimer();
                }
            }
        }

        // ÈöêËóèÈÄöËØùÁïåÈù¢
        function hideCallInterface() {
            console.log('ÈöêËóèÈÄöËØùÁïåÈù¢');

            const callInterface = document.getElementById('callInterface');
            if (callInterface) {
                callInterface.style.display = 'none';
            }

            // ÂÅúÊ≠¢ËÆ°Êó∂
            stopCallTimer();

            // ÈáçÁΩÆÁä∂ÊÄÅ
            isMuted = false;
            isVideoOff = false;
            updateCallButtons();
        }

        // ÂºÄÂßãÈÄöËØùËÆ°Êó∂
        function startCallTimer() {
            callStartTime = Date.now();
            callTimer = setInterval(updateCallTimer, 1000);
        }

        // ÂÅúÊ≠¢ÈÄöËØùËÆ°Êó∂
        function stopCallTimer() {
            if (callTimer) {
                clearInterval(callTimer);
                callTimer = null;
            }
            callStartTime = null;
        }

        // Êõ¥Êñ∞ÈÄöËØùËÆ°Êó∂ÊòæÁ§∫
        function updateCallTimer() {
            if (!callStartTime) return;

            const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;

            const timerElement = document.getElementById('callTimer');
            if (timerElement) {
                timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        // ÂàáÊç¢ÈùôÈü≥
        function toggleMute() {
            isMuted = !isMuted;
            console.log('ÂàáÊç¢ÈùôÈü≥:', isMuted);

            if (webrtcClient && webrtcClient.localStream) {
                const audioTracks = webrtcClient.localStream.getAudioTracks();
                audioTracks.forEach(track => {
                    track.enabled = !isMuted;
                });
            }

            updateCallButtons();
        }

        // ÂàáÊç¢ËßÜÈ¢ë
        function toggleVideo() {
            isVideoOff = !isVideoOff;
            console.log('ÂàáÊç¢ËßÜÈ¢ë:', isVideoOff);

            if (webrtcClient && webrtcClient.localStream) {
                const videoTracks = webrtcClient.localStream.getVideoTracks();
                videoTracks.forEach(track => {
                    track.enabled = !isVideoOff;
                });
            }

            updateCallButtons();
        }

        // ÁªìÊùüÈÄöËØù
        function endCall() {
            console.log('ÁªìÊùüÈÄöËØù');

            if (webrtcClient) {
                webrtcClient.endCall();
            }

            hideCallInterface();
        }

        // ÊòæÁ§∫ÈÄöËØùÁä∂ÊÄÅ
        function showCallStatus(message, callType) {
            console.log(`${callType}ÈÄöËØùÁä∂ÊÄÅ:`, message);

            // ÂàõÂª∫Áä∂ÊÄÅÊèêÁ§∫
            const statusDiv = document.createElement('div');
            statusDiv.className = 'call-status-popup position-fixed top-0 start-50 translate-middle-x mt-3';
            statusDiv.style.zIndex = '9999';
            statusDiv.innerHTML = `
                <div class="alert alert-primary alert-dismissible">
                    <i class="fas fa-${callType === 'video' ? 'video' : 'phone'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;

            document.body.appendChild(statusDiv);

            // 5ÁßíÂêéËá™Âä®ÁßªÈô§
            setTimeout(() => {
                if (statusDiv && statusDiv.parentNode) {
                    statusDiv.parentNode.removeChild(statusDiv);
                }
            }, 5000);
        }

        // Êõ¥Êñ∞ÈÄöËØùÊåâÈíÆÁä∂ÊÄÅ
        function updateCallButtons() {
            const muteBtn = document.getElementById('muteBtn');
            const videoBtn = document.getElementById('videoBtn');

            if (muteBtn) {
                const icon = muteBtn.querySelector('i');
                if (isMuted) {
                    muteBtn.classList.add('muted');
                    icon.className = 'fas fa-microphone-slash';
                } else {
                    muteBtn.classList.remove('muted');
                    icon.className = 'fas fa-microphone';
                }
            }

            if (videoBtn) {
                const icon = videoBtn.querySelector('i');
                if (isVideoOff) {
                    videoBtn.classList.add('muted');
                    icon.className = 'fas fa-video-slash';
                } else {
                    videoBtn.classList.remove('muted');
                    icon.className = 'fas fa-video';
                }
            }
        }

        // ÂàùÂßãÂåñWebRTCÁÆ°ÁêÜÂô®
        async function initWebRTCManager() {
            try {
                console.log('ÂºÄÂßãÂàùÂßãÂåñWebRTCÁÆ°ÁêÜÂô®...');

                // Ê£ÄÊü•ÂøÖË¶ÅÁöÑÁ±ªÊòØÂê¶Â≠òÂú®
                if (typeof ChatWebRTCManager === 'undefined') {
                    console.error('ChatWebRTCManagerÁ±ªÊú™ÂÆö‰πâÔºåËØ∑Ê£ÄÊü•chat-webrtc-manager.jsÊòØÂê¶Ê≠£Á°ÆÂä†ËΩΩ');
                    return;
                }

                // ÂàõÂª∫WebRTCÁÆ°ÁêÜÂô®ÂÆû‰æã
                if (!window.chatWebRTCManager) {
                    window.chatWebRTCManager = new ChatWebRTCManager();
                    console.log('WebRTCÁÆ°ÁêÜÂô®ÂÆû‰æãÂ∑≤ÂàõÂª∫');
                }

                // ÂàùÂßãÂåñÁÆ°ÁêÜÂô®
                await window.chatWebRTCManager.initialize();
                console.log('‚úÖ WebRTCÁÆ°ÁêÜÂô®ÂàùÂßãÂåñÊàêÂäü');

            } catch (error) {
                console.error('‚ùå WebRTCÁÆ°ÁêÜÂô®ÂàùÂßãÂåñÂ§±Ë¥•:', error);
            }
        }
    </script>
</body>
</html>
