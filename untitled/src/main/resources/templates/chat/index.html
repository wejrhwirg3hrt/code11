<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠå¤© - è§†é¢‘åˆ†äº«å¹³å°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/css/chat.css" rel="stylesheet">
    <link href="/css/webrtc-call.css" rel="stylesheet">
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-video me-2"></i>è§†é¢‘åˆ†äº«å¹³å°
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">
                    <i class="fas fa-home me-1"></i>é¦–é¡µ
                </a>
                <a class="nav-link active" href="/chat">
                    <i class="fas fa-comments me-1"></i>èŠå¤©
                    <span class="badge bg-danger ms-1" id="totalUnreadCount" style="display: none;">0</span>
                </a>

                <div class="nav-item dropdown" th:if="${currentUser != null and currentUser.username != null}">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <img th:src="${currentUser.avatar ?: '/images/default-avatar.png'}" alt="å¤´åƒ" class="rounded-circle me-1" width="24" height="24">
                        <span th:text="${currentUser.username}">ç”¨æˆ·å</span>
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="/profile">ä¸ªäººèµ„æ–™</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="/logout">é€€å‡ºç™»å½•</a></li>
                    </ul>
                </div>
                <!-- æœªç™»å½•ç”¨æˆ·æ˜¾ç¤ºç™»å½•æŒ‰é’® -->
                <div class="nav-item" th:if="${currentUser == null}">
                    <a class="nav-link" href="/login">
                        <i class="fas fa-sign-in-alt me-1"></i>ç™»å½•
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- èŠå¤©ä¸»ç•Œé¢ -->
    <div class="container-fluid chat-container">
        <div class="row h-100">
            <!-- ä¼šè¯åˆ—è¡¨ -->
            <div class="col-md-4 col-lg-3 chat-sidebar">
                <div class="chat-header">
                    <h5 class="mb-0">
                        <i class="fas fa-comments me-2"></i>èŠå¤©
                    </h5>
                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#newChatModal">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                
                <!-- æœç´¢æ¡† -->
                <div class="search-box">
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" class="form-control" placeholder="æœç´¢ä¼šè¯..." id="searchInput">
                    </div>
                </div>

                <!-- ä¼šè¯åˆ—è¡¨ -->
                <div class="conversation-list" id="conversationList">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-comments fa-3x mb-3"></i>
                        <p>æš‚æ— ä¼šè¯</p>
                        <p class="small">ç‚¹å‡»å³ä¸Šè§’çš„ + å·å¼€å§‹æ–°çš„èŠå¤©</p>
                    </div>
                </div>
            </div>

            <!-- èŠå¤©åŒºåŸŸ -->
            <div class="col-md-8 col-lg-9 chat-main" id="chatMain">
                <!-- æ¬¢è¿ç•Œé¢ -->
                <div class="chat-welcome" id="chatWelcome">
                    <div class="text-center">
                        <i class="fas fa-comments fa-4x text-muted mb-4"></i>
                        <h4 class="text-muted">æ¬¢è¿ä½¿ç”¨èŠå¤©åŠŸèƒ½</h4>
                        <p class="text-muted">é€‰æ‹©ä¸€ä¸ªä¼šè¯å¼€å§‹èŠå¤©ï¼Œæˆ–åˆ›å»ºæ–°çš„ä¼šè¯</p>
                    </div>
                </div>

                <!-- èŠå¤©ç•Œé¢ -->
                <div class="chat-interface" id="chatInterface" style="display: none;">
                    <!-- èŠå¤©å¤´éƒ¨ -->
                    <div class="chat-conversation-header">
                        <div class="d-flex align-items-center">
                            <img id="chatAvatar" src="/images/default-avatar.png" alt="å¤´åƒ" class="rounded-circle me-3" width="40" height="40">
                            <div>
                                <h6 class="mb-0" id="chatTitle">èŠå¤©å¯¹è±¡</h6>
                                <small class="text-muted" id="chatStatus">åœ¨çº¿</small>
                            </div>
                        </div>
                        <div class="chat-actions" id="chatActions" style="display: none;">
                            <button class="btn btn-sm btn-outline-secondary me-2" onclick="startAudioCall()" title="è¯­éŸ³é€šè¯">
                                <i class="fas fa-phone"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary me-2" onclick="startVideoCall()" title="è§†é¢‘é€šè¯">
                                <i class="fas fa-video"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                        </div>
                    </div>

                    <!-- æ¶ˆæ¯åŒºåŸŸ -->
                    <div class="messages-container" id="messagesContainer">
                        <div class="messages-list" id="messagesList">
                            <!-- æ¶ˆæ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                        <!-- æ»šåŠ¨åˆ°åº•éƒ¨æŒ‰é’® -->
                        <div class="scroll-to-bottom-btn" id="scrollToBottomBtn" style="display: none;">
                            <button class="btn btn-primary btn-sm rounded-circle" onclick="ChatApp.scrollToLatestMessage(true)" title="æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                    </div>

                    <!-- æ–‡ä»¶é¢„è§ˆåŒºåŸŸ -->
                    <div class="file-preview-area" id="filePreviewArea" style="display: none;">
                        <div class="file-preview-content">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-muted">å‡†å¤‡å‘é€çš„æ–‡ä»¶ï¼š</span>
                                <button class="btn btn-sm btn-outline-danger" onclick="clearFilePreview()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div id="filePreviewList">
                                <!-- æ–‡ä»¶é¢„è§ˆé¡¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                            </div>
                        </div>
                    </div>

                    <!-- è¾“å…¥åŒºåŸŸ -->
                    <div class="message-input-area" id="messageInputArea">
                        <div class="input-toolbar">
                            <button class="btn btn-sm btn-outline-secondary" title="è¡¨æƒ…" onclick="toggleEmojiPicker()">
                                <i class="fas fa-smile"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" title="å›¾ç‰‡" onclick="selectFile('image')">
                                <i class="fas fa-image"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" title="æ–‡ä»¶" onclick="selectFile('file')">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" title="è§†é¢‘" onclick="selectFile('video')">
                                <i class="fas fa-video"></i>
                            </button>
                            <!-- æµ‹è¯•æŒ‰é’® -->
                            <button class="btn btn-sm btn-outline-info" title="åˆ·æ–°åœ¨çº¿çŠ¶æ€" onclick="ChatApp.updateAllUsersOnlineStatus()">
                                <i class="fas fa-sync"></i>
                            </button>
                        </div>

                        <div class="input-group">
                            <textarea class="form-control" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." rows="1"
                                      onkeydown="handleMessageInput(event)" oninput="autoResize(this)"></textarea>
                            <button class="btn btn-primary" id="sendButton" onclick="sendMessage()">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è¡¨æƒ…é€‰æ‹©å™¨ -->
    <div class="emoji-picker" id="emojiPicker" style="display: none;">
        <div class="emoji-categories">
            <button class="emoji-category active" data-category="faces">ğŸ˜Š</button>
            <button class="emoji-category" data-category="gestures">ğŸ‘</button>
            <button class="emoji-category" data-category="hearts">â¤ï¸</button>
            <button class="emoji-category" data-category="animals">ğŸ±</button>
        </div>
        <div class="emoji-grid" id="emojiGrid">
            <!-- è¡¨æƒ…å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
        </div>
    </div>

    <!-- æ–‡ä»¶è¾“å…¥ -->
    <input type="file" id="fileInput" style="display: none;" multiple accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.txt,.zip,.rar">

    <!-- WebRTCé€šè¯ç•Œé¢ -->
    <div class="call-overlay" id="callOverlay">
        <div class="call-container">
            <!-- è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨ -->
            <div class="connection-status" id="connectionStatus">è¿æ¥ä¸­...</div>

            <!-- è§†é¢‘é€šè¯ç•Œé¢ -->
            <div class="video-call-container" id="videoCallContainer" style="display: none;">
                <video id="remoteVideo" class="remote-video" autoplay playsinline></video>
                <video id="localVideo" class="local-video" autoplay playsinline muted></video>
            </div>

            <!-- è¯­éŸ³é€šè¯ç•Œé¢ -->
            <div class="audio-call-container" id="audioCallContainer" style="display: none;">
                <img id="callAvatar" class="call-avatar" src="/images/default-avatar.png" alt="ç”¨æˆ·å¤´åƒ">
                <div class="call-user-info">
                    <div class="call-user-name" id="callUserName">ç”¨æˆ·å</div>
                    <div class="call-status" id="callStatus">è¿æ¥ä¸­...</div>
                    <div class="call-duration" id="callDuration">00:00</div>
                </div>
            </div>

            <!-- æ¥ç”µç•Œé¢ -->
            <div class="incoming-call" id="incomingCall" style="display: none;">
                <img id="incomingCallAvatar" class="incoming-call-avatar" src="/images/default-avatar.png" alt="ç”¨æˆ·å¤´åƒ">
                <div class="incoming-call-info">
                    <div class="incoming-call-name" id="incomingCallName">ç”¨æˆ·å</div>
                    <div class="incoming-call-type" id="incomingCallType">è¯­éŸ³é€šè¯</div>
                </div>
                <div class="incoming-call-controls">
                    <button class="call-control-btn btn-reject" onclick="rejectCall()" title="æ‹’ç»">
                        <i class="fas fa-phone-slash"></i>
                    </button>
                    <button class="call-control-btn btn-answer" onclick="acceptCall()" title="æ¥å¬">
                        <i class="fas fa-phone"></i>
                    </button>
                </div>
            </div>

            <!-- é€šè¯æ§åˆ¶æ  -->
            <div class="call-controls" id="callControls">
                <button class="call-control-btn btn-mute" id="muteBtn" onclick="toggleMute()" title="é™éŸ³">
                    <i class="fas fa-microphone"></i>
                </button>
                <button class="call-control-btn btn-video" id="videoBtn" onclick="toggleVideo()" title="æ‘„åƒå¤´" style="display: none;">
                    <i class="fas fa-video"></i>
                </button>
                <button class="call-control-btn btn-hangup" onclick="endCall()" title="æŒ‚æ–­">
                    <i class="fas fa-phone-slash"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- æ–°å»ºèŠå¤©æ¨¡æ€æ¡† -->
    <div class="modal fade" id="newChatModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">æ–°å»ºèŠå¤©</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">æœç´¢ç”¨æˆ·</label>
                        <input type="text" class="form-control" id="userSearchInput" placeholder="è¾“å…¥ç”¨æˆ·åæœç´¢...">
                    </div>
                    <div id="userSearchResults" class="user-search-results">
                        <!-- æœç´¢ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                </div>
            </div>
        </div>
    </div>



    <!-- è„šæœ¬ -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/lib/sockjs.min.js"></script>
    <script src="/lib/stomp.min.js"></script>
    <script src="/js/global-call-popup.js"></script>
    <script src="/js/avatar-sync.js"></script>
    <script src="/js/chat.js?v=20250821-2"></script>
    <script src="/js/webrtc-client.js"></script>
    <script src="/js/global-webrtc-manager.js"></script>
    <script src="/js/call-ui.js"></script>

    <!-- ç”¨æˆ·ä¿¡æ¯ä¼ é€’ -->
    <script th:inline="javascript">
        window.currentUser = /*[[${currentUser}]]*/ null;
        window.isAuthenticated = /*[[${isAuthenticated}]]*/ false;
        console.log('ç”¨æˆ·ä¿¡æ¯ä¼ é€’:', window.currentUser);
        console.log('è®¤è¯çŠ¶æ€:', window.isAuthenticated);
    </script>

    <script>
        // åˆå§‹åŒ–èŠå¤©é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            console.log('èŠå¤©ä¸»é¡µ - å½“å‰ç”¨æˆ·ä¿¡æ¯:', window.currentUser);
            console.log('è®¤è¯çŠ¶æ€:', window.isAuthenticated);

            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
            if (!window.currentUser || !window.currentUser.id) {
                console.warn('ç”¨æˆ·æœªç™»å½•ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µé¢');
                window.location.href = '/auth/login';
                return;
            }

            // åˆå§‹åŒ–èŠå¤©åŠŸèƒ½
            if (typeof ChatApp !== 'undefined') {
                ChatApp.init();
            } else {
                console.error('ChatApp æœªå®šä¹‰');
            }

            // åˆå§‹åŒ–WebRTCå®¢æˆ·ç«¯
            if (window.currentUser && window.currentUser.id) {
                initializeWebRTC();
            }

            // ç›‘å¬æ–°å»ºèŠå¤©æ¨¡æ€æ¡†æ˜¾ç¤ºäº‹ä»¶
            const newChatModal = document.getElementById('newChatModal');
            if (newChatModal) {
                newChatModal.addEventListener('shown.bs.modal', function() {
                    // æ¨¡æ€æ¡†æ˜¾ç¤ºæ—¶è‡ªåŠ¨åŠ è½½æ‰€æœ‰ç”¨æˆ·
                    if (typeof ChatApp !== 'undefined') {
                        ChatApp.searchUsers(''); // ç©ºæœç´¢ä¼šè¿”å›æ‰€æœ‰ç”¨æˆ·
                    }
                });

                // æ¨¡æ€æ¡†éšè—æ—¶æ¸…ç©ºæœç´¢ç»“æœ
                newChatModal.addEventListener('hidden.bs.modal', function() {
                    document.getElementById('userSearchInput').value = '';
                    document.getElementById('userSearchResults').innerHTML = '';
                });
            }
        });

        // WebRTCç›¸å…³å˜é‡ï¼ˆè¿™äº›å˜é‡åœ¨call-ui.jsä¸­å·²å£°æ˜ï¼Œè¿™é‡Œä¸éœ€è¦é‡å¤å£°æ˜ï¼‰

        // åˆå§‹åŒ–WebRTC
        async function initializeWebRTC() {
            try {
                // æ£€æŸ¥SockJSå’ŒStompæ˜¯å¦å¯ç”¨
                if (typeof SockJS === 'undefined') {
                    console.error('SockJSåº“æœªåŠ è½½');
                    return;
                }
                if (typeof Stomp === 'undefined') {
                    console.error('Stompåº“æœªåŠ è½½');
                    return;
                }

                // æ£€æŸ¥GlobalWebRTCManagerç±»æ˜¯å¦å­˜åœ¨
                if (typeof GlobalWebRTCManager === 'undefined') {
                    console.error('GlobalWebRTCManagerç±»æœªå®šä¹‰ï¼Œè¯·æ£€æŸ¥global-webrtc-manager.jsæ˜¯å¦æ­£ç¡®åŠ è½½');
                    return;
                }

                // åˆ›å»ºå…¨å±€WebRTCç®¡ç†å™¨å®ä¾‹
                if (!window.globalWebRTCManager) {
                    window.globalWebRTCManager = new GlobalWebRTCManager('chat');
                    console.log('èŠå¤©é¡µé¢å…¨å±€WebRTCç®¡ç†å™¨å·²åˆ›å»º');
                }

                await window.globalWebRTCManager.initialize();

                // æ£€æŸ¥WebRTCå®¢æˆ·ç«¯æ˜¯å¦æˆåŠŸåˆ›å»º
                if (!window.webrtcClient) {
                    throw new Error('WebRTCå®¢æˆ·ç«¯åˆ›å»ºå¤±è´¥');
                }

                // è®¾ç½®äº‹ä»¶å›è°ƒ
                window.webrtcClient.onCallInvitation = handleCallInvitation;
                window.webrtcClient.onCallAccepted = handleCallAccepted;
                window.webrtcClient.onCallRejected = handleCallRejected;
                window.webrtcClient.onCallEnded = handleCallEnded;
                window.webrtcClient.onRemoteStream = handleRemoteStream;
                window.webrtcClient.onConnectionStateChange = handleConnectionStateChange;

                console.log('âœ… WebRTCå®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ');
            } catch (error) {
                console.error('WebRTCå®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥:', error);
            }
        }

        // å‘èµ·è¯­éŸ³é€šè¯
        async function startAudioCall() {
            // æ£€æŸ¥WebRTCå®¢æˆ·ç«¯æ˜¯å¦å·²åˆå§‹åŒ–
            if (!window.webrtcClient) {
                console.error('âŒ WebRTCå®¢æˆ·ç«¯æœªåˆå§‹åŒ–');
                alert('WebRTCå®¢æˆ·ç«¯æœªåˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return;
            }

            // ä¼˜å…ˆä½¿ç”¨å½“å‰èŠå¤©ä¼šè¯çš„å¯¹è±¡
            let targetUser = await getCurrentChatUser();

            if (!targetUser || !targetUser.id) {
                alert('è¯·å…ˆé€‰æ‹©èŠå¤©å¯¹è±¡');
                return;
            }

            try {
                await window.webrtcClient.initiateCall(targetUser.id.toString(), 'audio');
                showCallInterface('audio', targetUser, 'calling');
            } catch (error) {
                console.error('âŒ å‘èµ·è¯­éŸ³é€šè¯å¤±è´¥:', error);
                alert('å‘èµ·è¯­éŸ³é€šè¯å¤±è´¥: ' + error.message);
            }
        }

        // å‘èµ·è§†é¢‘é€šè¯
        async function startVideoCall() {
            // æ£€æŸ¥WebRTCå®¢æˆ·ç«¯æ˜¯å¦å·²åˆå§‹åŒ–
            if (!window.webrtcClient) {
                console.error('âŒ WebRTCå®¢æˆ·ç«¯æœªåˆå§‹åŒ–');
                alert('WebRTCå®¢æˆ·ç«¯æœªåˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return;
            }

            // ä¼˜å…ˆä½¿ç”¨å½“å‰èŠå¤©ä¼šè¯çš„å¯¹è±¡
            let targetUser = await getCurrentChatUser();

            console.log('å‘èµ·è§†é¢‘é€šè¯ - å½“å‰ç”¨æˆ·:', targetUser);
            console.log('ChatAppçŠ¶æ€:', {
                currentConversationId: ChatApp.currentConversationId,
                conversations: ChatApp.conversations,
                targetUser: ChatApp.targetUser
            });

            if (!targetUser || !targetUser.id) {
                alert('è¯·å…ˆé€‰æ‹©èŠå¤©å¯¹è±¡');
                return;
            }

            try {
                await window.webrtcClient.initiateCall(targetUser.id.toString(), 'video');
                showCallInterface('video', targetUser, 'calling');
            } catch (error) {
                console.error('âŒ å‘èµ·è§†é¢‘é€šè¯å¤±è´¥:', error);
                alert('å‘èµ·è§†é¢‘é€šè¯å¤±è´¥: ' + error.message);
            }
        }

        // è·å–å½“å‰èŠå¤©ç”¨æˆ·
        async function getCurrentChatUser() {
            console.log('getCurrentChatUser è°ƒç”¨');
            console.log('ChatApp.currentConversationId:', ChatApp.currentConversationId);
            console.log('ChatApp.conversations:', ChatApp.conversations);
            console.log('ChatApp.targetUser:', ChatApp.targetUser);

            // æ–¹æ³•1ï¼šå¦‚æœæœ‰å½“å‰æ´»è·ƒçš„èŠå¤©ä¼šè¯ï¼Œä»ä¼šè¯åˆ—è¡¨ä¸­æ‰¾åˆ°å¯¹åº”çš„ä¼šè¯
            if (ChatApp.currentConversationId && ChatApp.conversations) {
                const currentConversation = ChatApp.conversations.find(conv => conv.id === ChatApp.currentConversationId);
                console.log('æ‰¾åˆ°çš„å½“å‰ä¼šè¯:', currentConversation);

                if (currentConversation) {
                    // å¯¹äºç§èŠï¼Œè¿”å›å¯¹æ–¹ç”¨æˆ·ä¿¡æ¯
                    if (currentConversation.type === 'private' && currentConversation.otherUser) {
                        console.log('è¿”å›ç§èŠç”¨æˆ·:', currentConversation.otherUser);
                        return {
                            id: currentConversation.otherUser.id,
                            username: currentConversation.otherUser.username,
                            nickname: currentConversation.otherUser.nickname,
                            avatar: currentConversation.otherUser.avatar
                        };
                    }

                    // å¯¹äºç¾¤èŠï¼Œå¯ä»¥è€ƒè™‘å…¶ä»–é€»è¾‘
                    if (currentConversation.participants && currentConversation.participants.length > 0) {
                        const currentUserId = window.currentUser ? window.currentUser.id : null;
                        const otherParticipant = currentConversation.participants.find(p => p.id !== currentUserId);
                        if (otherParticipant) {
                            console.log('è¿”å›ç¾¤èŠå‚ä¸è€…:', otherParticipant);
                            return otherParticipant;
                        }
                    }
                }
            }

            // æ–¹æ³•2ï¼šå¦‚æœæ²¡æœ‰æ´»è·ƒä¼šè¯ï¼Œä½¿ç”¨é€‰ä¸­çš„ç›®æ ‡ç”¨æˆ·
            if (ChatApp.targetUser && ChatApp.targetUser.id) {
                console.log('è¿”å›ç›®æ ‡ç”¨æˆ·:', ChatApp.targetUser);
                return ChatApp.targetUser;
            }

            // æ–¹æ³•3ï¼šé€šè¿‡APIè·å–ä¼šè¯è¯¦æƒ…
            if (ChatApp.currentConversationId) {
                try {
                    console.log('å°è¯•é€šè¿‡APIè·å–ä¼šè¯è¯¦æƒ…...');
                    const response = await fetch(`/api/chat/conversations/${ChatApp.currentConversationId}/participants`, {
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.success && data.participants) {
                            const currentUserId = window.currentUser ? window.currentUser.id : null;
                            const otherParticipant = data.participants.find(p => p.id !== currentUserId);
                            if (otherParticipant) {
                                console.log('ä»APIè·å–åˆ°çš„ç”¨æˆ·ä¿¡æ¯:', otherParticipant);
                                return otherParticipant;
                            }
                        }
                    }
                } catch (error) {
                    console.error('è·å–ä¼šè¯å‚ä¸è€…å¤±è´¥:', error);
                }
            }

            // æ–¹æ³•4ï¼šä»èŠå¤©ç•Œé¢å¤´éƒ¨è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰
            const chatTitle = document.getElementById('chatTitle');
            if (chatTitle && chatTitle.textContent && chatTitle.textContent !== 'èŠå¤©å¯¹è±¡') {
                console.log('ä½¿ç”¨ä¸´æ—¶æ–¹æ¡ˆ - ç”¨æˆ·å:', chatTitle.textContent);
                // å¯¹äºtestuserï¼Œæˆ‘ä»¬çŸ¥é“IDæ˜¯2
                const userId = chatTitle.textContent === 'testuser' ? 2 : 'testuser';
                return {
                    id: userId,
                    username: chatTitle.textContent,
                    nickname: chatTitle.textContent
                };
            }

            console.log('æœªæ‰¾åˆ°èŠå¤©ç”¨æˆ·');
            return null;
        }

        // æ˜¾ç¤ºé€šè¯ç•Œé¢
        function showCallInterface(callType, user, status) {
            const callOverlay = document.getElementById('callOverlay');
            const videoContainer = document.getElementById('videoCallContainer');
            const audioContainer = document.getElementById('audioCallContainer');
            const incomingCall = document.getElementById('incomingCall');
            const videoBtn = document.getElementById('videoBtn');
            const muteBtn = document.getElementById('muteBtn');

            // æ˜¾ç¤ºé®ç½©å±‚
            callOverlay.classList.add('show');

            // åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
            initializeCallButtons(callType);

            if (callType === 'video') {
                videoContainer.style.display = 'flex';
                audioContainer.style.display = 'none';
                videoBtn.style.display = 'block';
            } else {
                videoContainer.style.display = 'none';
                audioContainer.style.display = 'flex';
                videoBtn.style.display = 'none';

                // è®¾ç½®ç”¨æˆ·ä¿¡æ¯
                document.getElementById('callAvatar').src = user.avatar || '/images/default-avatar.png';
                document.getElementById('callUserName').textContent = user.nickname || user.username;
            }

            incomingCall.style.display = 'none';
            updateCallStatus(status);
        }

        // åˆå§‹åŒ–é€šè¯æŒ‰é’®çŠ¶æ€
        function initializeCallButtons(callType) {
            const muteBtn = document.getElementById('muteBtn');
            const videoBtn = document.getElementById('videoBtn');

            // åˆå§‹åŒ–é™éŸ³æŒ‰é’®ï¼ˆé»˜è®¤éŸ³é¢‘å¼€å¯ï¼‰
            if (muteBtn) {
                muteBtn.classList.remove('active');
                muteBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                muteBtn.title = 'é™éŸ³';
            }

            // åˆå§‹åŒ–è§†é¢‘æŒ‰é’®ï¼ˆé»˜è®¤è§†é¢‘å¼€å¯ï¼‰
            if (videoBtn && callType === 'video') {
                videoBtn.classList.remove('active');
                videoBtn.innerHTML = '<i class="fas fa-video"></i>';
                videoBtn.title = 'å…³é—­æ‘„åƒå¤´';
            }

            console.log('é€šè¯æŒ‰é’®çŠ¶æ€å·²åˆå§‹åŒ–');
        }

        // å¤„ç†æ¥ç”µé‚€è¯·
        function handleCallInvitation(data) {
            console.log('=== æ”¶åˆ°æ¥ç”µé‚€è¯· ===');
            console.log('æ¥ç”µæ•°æ®:', data);

            currentCallData = data;

            // ä¼˜å…ˆä½¿ç”¨å…¨å±€å¼¹æ¡†
            if (window.globalCallPopup && typeof window.globalCallPopup.show === 'function') {
                console.log('ä½¿ç”¨å…¨å±€å¼¹æ¡†æ˜¾ç¤ºæ¥ç”µ');
                try {
                    window.globalCallPopup.show(data);
                    console.log('âœ… å…¨å±€å¼¹æ¡†å·²æ˜¾ç¤º');
                    return;
                } catch (error) {
                    console.error('å…¨å±€å¼¹æ¡†æ˜¾ç¤ºå¤±è´¥:', error);
                    // ç»§ç»­ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
                }
            }

            // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨é¡µé¢æœ¬åœ°å¼¹æ¡†
            console.log('ä½¿ç”¨é¡µé¢æœ¬åœ°å¼¹æ¡†æ˜¾ç¤ºæ¥ç”µ');
            const callOverlay = document.getElementById('callOverlay');
            const incomingCall = document.getElementById('incomingCall');
            const videoContainer = document.getElementById('videoCallContainer');
            const audioContainer = document.getElementById('audioCallContainer');

            console.log('UIå…ƒç´ æ£€æŸ¥:', {
                callOverlay: !!callOverlay,
                incomingCall: !!incomingCall,
                videoContainer: !!videoContainer,
                audioContainer: !!audioContainer
            });

            if (!callOverlay || !incomingCall) {
                console.error('å…³é”®UIå…ƒç´ æœªæ‰¾åˆ°ï¼Œæ— æ³•æ˜¾ç¤ºæ¥ç”µç•Œé¢');
                // æœ€åçš„å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨æµè§ˆå™¨ç¡®è®¤å¯¹è¯æ¡†
                const accept = confirm(`æ”¶åˆ°æ¥è‡ª ${data.callerName || 'æœªçŸ¥ç”¨æˆ·'} çš„${data.callType === 'video' ? 'è§†é¢‘' : 'è¯­éŸ³'}é€šè¯é‚€è¯·ï¼Œæ˜¯å¦æ¥å¬ï¼Ÿ`);
                if (accept) {
                    acceptCall();
                } else {
                    rejectCall();
                }
                return;
            }

            // æ˜¾ç¤ºæ¥ç”µç•Œé¢
            console.log('æ˜¾ç¤ºæ¥ç”µç•Œé¢...');
            callOverlay.classList.add('show');
            incomingCall.style.display = 'flex';
            if (videoContainer) videoContainer.style.display = 'none';
            if (audioContainer) audioContainer.style.display = 'none';

            // è®¾ç½®æ¥ç”µä¿¡æ¯
            const callerName = data.callerName || 'æœªçŸ¥ç”¨æˆ·';
            const callType = data.callType === 'video' ? 'è§†é¢‘é€šè¯' : 'è¯­éŸ³é€šè¯';
            const callerAvatar = data.callerAvatar || '/images/default-avatar.png';

            console.log('è®¾ç½®æ¥ç”µä¿¡æ¯:', { callerName, callType, callerAvatar });

            document.getElementById('incomingCallName').textContent = callerName;
            document.getElementById('incomingCallType').textContent = callType;
            document.getElementById('incomingCallAvatar').src = callerAvatar;

            console.log('æ¥ç”µç•Œé¢å·²æ˜¾ç¤º');
        }

        // æ¥å¬é€šè¯
        function acceptCall() {
            console.log('æ¥å¬é€šè¯ï¼Œå½“å‰é€šè¯æ•°æ®:', currentCallData);
            
            // éšè—å…¨å±€å¼¹æ¡†
            if (window.globalCallPopup && window.globalCallPopup.isVisible()) {
                window.globalCallPopup.hide();
            }
            
            if (currentCallData && window.webrtcClient) {
                window.webrtcClient.acceptCall(currentCallData.roomId);
                showCallInterface(currentCallData.callType, currentCallData, 'connecting');
                startCallTimer();
            } else {
                console.error('âŒ WebRTCå®¢æˆ·ç«¯æœªåˆå§‹åŒ–æˆ–é€šè¯æ•°æ®ç¼ºå¤±');
                alert('æ— æ³•æ¥å¬é€šè¯ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        }

        // æ‹’ç»é€šè¯
        function rejectCall() {
            console.log('æ‹’ç»é€šè¯ï¼Œå½“å‰é€šè¯æ•°æ®:', currentCallData);
            
            // éšè—å…¨å±€å¼¹æ¡†
            if (window.globalCallPopup && window.globalCallPopup.isVisible()) {
                window.globalCallPopup.hide();
            }
            
            if (currentCallData && window.webrtcClient) {
                window.webrtcClient.rejectCall(currentCallData.roomId);
                hideCallInterface();
            } else {
                console.error('âŒ WebRTCå®¢æˆ·ç«¯æœªåˆå§‹åŒ–æˆ–é€šè¯æ•°æ®ç¼ºå¤±');
                hideCallInterface();
            }
        }

        // å°†å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸï¼Œä¾›å…¨å±€å¼¹æ¡†è°ƒç”¨
        window.acceptCall = acceptCall;
        window.rejectCall = rejectCall;

        // æŒ‚æ–­é€šè¯
        function endCall() {
            if (window.webrtcClient) {
                window.webrtcClient.endCall();
            } else {
                console.error('âŒ WebRTCå®¢æˆ·ç«¯æœªåˆå§‹åŒ–');
            }
            hideCallInterface();
        }

        // éšè—é€šè¯ç•Œé¢
        function hideCallInterface() {
            const callOverlay = document.getElementById('callOverlay');
            callOverlay.classList.remove('show');

            stopCallTimer();
            currentCallData = null;

            // åœæ­¢æœ¬åœ°è§†é¢‘æµ
            const localVideo = document.getElementById('localVideo');
            if (localVideo.srcObject) {
                localVideo.srcObject.getTracks().forEach(track => track.stop());
                localVideo.srcObject = null;
            }

            // æ¸…ç©ºè¿œç¨‹è§†é¢‘æµ
            const remoteVideo = document.getElementById('remoteVideo');
            if (remoteVideo.srcObject) {
                remoteVideo.srcObject = null;
            }
        }

        // åˆ‡æ¢é™éŸ³ - ä½¿ç”¨call-ui.jsä¸­çš„å¼‚æ­¥ç‰ˆæœ¬
        // è¿™ä¸ªå‡½æ•°å·²åœ¨call-ui.jsä¸­å®šä¹‰ï¼Œè¿™é‡Œä¸éœ€è¦é‡å¤å®šä¹‰

        // åˆ‡æ¢è§†é¢‘ - ä½¿ç”¨call-ui.jsä¸­çš„å¼‚æ­¥ç‰ˆæœ¬
        // è¿™ä¸ªå‡½æ•°å·²åœ¨call-ui.jsä¸­å®šä¹‰ï¼Œè¿™é‡Œä¸éœ€è¦é‡å¤å®šä¹‰
    </script>

    <!-- ä¼šè¯å³é”®èœå• -->
    <div id="conversationContextMenu" class="context-menu" style="display: none;">
        <div class="context-menu-item" onclick="openConversation()">
            <i class="fas fa-comment me-2"></i>æ‰“å¼€ä¼šè¯
        </div>
        <div class="context-menu-item" onclick="pinConversationFromContext()">
            <i class="fas fa-thumbtack me-2"></i>ç½®é¡¶ä¼šè¯
        </div>
        <div class="context-menu-item" onclick="muteConversationFromContext()">
            <i class="fas fa-volume-mute me-2"></i>é™éŸ³é€šçŸ¥
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item text-warning" onclick="clearChatMessagesFromContext()">
            <i class="fas fa-broom me-2"></i>æ¸…ç©ºèŠå¤©è®°å½•
        </div>
        <div class="context-menu-item text-info" onclick="unfollowUserFromContext()">
            <i class="fas fa-user-minus me-2"></i>å–æ¶ˆå…³æ³¨
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item text-danger" onclick="deleteConversationFromContext()">
            <i class="fas fa-trash me-2"></i>åˆ é™¤ä¼šè¯
        </div>
    </div>
</body>
</html>
