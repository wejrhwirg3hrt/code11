<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ËÅäÂ§© - ËßÜÈ¢ëÂàÜ‰∫´Âπ≥Âè∞</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/css/chat.css" rel="stylesheet">
    <link href="/css/webrtc-call.css" rel="stylesheet">
</head>
<body>
    <!-- ÂØºËà™Ê†è -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-video me-2"></i>ËßÜÈ¢ëÂàÜ‰∫´Âπ≥Âè∞
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">
                    <i class="fas fa-home me-1"></i>È¶ñÈ°µ
                </a>
                <a class="nav-link active" href="/chat">
                    <i class="fas fa-comments me-1"></i>ËÅäÂ§©
                    <span class="badge bg-danger ms-1" id="totalUnreadCount" style="display: none;">0</span>
                </a>

                <div class="nav-item dropdown" th:if="${currentUser != null and currentUser.username != null}">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <img th:src="${currentUser.avatar ?: '/images/default-avatar.png'}" alt="Â§¥ÂÉè" class="rounded-circle me-1" width="24" height="24">
                        <span th:text="${currentUser.username}">Áî®Êà∑Âêç</span>
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="/profile">‰∏™‰∫∫ËµÑÊñô</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="/logout">ÈÄÄÂá∫ÁôªÂΩï</a></li>
                    </ul>
                </div>
                <!-- Êú™ÁôªÂΩïÁî®Êà∑ÊòæÁ§∫ÁôªÂΩïÊåâÈíÆ -->
                <div class="nav-item" th:if="${currentUser == null}">
                    <a class="nav-link" href="/login">
                        <i class="fas fa-sign-in-alt me-1"></i>ÁôªÂΩï
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- ËÅäÂ§©‰∏ªÁïåÈù¢ -->
    <div class="container-fluid chat-container">
        <div class="row h-100">
            <!-- ‰ºöËØùÂàóË°® -->
            <div class="col-md-4 col-lg-3 chat-sidebar">
                <div class="chat-header">
                    <h5 class="mb-0">
                        <i class="fas fa-comments me-2"></i>ËÅäÂ§©
                    </h5>
                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#newChatModal">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                
                <!-- ÊêúÁ¥¢Ê°Ü -->
                <div class="search-box">
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" class="form-control" placeholder="ÊêúÁ¥¢‰ºöËØù..." id="searchInput">
                    </div>
                </div>

                <!-- ‰ºöËØùÂàóË°® -->
                <div class="conversation-list" id="conversationList">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-comments fa-3x mb-3"></i>
                        <p>ÊöÇÊó†‰ºöËØù</p>
                        <p class="small">ÁÇπÂáªÂè≥‰∏äËßíÁöÑ + Âè∑ÂºÄÂßãÊñ∞ÁöÑËÅäÂ§©</p>
                    </div>
                </div>
            </div>

            <!-- ËÅäÂ§©Âå∫Âüü -->
            <div class="col-md-8 col-lg-9 chat-main" id="chatMain">
                <!-- Ê¨¢ËøéÁïåÈù¢ -->
                <div class="chat-welcome" id="chatWelcome">
                    <div class="text-center">
                        <i class="fas fa-comments fa-4x text-muted mb-4"></i>
                        <h4 class="text-muted">Ê¨¢Ëøé‰ΩøÁî®ËÅäÂ§©ÂäüËÉΩ</h4>
                        <p class="text-muted">ÈÄâÊã©‰∏Ä‰∏™‰ºöËØùÂºÄÂßãËÅäÂ§©ÔºåÊàñÂàõÂª∫Êñ∞ÁöÑ‰ºöËØù</p>
                    </div>
                </div>

                <!-- ËÅäÂ§©ÁïåÈù¢ -->
                <div class="chat-interface" id="chatInterface" style="display: none;">
                    <!-- ËÅäÂ§©Â§¥ÈÉ® -->
                    <div class="chat-conversation-header">
                        <div class="d-flex align-items-center">
                            <img id="chatAvatar" src="/images/default-avatar.png" alt="Â§¥ÂÉè" class="rounded-circle me-3" width="40" height="40">
                            <div>
                                <h6 class="mb-0" id="chatTitle">ËÅäÂ§©ÂØπË±°</h6>
                                <small class="text-muted" id="chatStatus">Âú®Á∫ø</small>
                            </div>
                        </div>
                        <div class="chat-actions" id="chatActions" style="display: none;">
                            <button class="btn btn-sm btn-outline-secondary me-2" onclick="startAudioCall()" title="ËØ≠Èü≥ÈÄöËØù">
                                <i class="fas fa-phone"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary me-2" onclick="startVideoCall()" title="ËßÜÈ¢ëÈÄöËØù">
                                <i class="fas fa-video"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Ê∂àÊÅØÂå∫Âüü -->
                    <div class="messages-container" id="messagesContainer">
                        <div class="messages-list" id="messagesList">
                            <!-- Ê∂àÊÅØÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
                        </div>
                        <!-- ÊªöÂä®Âà∞Â∫ïÈÉ®ÊåâÈíÆ -->
                        <div class="scroll-to-bottom-btn" id="scrollToBottomBtn" style="display: none;">
                            <button class="btn btn-primary btn-sm rounded-circle" onclick="ChatApp.scrollToLatestMessage(true)" title="ÊªöÂä®Âà∞ÊúÄÊñ∞Ê∂àÊÅØ">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Êñá‰ª∂È¢ÑËßàÂå∫Âüü -->
                    <div class="file-preview-area" id="filePreviewArea" style="display: none;">
                        <div class="file-preview-content">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-muted">ÂáÜÂ§áÂèëÈÄÅÁöÑÊñá‰ª∂Ôºö</span>
                                <button class="btn btn-sm btn-outline-danger" onclick="clearFilePreview()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div id="filePreviewList">
                                <!-- Êñá‰ª∂È¢ÑËßàÈ°πÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
                            </div>
                        </div>
                    </div>

                    <!-- ËæìÂÖ•Âå∫Âüü -->
                    <div class="message-input-area" id="messageInputArea">
                        <div class="input-toolbar">
                            <button class="btn btn-sm btn-outline-secondary" title="Ë°®ÊÉÖ" onclick="toggleEmojiPicker()">
                                <i class="fas fa-smile"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" title="ÂõæÁâá" onclick="selectFile('image')">
                                <i class="fas fa-image"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" title="Êñá‰ª∂" onclick="selectFile('file')">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" title="ËßÜÈ¢ë" onclick="selectFile('video')">
                                <i class="fas fa-video"></i>
                            </button>
                            <!-- ÊµãËØïÊåâÈíÆ -->
                            <button class="btn btn-sm btn-outline-info" title="Âà∑Êñ∞Âú®Á∫øÁä∂ÊÄÅ" onclick="ChatApp.updateAllUsersOnlineStatus()">
                                <i class="fas fa-sync"></i>
                            </button>
                        </div>

                        <div class="input-group">
                            <textarea class="form-control" id="messageInput" placeholder="ËæìÂÖ•Ê∂àÊÅØ..." rows="1"
                                      onkeydown="handleMessageInput(event)" oninput="autoResize(this)"></textarea>
                            <button class="btn btn-primary" id="sendButton" onclick="sendMessage()">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ë°®ÊÉÖÈÄâÊã©Âô® -->
    <div class="emoji-picker" id="emojiPicker" style="display: none;">
        <div class="emoji-categories">
            <button class="emoji-category active" data-category="faces">üòä</button>
            <button class="emoji-category" data-category="gestures">üëç</button>
            <button class="emoji-category" data-category="hearts">‚ù§Ô∏è</button>
            <button class="emoji-category" data-category="animals">üê±</button>
        </div>
        <div class="emoji-grid" id="emojiGrid">
            <!-- Ë°®ÊÉÖÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÂä†ËΩΩ -->
        </div>
    </div>

    <!-- Êñá‰ª∂ËæìÂÖ• -->
    <input type="file" id="fileInput" style="display: none;" multiple accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.txt,.zip,.rar">

    <!-- WebRTCÈÄöËØùÁïåÈù¢ -->
    <div class="call-overlay" id="callOverlay">
        <div class="call-container">
            <!-- ËøûÊé•Áä∂ÊÄÅÊåáÁ§∫Âô® -->
            <div class="connection-status" id="connectionStatus">ËøûÊé•‰∏≠...</div>

            <!-- ËßÜÈ¢ëÈÄöËØùÁïåÈù¢ -->
            <div class="video-call-container" id="videoCallContainer" style="display: none;">
                <video id="remoteVideo" class="remote-video" autoplay playsinline></video>
                <video id="localVideo" class="local-video" autoplay playsinline muted></video>
            </div>

            <!-- ËØ≠Èü≥ÈÄöËØùÁïåÈù¢ -->
            <div class="audio-call-container" id="audioCallContainer" style="display: none;">
                <img id="callAvatar" class="call-avatar" src="/images/default-avatar.png" alt="Áî®Êà∑Â§¥ÂÉè">
                <div class="call-user-info">
                    <div class="call-user-name" id="callUserName">Áî®Êà∑Âêç</div>
                    <div class="call-status" id="callStatus">ËøûÊé•‰∏≠...</div>
                    <div class="call-duration" id="callDuration">00:00</div>
                </div>
            </div>

            <!-- Êù•ÁîµÁïåÈù¢ -->
            <div class="incoming-call" id="incomingCall" style="display: none;">
                <img id="incomingCallAvatar" class="incoming-call-avatar" src="/images/default-avatar.png" alt="Áî®Êà∑Â§¥ÂÉè">
                <div class="incoming-call-info">
                    <div class="incoming-call-name" id="incomingCallName">Áî®Êà∑Âêç</div>
                    <div class="incoming-call-type" id="incomingCallType">ËØ≠Èü≥ÈÄöËØù</div>
                </div>
                <div class="incoming-call-controls">
                    <button class="call-control-btn btn-reject" onclick="rejectCall()" title="ÊãíÁªù">
                        <i class="fas fa-phone-slash"></i>
                    </button>
                    <button class="call-control-btn btn-answer" onclick="acceptCall()" title="Êé•Âê¨">
                        <i class="fas fa-phone"></i>
                    </button>
                </div>
            </div>

            <!-- ÈÄöËØùÊéßÂà∂Ê†è -->
            <div class="call-controls" id="callControls">
                <button class="call-control-btn btn-mute" id="muteBtn" onclick="toggleMute()" title="ÈùôÈü≥">
                    <i class="fas fa-microphone"></i>
                </button>
                <button class="call-control-btn btn-video" id="videoBtn" onclick="toggleVideo()" title="ÊëÑÂÉèÂ§¥" style="display: none;">
                    <i class="fas fa-video"></i>
                </button>
                <button class="call-control-btn btn-hangup" onclick="endCall()" title="ÊåÇÊñ≠">
                    <i class="fas fa-phone-slash"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Êñ∞Âª∫ËÅäÂ§©Ê®°ÊÄÅÊ°Ü -->
    <div class="modal fade" id="newChatModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Êñ∞Âª∫ËÅäÂ§©</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">ÊêúÁ¥¢Áî®Êà∑</label>
                        <input type="text" class="form-control" id="userSearchInput" placeholder="ËæìÂÖ•Áî®Êà∑ÂêçÊêúÁ¥¢...">
                    </div>
                    <div id="userSearchResults" class="user-search-results">
                        <!-- ÊêúÁ¥¢ÁªìÊûúÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
                    </div>
                </div>
            </div>
        </div>
    </div>



    <!-- ËÑöÊú¨ -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/lib/sockjs.min.js"></script>
    <script src="/lib/stomp.min.js"></script>
    <script src="/js/global-call-popup.js"></script>
    <script src="/js/avatar-sync.js"></script>
    <script src="/js/chat.js?v=20250821-2"></script>
    <script src="/js/webrtc-client.js"></script>
    <script src="/js/global-webrtc-manager.js"></script>
    <script src="/js/call-ui.js"></script>

    <!-- Áî®Êà∑‰ø°ÊÅØ‰º†ÈÄí -->
    <script th:inline="javascript">
        window.currentUser = /*[[${currentUser}]]*/ null;
        window.isAuthenticated = /*[[${isAuthenticated}]]*/ false;
        console.log('Áî®Êà∑‰ø°ÊÅØ‰º†ÈÄí:', window.currentUser);
        console.log('ËÆ§ËØÅÁä∂ÊÄÅ:', window.isAuthenticated);
    </script>

    <script>
        // ÂàùÂßãÂåñËÅäÂ§©È°µÈù¢
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ËÅäÂ§©‰∏ªÈ°µ - ÂΩìÂâçÁî®Êà∑‰ø°ÊÅØ:', window.currentUser);
            console.log('ËÆ§ËØÅÁä∂ÊÄÅ:', window.isAuthenticated);

            // Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶Â∑≤ÁôªÂΩï
            if (!window.currentUser || !window.currentUser.id) {
                console.warn('Áî®Êà∑Êú™ÁôªÂΩïÔºåÈáçÂÆöÂêëÂà∞ÁôªÂΩïÈ°µÈù¢');
                window.location.href = '/auth/login';
                return;
            }

            // ÂàùÂßãÂåñËÅäÂ§©ÂäüËÉΩ
            if (typeof ChatApp !== 'undefined') {
                ChatApp.init();
            } else {
                console.error('ChatApp Êú™ÂÆö‰πâ');
            }

            // ÂàùÂßãÂåñWebRTCÂÆ¢Êà∑Á´Ø
            if (window.currentUser && window.currentUser.id) {
                initializeWebRTC();
            }

            // ÁõëÂê¨Êñ∞Âª∫ËÅäÂ§©Ê®°ÊÄÅÊ°ÜÊòæÁ§∫‰∫ã‰ª∂
            const newChatModal = document.getElementById('newChatModal');
            if (newChatModal) {
                newChatModal.addEventListener('shown.bs.modal', function() {
                    // Ê®°ÊÄÅÊ°ÜÊòæÁ§∫Êó∂Ëá™Âä®Âä†ËΩΩÊâÄÊúâÁî®Êà∑
                    if (typeof ChatApp !== 'undefined') {
                        ChatApp.searchUsers(''); // Á©∫ÊêúÁ¥¢‰ºöËøîÂõûÊâÄÊúâÁî®Êà∑
                    }
                });

                // Ê®°ÊÄÅÊ°ÜÈöêËóèÊó∂Ê∏ÖÁ©∫ÊêúÁ¥¢ÁªìÊûú
                newChatModal.addEventListener('hidden.bs.modal', function() {
                    document.getElementById('userSearchInput').value = '';
                    document.getElementById('userSearchResults').innerHTML = '';
                });
            }
        });

        // WebRTCÁõ∏ÂÖ≥ÂèòÈáèÔºàËøô‰∫õÂèòÈáèÂú®call-ui.js‰∏≠Â∑≤Â£∞ÊòéÔºåËøôÈáå‰∏çÈúÄË¶ÅÈáçÂ§çÂ£∞ÊòéÔºâ

        // ÂàùÂßãÂåñWebRTC
        async function initializeWebRTC() {
            try {
                // Ê£ÄÊü•SockJSÂíåStompÊòØÂê¶ÂèØÁî®
                if (typeof SockJS === 'undefined') {
                    console.error('SockJSÂ∫ìÊú™Âä†ËΩΩ');
                    return;
                }
                if (typeof Stomp === 'undefined') {
                    console.error('StompÂ∫ìÊú™Âä†ËΩΩ');
                    return;
                }

                // Ê£ÄÊü•GlobalWebRTCManagerÁ±ªÊòØÂê¶Â≠òÂú®
                if (typeof GlobalWebRTCManager === 'undefined') {
                    console.error('GlobalWebRTCManagerÁ±ªÊú™ÂÆö‰πâÔºåËØ∑Ê£ÄÊü•global-webrtc-manager.jsÊòØÂê¶Ê≠£Á°ÆÂä†ËΩΩ');
                    return;
                }

                // ÂàõÂª∫ÂÖ®Â±ÄWebRTCÁÆ°ÁêÜÂô®ÂÆû‰æã
                if (!window.globalWebRTCManager) {
                    window.globalWebRTCManager = new GlobalWebRTCManager('chat');
                    console.log('ËÅäÂ§©È°µÈù¢ÂÖ®Â±ÄWebRTCÁÆ°ÁêÜÂô®Â∑≤ÂàõÂª∫');
                }

                await window.globalWebRTCManager.initialize();

                // Ê£ÄÊü•WebRTCÂÆ¢Êà∑Á´ØÊòØÂê¶ÊàêÂäüÂàõÂª∫
                if (!window.webrtcClient) {
                    throw new Error('WebRTCÂÆ¢Êà∑Á´ØÂàõÂª∫Â§±Ë¥•');
                }

                // ËÆæÁΩÆ‰∫ã‰ª∂ÂõûË∞É
                window.webrtcClient.onCallInvitation = handleCallInvitation;
                window.webrtcClient.onCallAccepted = handleCallAccepted;
                window.webrtcClient.onCallRejected = handleCallRejected;
                window.webrtcClient.onCallEnded = handleCallEnded;
                window.webrtcClient.onRemoteStream = handleRemoteStream;
                window.webrtcClient.onConnectionStateChange = handleConnectionStateChange;

                console.log('‚úÖ WebRTCÂÆ¢Êà∑Á´ØÂàùÂßãÂåñÊàêÂäü');
            } catch (error) {
                console.error('WebRTCÂÆ¢Êà∑Á´ØÂàùÂßãÂåñÂ§±Ë¥•:', error);
            }
        }

        // ÂèëËµ∑ËØ≠Èü≥ÈÄöËØù
        async function startAudioCall() {
            // Ê£ÄÊü•WebRTCÂÆ¢Êà∑Á´ØÊòØÂê¶Â∑≤ÂàùÂßãÂåñ
            if (!window.webrtcClient) {
                console.error('‚ùå WebRTCÂÆ¢Êà∑Á´ØÊú™ÂàùÂßãÂåñ');
                alert('WebRTCÂÆ¢Êà∑Á´ØÊú™ÂàùÂßãÂåñÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
                return;
            }

            // ‰ºòÂÖà‰ΩøÁî®ÂΩìÂâçËÅäÂ§©‰ºöËØùÁöÑÂØπË±°
            let targetUser = await getCurrentChatUser();

            if (!targetUser || !targetUser.id) {
                alert('ËØ∑ÂÖàÈÄâÊã©ËÅäÂ§©ÂØπË±°');
                return;
            }

            try {
                await window.webrtcClient.initiateCall(targetUser.id.toString(), 'audio');
                showCallInterface('audio', targetUser, 'calling');
            } catch (error) {
                console.error('‚ùå ÂèëËµ∑ËØ≠Èü≥ÈÄöËØùÂ§±Ë¥•:', error);
                alert('ÂèëËµ∑ËØ≠Èü≥ÈÄöËØùÂ§±Ë¥•: ' + error.message);
            }
        }

        // ÂèëËµ∑ËßÜÈ¢ëÈÄöËØù
        async function startVideoCall() {
            // Ê£ÄÊü•WebRTCÂÆ¢Êà∑Á´ØÊòØÂê¶Â∑≤ÂàùÂßãÂåñ
            if (!window.webrtcClient) {
                console.error('‚ùå WebRTCÂÆ¢Êà∑Á´ØÊú™ÂàùÂßãÂåñ');
                alert('WebRTCÂÆ¢Êà∑Á´ØÊú™ÂàùÂßãÂåñÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
                return;
            }

            // ‰ºòÂÖà‰ΩøÁî®ÂΩìÂâçËÅäÂ§©‰ºöËØùÁöÑÂØπË±°
            let targetUser = await getCurrentChatUser();

            console.log('ÂèëËµ∑ËßÜÈ¢ëÈÄöËØù - ÂΩìÂâçÁî®Êà∑:', targetUser);
            console.log('ChatAppÁä∂ÊÄÅ:', {
                currentConversationId: ChatApp.currentConversationId,
                conversations: ChatApp.conversations,
                targetUser: ChatApp.targetUser
            });

            if (!targetUser || !targetUser.id) {
                alert('ËØ∑ÂÖàÈÄâÊã©ËÅäÂ§©ÂØπË±°');
                return;
            }

            try {
                await window.webrtcClient.initiateCall(targetUser.id.toString(), 'video');
                showCallInterface('video', targetUser, 'calling');
            } catch (error) {
                console.error('‚ùå ÂèëËµ∑ËßÜÈ¢ëÈÄöËØùÂ§±Ë¥•:', error);
                alert('ÂèëËµ∑ËßÜÈ¢ëÈÄöËØùÂ§±Ë¥•: ' + error.message);
            }
        }

        // Ëé∑ÂèñÂΩìÂâçËÅäÂ§©Áî®Êà∑
        async function getCurrentChatUser() {
            console.log('getCurrentChatUser Ë∞ÉÁî®');
            console.log('ChatApp.currentConversationId:', ChatApp.currentConversationId);
            console.log('ChatApp.conversations:', ChatApp.conversations);
            console.log('ChatApp.targetUser:', ChatApp.targetUser);

            // ÊñπÊ≥ï1ÔºöÂ¶ÇÊûúÊúâÂΩìÂâçÊ¥ªË∑ÉÁöÑËÅäÂ§©‰ºöËØùÔºå‰ªé‰ºöËØùÂàóË°®‰∏≠ÊâæÂà∞ÂØπÂ∫îÁöÑ‰ºöËØù
            if (ChatApp.currentConversationId && ChatApp.conversations) {
                const currentConversation = ChatApp.conversations.find(conv => conv.id === ChatApp.currentConversationId);
                console.log('ÊâæÂà∞ÁöÑÂΩìÂâç‰ºöËØù:', currentConversation);

                if (currentConversation) {
                    // ÂØπ‰∫éÁßÅËÅäÔºåËøîÂõûÂØπÊñπÁî®Êà∑‰ø°ÊÅØ
                    if (currentConversation.type === 'private' && currentConversation.otherUser) {
                        console.log('ËøîÂõûÁßÅËÅäÁî®Êà∑:', currentConversation.otherUser);
                        return {
                            id: currentConversation.otherUser.id,
                            username: currentConversation.otherUser.username,
                            nickname: currentConversation.otherUser.nickname,
                            avatar: currentConversation.otherUser.avatar
                        };
                    }

                    // ÂØπ‰∫éÁæ§ËÅäÔºåÂèØ‰ª•ËÄÉËôëÂÖ∂‰ªñÈÄªËæë
                    if (currentConversation.participants && currentConversation.participants.length > 0) {
                        const currentUserId = window.currentUser ? window.currentUser.id : null;
                        const otherParticipant = currentConversation.participants.find(p => p.id !== currentUserId);
                        if (otherParticipant) {
                            console.log('ËøîÂõûÁæ§ËÅäÂèÇ‰∏éËÄÖ:', otherParticipant);
                            return otherParticipant;
                        }
                    }
                }
            }

            // ÊñπÊ≥ï2ÔºöÂ¶ÇÊûúÊ≤°ÊúâÊ¥ªË∑É‰ºöËØùÔºå‰ΩøÁî®ÈÄâ‰∏≠ÁöÑÁõÆÊ†áÁî®Êà∑
            if (ChatApp.targetUser && ChatApp.targetUser.id) {
                console.log('ËøîÂõûÁõÆÊ†áÁî®Êà∑:', ChatApp.targetUser);
                return ChatApp.targetUser;
            }

            // ÊñπÊ≥ï3ÔºöÈÄöËøáAPIËé∑Âèñ‰ºöËØùËØ¶ÊÉÖ
            if (ChatApp.currentConversationId) {
                try {
                    console.log('Â∞ùËØïÈÄöËøáAPIËé∑Âèñ‰ºöËØùËØ¶ÊÉÖ...');
                    const response = await fetch(`/api/chat/conversations/${ChatApp.currentConversationId}/participants`, {
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.success && data.participants) {
                            const currentUserId = window.currentUser ? window.currentUser.id : null;
                            const otherParticipant = data.participants.find(p => p.id !== currentUserId);
                            if (otherParticipant) {
                                console.log('‰ªéAPIËé∑ÂèñÂà∞ÁöÑÁî®Êà∑‰ø°ÊÅØ:', otherParticipant);
                                return otherParticipant;
                            }
                        }
                    }
                } catch (error) {
                    console.error('Ëé∑Âèñ‰ºöËØùÂèÇ‰∏éËÄÖÂ§±Ë¥•:', error);
                }
            }

            // ÊñπÊ≥ï4Ôºö‰ªéËÅäÂ§©ÁïåÈù¢Â§¥ÈÉ®Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØÔºà‰∏¥Êó∂ÊñπÊ°àÔºâ
            const chatTitle = document.getElementById('chatTitle');
            if (chatTitle && chatTitle.textContent && chatTitle.textContent !== 'ËÅäÂ§©ÂØπË±°') {
                console.log('‰ΩøÁî®‰∏¥Êó∂ÊñπÊ°à - Áî®Êà∑Âêç:', chatTitle.textContent);
                // ÂØπ‰∫étestuserÔºåÊàë‰ª¨Áü•ÈÅìIDÊòØ2
                const userId = chatTitle.textContent === 'testuser' ? 2 : 'testuser';
                return {
                    id: userId,
                    username: chatTitle.textContent,
                    nickname: chatTitle.textContent
                };
            }

            console.log('Êú™ÊâæÂà∞ËÅäÂ§©Áî®Êà∑');
            return null;
        }

        // ÊòæÁ§∫ÈÄöËØùÁïåÈù¢
        function showCallInterface(callType, user, status) {
            const callOverlay = document.getElementById('callOverlay');
            const videoContainer = document.getElementById('videoCallContainer');
            const audioContainer = document.getElementById('audioCallContainer');
            const incomingCall = document.getElementById('incomingCall');
            const videoBtn = document.getElementById('videoBtn');
            const muteBtn = document.getElementById('muteBtn');

            // ÊòæÁ§∫ÈÅÆÁΩ©Â±Ç
            callOverlay.classList.add('show');

            // ÂàùÂßãÂåñÊåâÈíÆÁä∂ÊÄÅ
            initializeCallButtons(callType);

            if (callType === 'video') {
                videoContainer.style.display = 'flex';
                audioContainer.style.display = 'none';
                videoBtn.style.display = 'block';
            } else {
                videoContainer.style.display = 'none';
                audioContainer.style.display = 'flex';
                videoBtn.style.display = 'none';

                // ËÆæÁΩÆÁî®Êà∑‰ø°ÊÅØ
                document.getElementById('callAvatar').src = user.avatar || '/images/default-avatar.png';
                document.getElementById('callUserName').textContent = user.nickname || user.username;
            }

            incomingCall.style.display = 'none';
            updateCallStatus(status);
        }

        // ÂàùÂßãÂåñÈÄöËØùÊåâÈíÆÁä∂ÊÄÅ
        function initializeCallButtons(callType) {
            const muteBtn = document.getElementById('muteBtn');
            const videoBtn = document.getElementById('videoBtn');

            // ÂàùÂßãÂåñÈùôÈü≥ÊåâÈíÆÔºàÈªòËÆ§Èü≥È¢ëÂºÄÂêØÔºâ
            if (muteBtn) {
                muteBtn.classList.remove('active');
                muteBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                muteBtn.title = 'ÈùôÈü≥';
            }

            // ÂàùÂßãÂåñËßÜÈ¢ëÊåâÈíÆÔºàÈªòËÆ§ËßÜÈ¢ëÂºÄÂêØÔºâ
            if (videoBtn && callType === 'video') {
                videoBtn.classList.remove('active');
                videoBtn.innerHTML = '<i class="fas fa-video"></i>';
                videoBtn.title = 'ÂÖ≥Èó≠ÊëÑÂÉèÂ§¥';
            }

            console.log('ÈÄöËØùÊåâÈíÆÁä∂ÊÄÅÂ∑≤ÂàùÂßãÂåñ');
        }

        // Â§ÑÁêÜÊù•ÁîµÈÇÄËØ∑
        function handleCallInvitation(data) {
            console.log('=== Êî∂Âà∞Êù•ÁîµÈÇÄËØ∑ ===');
            console.log('Êù•ÁîµÊï∞ÊçÆ:', data);

            currentCallData = data;

            // ‰ºòÂÖà‰ΩøÁî®ÂÖ®Â±ÄÂºπÊ°Ü
            if (window.globalCallPopup && typeof window.globalCallPopup.show === 'function') {
                console.log('‰ΩøÁî®ÂÖ®Â±ÄÂºπÊ°ÜÊòæÁ§∫Êù•Áîµ');
                try {
                    window.globalCallPopup.show(data);
                    console.log('‚úÖ ÂÖ®Â±ÄÂºπÊ°ÜÂ∑≤ÊòæÁ§∫');
                    return;
                } catch (error) {
                    console.error('ÂÖ®Â±ÄÂºπÊ°ÜÊòæÁ§∫Â§±Ë¥•:', error);
                    // ÁªßÁª≠‰ΩøÁî®Â§áÁî®ÊñπÊ°à
                }
            }

            // Â§áÁî®ÊñπÊ°àÔºö‰ΩøÁî®È°µÈù¢Êú¨Âú∞ÂºπÊ°Ü
            console.log('‰ΩøÁî®È°µÈù¢Êú¨Âú∞ÂºπÊ°ÜÊòæÁ§∫Êù•Áîµ');
            const callOverlay = document.getElementById('callOverlay');
            const incomingCall = document.getElementById('incomingCall');
            const videoContainer = document.getElementById('videoCallContainer');
            const audioContainer = document.getElementById('audioCallContainer');

            console.log('UIÂÖÉÁ¥†Ê£ÄÊü•:', {
                callOverlay: !!callOverlay,
                incomingCall: !!incomingCall,
                videoContainer: !!videoContainer,
                audioContainer: !!audioContainer
            });

            if (!callOverlay || !incomingCall) {
                console.error('ÂÖ≥ÈîÆUIÂÖÉÁ¥†Êú™ÊâæÂà∞ÔºåÊó†Ê≥ïÊòæÁ§∫Êù•ÁîµÁïåÈù¢');
                // ÊúÄÂêéÁöÑÂ§áÁî®ÊñπÊ°àÔºö‰ΩøÁî®ÊµèËßàÂô®Á°ÆËÆ§ÂØπËØùÊ°Ü
                const accept = confirm(`Êî∂Âà∞Êù•Ëá™ ${data.callerName || 'Êú™Áü•Áî®Êà∑'} ÁöÑ${data.callType === 'video' ? 'ËßÜÈ¢ë' : 'ËØ≠Èü≥'}ÈÄöËØùÈÇÄËØ∑ÔºåÊòØÂê¶Êé•Âê¨Ôºü`);
                if (accept) {
                    acceptCall();
                } else {
                    rejectCall();
                }
                return;
            }

            // ÊòæÁ§∫Êù•ÁîµÁïåÈù¢
            console.log('ÊòæÁ§∫Êù•ÁîµÁïåÈù¢...');
            callOverlay.classList.add('show');
            incomingCall.style.display = 'flex';
            if (videoContainer) videoContainer.style.display = 'none';
            if (audioContainer) audioContainer.style.display = 'none';

            // ËÆæÁΩÆÊù•Áîµ‰ø°ÊÅØ
            const callerName = data.callerName || 'Êú™Áü•Áî®Êà∑';
            const callType = data.callType === 'video' ? 'ËßÜÈ¢ëÈÄöËØù' : 'ËØ≠Èü≥ÈÄöËØù';
            const callerAvatar = data.callerAvatar || '/images/default-avatar.png';

            console.log('ËÆæÁΩÆÊù•Áîµ‰ø°ÊÅØ:', { callerName, callType, callerAvatar });

            document.getElementById('incomingCallName').textContent = callerName;
            document.getElementById('incomingCallType').textContent = callType;
            document.getElementById('incomingCallAvatar').src = callerAvatar;

            console.log('Êù•ÁîµÁïåÈù¢Â∑≤ÊòæÁ§∫');
        }

        // Êé•Âê¨ÈÄöËØù
        function acceptCall() {
            console.log('Êé•Âê¨ÈÄöËØùÔºåÂΩìÂâçÈÄöËØùÊï∞ÊçÆ:', currentCallData);
            
            // ÈöêËóèÂÖ®Â±ÄÂºπÊ°Ü
            if (window.globalCallPopup && window.globalCallPopup.isVisible()) {
                window.globalCallPopup.hide();
            }
            
            if (currentCallData && window.webrtcClient) {
                window.webrtcClient.acceptCall(currentCallData.roomId);
                showCallInterface(currentCallData.callType, currentCallData, 'connecting');
                startCallTimer();
            } else {
                console.error('‚ùå WebRTCÂÆ¢Êà∑Á´ØÊú™ÂàùÂßãÂåñÊàñÈÄöËØùÊï∞ÊçÆÁº∫Â§±');
                alert('Êó†Ê≥ïÊé•Âê¨ÈÄöËØùÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
            }
        }

        // ÊãíÁªùÈÄöËØù
        function rejectCall() {
            console.log('ÊãíÁªùÈÄöËØùÔºåÂΩìÂâçÈÄöËØùÊï∞ÊçÆ:', currentCallData);
            
            // ÈöêËóèÂÖ®Â±ÄÂºπÊ°Ü
            if (window.globalCallPopup && window.globalCallPopup.isVisible()) {
                window.globalCallPopup.hide();
            }
            
            if (currentCallData && window.webrtcClient) {
                window.webrtcClient.rejectCall(currentCallData.roomId);
                hideCallInterface();
            } else {
                console.error('‚ùå WebRTCÂÆ¢Êà∑Á´ØÊú™ÂàùÂßãÂåñÊàñÈÄöËØùÊï∞ÊçÆÁº∫Â§±');
                hideCallInterface();
            }
        }

        // Â∞ÜÂáΩÊï∞Êö¥Èú≤Âà∞ÂÖ®Â±Ä‰ΩúÁî®ÂüüÔºå‰æõÂÖ®Â±ÄÂºπÊ°ÜË∞ÉÁî®
        window.acceptCall = acceptCall;
        window.rejectCall = rejectCall;

        // ÊåÇÊñ≠ÈÄöËØù
        function endCall() {
            if (window.webrtcClient) {
                window.webrtcClient.endCall();
            } else {
                console.error('‚ùå WebRTCÂÆ¢Êà∑Á´ØÊú™ÂàùÂßãÂåñ');
            }
            hideCallInterface();
        }

        // ÈöêËóèÈÄöËØùÁïåÈù¢
        function hideCallInterface() {
            const callOverlay = document.getElementById('callOverlay');
            callOverlay.classList.remove('show');

            stopCallTimer();
            currentCallData = null;

            // ÂÅúÊ≠¢Êú¨Âú∞ËßÜÈ¢ëÊµÅ
            const localVideo = document.getElementById('localVideo');
            if (localVideo.srcObject) {
                localVideo.srcObject.getTracks().forEach(track => track.stop());
                localVideo.srcObject = null;
            }

            // Ê∏ÖÁ©∫ËøúÁ®ãËßÜÈ¢ëÊµÅ
            const remoteVideo = document.getElementById('remoteVideo');
            if (remoteVideo.srcObject) {
                remoteVideo.srcObject = null;
            }
        }

        // ÂàáÊç¢ÈùôÈü≥ - ‰ΩøÁî®call-ui.js‰∏≠ÁöÑÂºÇÊ≠•ÁâàÊú¨
        // Ëøô‰∏™ÂáΩÊï∞Â∑≤Âú®call-ui.js‰∏≠ÂÆö‰πâÔºåËøôÈáå‰∏çÈúÄË¶ÅÈáçÂ§çÂÆö‰πâ

        // ÂàáÊç¢ËßÜÈ¢ë - ‰ΩøÁî®call-ui.js‰∏≠ÁöÑÂºÇÊ≠•ÁâàÊú¨
        // Ëøô‰∏™ÂáΩÊï∞Â∑≤Âú®call-ui.js‰∏≠ÂÆö‰πâÔºåËøôÈáå‰∏çÈúÄË¶ÅÈáçÂ§çÂÆö‰πâ
    </script>

    <!-- ‰ºöËØùÂè≥ÈîÆËèúÂçï -->
    <div id="conversationContextMenu" class="context-menu" style="display: none;">
        <div class="context-menu-item" onclick="openConversation()">
            <i class="fas fa-comment me-2"></i>ÊâìÂºÄ‰ºöËØù
        </div>
        <div class="context-menu-item" onclick="pinConversationFromContext()">
            <i class="fas fa-thumbtack me-2"></i>ÁΩÆÈ°∂‰ºöËØù
        </div>
        <div class="context-menu-item" onclick="muteConversationFromContext()">
            <i class="fas fa-volume-mute me-2"></i>ÈùôÈü≥ÈÄöÁü•
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item text-warning" onclick="clearChatMessagesFromContext()">
            <i class="fas fa-broom me-2"></i>Ê∏ÖÁ©∫ËÅäÂ§©ËÆ∞ÂΩï
        </div>
        <div class="context-menu-item text-info" onclick="unfollowUserFromContext()">
            <i class="fas fa-user-minus me-2"></i>ÂèñÊ∂àÂÖ≥Ê≥®
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item text-danger" onclick="deleteConversationFromContext()">
            <i class="fas fa-trash me-2"></i>Âà†Èô§‰ºöËØù
        </div>
    </div>
</body>
</html>
