<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="'ä¸ ' + ${targetUser.username} + ' çš„ç§èŠ - è§†é¢‘åˆ†äº«å¹³å°'">ç§èŠ - è§†é¢‘åˆ†äº«å¹³å°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/css/chat.css" rel="stylesheet">
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-video me-2"></i>è§†é¢‘åˆ†äº«å¹³å°
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">
                    <i class="fas fa-home me-1"></i>é¦–é¡µ
                </a>
                <a class="nav-link active" href="/chat">
                    <i class="fas fa-comments me-1"></i>èŠå¤©
                    <span class="badge bg-danger ms-1" id="totalUnreadCount" style="display: none;">0</span>
                </a>
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <img th:src="${currentUser.avatar}" alt="å¤´åƒ" class="rounded-circle me-1" width="24" height="24">
                        <span th:text="${currentUser.username}">ç”¨æˆ·å</span>
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="/profile">ä¸ªäººèµ„æ–™</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="/logout">é€€å‡ºç™»å½•</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <!-- ç§èŠç•Œé¢ -->
    <div class="container-fluid chat-container">
        <div class="row h-100">
            <!-- èŠå¤©åŒºåŸŸ -->
            <div class="col-12 chat-main">
                <!-- èŠå¤©å¤´éƒ¨ -->
                <div class="chat-header">
                    <div class="d-flex align-items-center">
                        <a href="/chat" class="btn btn-sm btn-outline-secondary me-3">
                            <i class="fas fa-arrow-left"></i>
                        </a>
                        <img th:src="${targetUser.avatar}" alt="å¤´åƒ" class="rounded-circle me-3" width="40" height="40">
                        <div>
                            <h6 class="mb-0" th:text="${targetUser.username}">èŠå¤©å¯¹è±¡</h6>
                            <small class="text-muted">åœ¨çº¿</small>
                        </div>
                    </div>
                    <div class="chat-actions">
                        <button class="btn btn-sm btn-outline-secondary me-2" title="è§†é¢‘é€šè¯">
                            <i class="fas fa-video"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary me-2" title="è¯­éŸ³é€šè¯">
                            <i class="fas fa-phone"></i>
                        </button>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#"><i class="fas fa-user me-2"></i>æŸ¥çœ‹èµ„æ–™</a></li>
                                <li><a class="dropdown-item" href="#"><i class="fas fa-thumbtack me-2"></i>ç½®é¡¶ä¼šè¯</a></li>
                                <li><a class="dropdown-item" href="#"><i class="fas fa-volume-mute me-2"></i>é™éŸ³é€šçŸ¥</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="#"><i class="fas fa-ban me-2"></i>å±è”½ç”¨æˆ·</a></li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- å…³æ³¨çŠ¶æ€æç¤º -->
                <div class="follow-status-alert" id="followStatusAlert">
                    <!-- å…³æ³¨çŠ¶æ€æç¤ºå°†é€šè¿‡JavaScriptåŠ¨æ€æ˜¾ç¤º -->
                </div>

                <!-- æ¶ˆæ¯åŒºåŸŸ -->
                <div class="messages-container" id="messagesContainer">
                    <div class="messages-list" id="messagesList">
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-comments fa-2x mb-3"></i>
                            <p>å¼€å§‹ä¸ <span th:text="${targetUser.username}">ç”¨æˆ·</span> çš„å¯¹è¯å§ï¼</p>
                        </div>
                    </div>
                </div>

                <!-- æ–‡ä»¶é¢„è§ˆåŒºåŸŸ -->
                <div class="file-preview-area" id="filePreviewArea" style="display: none;">
                    <div class="file-preview-content">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted">å‡†å¤‡å‘é€çš„æ–‡ä»¶ï¼š</span>
                            <button class="btn btn-sm btn-outline-danger" onclick="clearFilePreview()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div id="filePreviewList">
                            <!-- æ–‡ä»¶é¢„è§ˆé¡¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                    </div>
                </div>

                <!-- è¾“å…¥åŒºåŸŸ -->
                <div class="message-input-area" id="messageInputArea">
                    <div class="input-toolbar">
                        <button class="btn btn-sm btn-outline-secondary" title="è¡¨æƒ…" onclick="toggleEmojiPicker()">
                            <i class="fas fa-smile"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" title="å›¾ç‰‡" onclick="selectFile('image')">
                            <i class="fas fa-image"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" title="æ–‡ä»¶" onclick="selectFile('file')">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" title="è§†é¢‘" onclick="selectFile('video')">
                            <i class="fas fa-video"></i>
                        </button>
                    </div>
                    
                    <div class="input-group">
                        <textarea class="form-control" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." rows="1" 
                                  onkeydown="handleMessageInput(event)" oninput="autoResize(this)"></textarea>
                        <button class="btn btn-primary" id="sendButton" onclick="sendMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    
                    <!-- å‘é€é™åˆ¶æç¤º -->
                    <div class="send-limit-notice" id="sendLimitNotice" style="display: none;">
                        <small class="text-warning">
                            <i class="fas fa-info-circle me-1"></i>
                            æ‚¨åªèƒ½å‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œå¯¹æ–¹å…³æ³¨æ‚¨åæ‰èƒ½ç»§ç»­èŠå¤©
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è¡¨æƒ…é€‰æ‹©å™¨ -->
    <div class="emoji-picker" id="emojiPicker" style="display: none;">
        <div class="emoji-categories">
            <button class="emoji-category active" data-category="faces">ğŸ˜Š</button>
            <button class="emoji-category" data-category="gestures">ğŸ‘</button>
            <button class="emoji-category" data-category="hearts">â¤ï¸</button>
            <button class="emoji-category" data-category="animals">ğŸ±</button>
        </div>
        <div class="emoji-grid" id="emojiGrid">
            <!-- è¡¨æƒ…å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
        </div>
    </div>

    <!-- æ–‡ä»¶è¾“å…¥ -->
    <input type="file" id="fileInput" style="display: none;" multiple accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.txt,.zip,.rar">

    <!-- æ–‡ä»¶é¢„è§ˆæç¤º -->
    <div class="file-upload-tips" style="display: none;">
        <small class="text-muted">
            <i class="fas fa-info-circle me-1"></i>
            æœ€å¤šå¯é€‰æ‹©9ä¸ªæ–‡ä»¶ï¼Œå•ä¸ªæ–‡ä»¶ä¸è¶…è¿‡50MB
        </small>
    </div>

    <!-- è„šæœ¬ -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/chat.js"></script>
    
    <script>
        // åˆå§‹åŒ–ç§èŠé¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯å’Œç›®æ ‡ç”¨æˆ·ä¿¡æ¯
            window.currentUser = {
                id: [[${currentUser.id}]],
                username: '[[${currentUser.username}]]',
                avatar: '[[${currentUser.avatar}]]'
            };
            
            window.targetUser = {
                id: [[${targetUser.id}]],
                username: '[[${targetUser.username}]]',
                avatar: '[[${targetUser.avatar}]]'
            };
            
            // åˆå§‹åŒ–èŠå¤©åŠŸèƒ½
            if (typeof ChatApp !== 'undefined') {
                ChatApp.init();
                ChatApp.initPrivateChat(window.targetUser);
            }
        });
    </script>
</body>
</html>
