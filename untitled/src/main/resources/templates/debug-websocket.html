<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocketè°ƒè¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 5px; }
        .log { background: #f5f5f5; padding: 10px; height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        button { padding: 8px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        input { padding: 5px; margin: 5px; border: 1px solid #ddd; border-radius: 3px; }
        .status { padding: 5px 10px; border-radius: 3px; margin: 5px 0; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <h1>ğŸ”§ WebSocketè¿æ¥è°ƒè¯•</h1>
    
    <div class="section">
        <h3>è¿æ¥çŠ¶æ€</h3>
        <div id="connectionStatus" class="status info">æœªè¿æ¥</div>
        <button onclick="connect()">è¿æ¥</button>
        <button onclick="disconnect()">æ–­å¼€</button>
    </div>
    
    <div class="section">
        <h3>ç”¨æˆ·è®¾ç½®</h3>
        <input type="text" id="userIdInput" placeholder="ç”¨æˆ·ID" value="2">
        <button onclick="joinSignaling()">åŠ å…¥ä¿¡ä»¤æœåŠ¡å™¨</button>
        <div id="joinStatus" class="status info">æœªåŠ å…¥</div>
    </div>
    
    <div class="section">
        <h3>å‘é€æµ‹è¯•æ¶ˆæ¯</h3>
        <input type="text" id="targetUserInput" placeholder="ç›®æ ‡ç”¨æˆ·ID" value="3">
        <button onclick="sendTestCall()">å‘é€é€šè¯é‚€è¯·</button>
        <button onclick="sendKeepAlive()">å‘é€ä¿æ´»æ¶ˆæ¯</button>
    </div>
    
    <div class="section">
        <h3>è°ƒè¯•æ—¥å¿—</h3>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        <div id="debugLog" class="log"></div>
    </div>

    <!-- WebSocketåº“ -->
    <script src="/js/sockjs.min.js"></script>
    <script src="/js/stomp.min.js"></script>

    <script>
        let stompClient = null;
        let currentUserId = null;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('debugLog');
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            logElement.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function clearLog() {
            document.getElementById('debugLog').innerHTML = '';
        }

        function updateStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }

        function connect() {
            if (stompClient && stompClient.connected) {
                log('å·²ç»è¿æ¥', 'error');
                return;
            }

            log('å¼€å§‹è¿æ¥WebSocket...');
            updateStatus('connectionStatus', 'è¿æ¥ä¸­...', 'info');

            try {
                const socket = new SockJS('/ws');
                stompClient = Stomp.over(socket);
                
                // å¯ç”¨è°ƒè¯•
                stompClient.debug = function(str) {
                    log(`STOMP: ${str}`);
                };

                stompClient.connect({}, function(frame) {
                    log('âœ… WebSocketè¿æ¥æˆåŠŸ', 'success');
                    log(`è¿æ¥å¸§: ${frame}`, 'success');
                    updateStatus('connectionStatus', 'å·²è¿æ¥', 'success');
                    
                    // è®¢é˜…æ¶ˆæ¯
                    subscribeMessages();
                    
                }, function(error) {
                    log(`âŒ è¿æ¥å¤±è´¥: ${error}`, 'error');
                    updateStatus('connectionStatus', 'è¿æ¥å¤±è´¥', 'error');
                });

            } catch (error) {
                log(`âŒ è¿æ¥å¼‚å¸¸: ${error.message}`, 'error');
                updateStatus('connectionStatus', 'è¿æ¥å¼‚å¸¸', 'error');
            }
        }

        function disconnect() {
            if (stompClient) {
                stompClient.disconnect();
                stompClient = null;
            }
            updateStatus('connectionStatus', 'å·²æ–­å¼€', 'info');
            updateStatus('joinStatus', 'æœªåŠ å…¥', 'info');
            log('è¿æ¥å·²æ–­å¼€');
        }

        function subscribeMessages() {
            if (!stompClient) return;

            log('å¼€å§‹è®¢é˜…æ¶ˆæ¯...');

            // è®¢é˜…åŠ å…¥æˆåŠŸæ¶ˆæ¯
            stompClient.subscribe('/user/queue/webrtc/joined', function(message) {
                const data = JSON.parse(message.body);
                log(`âœ… æ”¶åˆ°åŠ å…¥æˆåŠŸæ¶ˆæ¯: ${JSON.stringify(data)}`, 'success');
                updateStatus('joinStatus', 'å·²åŠ å…¥ä¿¡ä»¤æœåŠ¡å™¨', 'success');
            });

            // è®¢é˜…é€šè¯é‚€è¯·
            stompClient.subscribe('/user/queue/webrtc/call-invitation', function(message) {
                const data = JSON.parse(message.body);
                log(`ğŸ“ æ”¶åˆ°é€šè¯é‚€è¯·(ç”¨æˆ·é˜Ÿåˆ—): ${JSON.stringify(data)}`, 'success');
            });

            stompClient.subscribe('/topic/webrtc/call-invitation-broadcast', function(message) {
                const data = JSON.parse(message.body);
                log(`ğŸ“ æ”¶åˆ°é€šè¯é‚€è¯·(å¹¿æ’­): ${JSON.stringify(data)}`, 'success');
            });

            // è®¢é˜…å…¶ä»–æ¶ˆæ¯
            stompClient.subscribe('/user/queue/webrtc/call-accepted', function(message) {
                const data = JSON.parse(message.body);
                log(`âœ… é€šè¯è¢«æ¥å—: ${JSON.stringify(data)}`, 'success');
            });

            stompClient.subscribe('/user/queue/webrtc/call-rejected', function(message) {
                const data = JSON.parse(message.body);
                log(`âŒ é€šè¯è¢«æ‹’ç»: ${JSON.stringify(data)}`, 'error');
            });

            log('âœ… æ¶ˆæ¯è®¢é˜…å®Œæˆ');
        }

        function joinSignaling() {
            if (!stompClient || !stompClient.connected) {
                log('è¯·å…ˆè¿æ¥WebSocket', 'error');
                return;
            }

            currentUserId = document.getElementById('userIdInput').value.trim();
            if (!currentUserId) {
                log('è¯·è¾“å…¥ç”¨æˆ·ID', 'error');
                return;
            }

            log(`å‘é€åŠ å…¥ä¿¡ä»¤æœåŠ¡å™¨æ¶ˆæ¯ï¼Œç”¨æˆ·ID: ${currentUserId}`);
            
            try {
                stompClient.send('/app/webrtc/join', {}, JSON.stringify({
                    userId: currentUserId
                }));
                log('âœ… åŠ å…¥æ¶ˆæ¯å·²å‘é€');
                updateStatus('joinStatus', 'åŠ å…¥ä¸­...', 'info');
            } catch (error) {
                log(`âŒ å‘é€åŠ å…¥æ¶ˆæ¯å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function sendTestCall() {
            if (!stompClient || !stompClient.connected) {
                log('è¯·å…ˆè¿æ¥WebSocket', 'error');
                return;
            }

            if (!currentUserId) {
                log('è¯·å…ˆåŠ å…¥ä¿¡ä»¤æœåŠ¡å™¨', 'error');
                return;
            }

            const targetUserId = document.getElementById('targetUserInput').value.trim();
            if (!targetUserId) {
                log('è¯·è¾“å…¥ç›®æ ‡ç”¨æˆ·ID', 'error');
                return;
            }

            const callData = {
                callerId: currentUserId,
                calleeId: targetUserId,
                callType: 'video'
            };

            log(`å‘é€é€šè¯é‚€è¯·: ${JSON.stringify(callData)}`);
            
            try {
                stompClient.send('/app/webrtc/call', {}, JSON.stringify(callData));
                log('âœ… é€šè¯é‚€è¯·å·²å‘é€');
            } catch (error) {
                log(`âŒ å‘é€é€šè¯é‚€è¯·å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function sendKeepAlive() {
            if (!stompClient || !stompClient.connected) {
                log('è¯·å…ˆè¿æ¥WebSocket', 'error');
                return;
            }

            if (!currentUserId) {
                log('è¯·å…ˆè®¾ç½®ç”¨æˆ·ID', 'error');
                return;
            }

            try {
                stompClient.send('/app/webrtc/keepalive', {}, JSON.stringify({
                    userId: currentUserId
                }));
                log('âœ… ä¿æ´»æ¶ˆæ¯å·²å‘é€');
            } catch (error) {
                log(`âŒ å‘é€ä¿æ´»æ¶ˆæ¯å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿æ¥
        window.addEventListener('load', () => {
            log('é¡µé¢åŠ è½½å®Œæˆ');
        });
    </script>
</body>
</html>
