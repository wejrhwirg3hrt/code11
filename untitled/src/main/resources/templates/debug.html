<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>数据持久化调试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .btn { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; cursor: pointer; }
        .btn:hover { background: #0056b3; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1>🔍 数据持久化调试</h1>
    
    <div class="section">
        <h2>音乐数据检查</h2>
        <button class="btn" onclick="checkMusicData()">检查音乐数据</button>
        <button class="btn" onclick="testUpload()">测试上传</button>
        <div id="musicStatus"></div>
    </div>

    <div class="section">
        <h2>数据库记录</h2>
        <div id="dbRecords"></div>
    </div>

    <div class="section">
        <h2>文件系统检查</h2>
        <div id="fileSystem"></div>
    </div>

    <script>
        async function checkMusicData() {
            try {
                const response = await fetch('/api/data-persistence/music/status');
                const data = await response.json();
                
                document.getElementById('musicStatus').innerHTML = `
                    <div class="status ${data.isHealthy ? 'success' : 'warning'}">
                        <strong>状态:</strong> ${data.status}<br>
                        <strong>数据库记录:</strong> ${data.databaseRecords}<br>
                        <strong>文件系统记录:</strong> ${data.fileSystemRecords}<br>
                        <strong>问题数量:</strong> ${data.consistencyIssuesCount}
                    </div>
                `;
                
                displayRecords('dbRecords', data.databaseMusic);
                displayFileSystem('fileSystem', data.fileSystemMusic);
                
            } catch (error) {
                document.getElementById('musicStatus').innerHTML = 
                    `<div class="status error">错误: ${error.message}</div>`;
            }
        }

        function displayRecords(elementId, data) {
            const element = document.getElementById(elementId);
            if (!data || data.length === 0) {
                element.innerHTML = '<p>暂无数据库记录</p>';
                return;
            }
            
            let html = '<table><thead><tr><th>ID</th><th>标题</th><th>艺术家</th><th>文件名</th><th>上传时间</th></tr></thead><tbody>';
            data.forEach(item => {
                html += `<tr>
                    <td>${item.id}</td>
                    <td>${item.title}</td>
                    <td>${item.artist || '-'}</td>
                    <td>${item.fileName}</td>
                    <td>${item.uploadTime}</td>
                </tr>`;
            });
            html += '</tbody></table>';
            element.innerHTML = html;
        }

        function displayFileSystem(elementId, data) {
            const element = document.getElementById(elementId);
            if (!data || data.length === 0) {
                element.innerHTML = '<p>暂无文件系统记录</p>';
                return;
            }
            
            let html = '<table><thead><tr><th>文件名</th><th>文件大小</th><th>修改时间</th></tr></thead><tbody>';
            data.forEach(item => {
                html += `<tr>
                    <td>${item.fileName}</td>
                    <td>${formatFileSize(item.fileSize)}</td>
                    <td>${new Date(item.lastModified).toLocaleString()}</td>
                </tr>`;
            });
            html += '</tbody></table>';
            element.innerHTML = html;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function testUpload() {
            // 创建一个测试文件
            const testFile = new File(['test audio content'], 'test.mp3', { type: 'audio/mpeg' });
            const formData = new FormData();
            formData.append('file', testFile);
            formData.append('title', '测试音乐');
            formData.append('artist', '测试艺术家');
            
            try {
                const response = await fetch('/api/music/upload', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                
                if (result.success) {
                    alert('测试上传成功！');
                    checkMusicData();
                } else {
                    alert('测试上传失败: ' + result.message);
                }
            } catch (error) {
                alert('测试上传错误: ' + error.message);
            }
        }

        // 页面加载时自动检查
        document.addEventListener('DOMContentLoaded', checkMusicData);
    </script>
</body>
</html> 