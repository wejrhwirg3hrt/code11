<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>æ•°æ®æŒä¹…åŒ–è°ƒè¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .btn { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; cursor: pointer; }
        .btn:hover { background: #0056b3; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1>ğŸ” æ•°æ®æŒä¹…åŒ–è°ƒè¯•</h1>
    
    <div class="section">
        <h2>éŸ³ä¹æ•°æ®æ£€æŸ¥</h2>
        <button class="btn" onclick="checkMusicData()">æ£€æŸ¥éŸ³ä¹æ•°æ®</button>
        <button class="btn" onclick="testUpload()">æµ‹è¯•ä¸Šä¼ </button>
        <div id="musicStatus"></div>
    </div>

    <div class="section">
        <h2>æ•°æ®åº“è®°å½•</h2>
        <div id="dbRecords"></div>
    </div>

    <div class="section">
        <h2>æ–‡ä»¶ç³»ç»Ÿæ£€æŸ¥</h2>
        <div id="fileSystem"></div>
    </div>

    <script>
        async function checkMusicData() {
            try {
                const response = await fetch('/api/data-persistence/music/status');
                const data = await response.json();
                
                document.getElementById('musicStatus').innerHTML = `
                    <div class="status ${data.isHealthy ? 'success' : 'warning'}">
                        <strong>çŠ¶æ€:</strong> ${data.status}<br>
                        <strong>æ•°æ®åº“è®°å½•:</strong> ${data.databaseRecords}<br>
                        <strong>æ–‡ä»¶ç³»ç»Ÿè®°å½•:</strong> ${data.fileSystemRecords}<br>
                        <strong>é—®é¢˜æ•°é‡:</strong> ${data.consistencyIssuesCount}
                    </div>
                `;
                
                displayRecords('dbRecords', data.databaseMusic);
                displayFileSystem('fileSystem', data.fileSystemMusic);
                
            } catch (error) {
                document.getElementById('musicStatus').innerHTML = 
                    `<div class="status error">é”™è¯¯: ${error.message}</div>`;
            }
        }

        function displayRecords(elementId, data) {
            const element = document.getElementById(elementId);
            if (!data || data.length === 0) {
                element.innerHTML = '<p>æš‚æ— æ•°æ®åº“è®°å½•</p>';
                return;
            }
            
            let html = '<table><thead><tr><th>ID</th><th>æ ‡é¢˜</th><th>è‰ºæœ¯å®¶</th><th>æ–‡ä»¶å</th><th>ä¸Šä¼ æ—¶é—´</th></tr></thead><tbody>';
            data.forEach(item => {
                html += `<tr>
                    <td>${item.id}</td>
                    <td>${item.title}</td>
                    <td>${item.artist || '-'}</td>
                    <td>${item.fileName}</td>
                    <td>${item.uploadTime}</td>
                </tr>`;
            });
            html += '</tbody></table>';
            element.innerHTML = html;
        }

        function displayFileSystem(elementId, data) {
            const element = document.getElementById(elementId);
            if (!data || data.length === 0) {
                element.innerHTML = '<p>æš‚æ— æ–‡ä»¶ç³»ç»Ÿè®°å½•</p>';
                return;
            }
            
            let html = '<table><thead><tr><th>æ–‡ä»¶å</th><th>æ–‡ä»¶å¤§å°</th><th>ä¿®æ”¹æ—¶é—´</th></tr></thead><tbody>';
            data.forEach(item => {
                html += `<tr>
                    <td>${item.fileName}</td>
                    <td>${formatFileSize(item.fileSize)}</td>
                    <td>${new Date(item.lastModified).toLocaleString()}</td>
                </tr>`;
            });
            html += '</tbody></table>';
            element.innerHTML = html;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function testUpload() {
            // åˆ›å»ºä¸€ä¸ªæµ‹è¯•æ–‡ä»¶
            const testFile = new File(['test audio content'], 'test.mp3', { type: 'audio/mpeg' });
            const formData = new FormData();
            formData.append('file', testFile);
            formData.append('title', 'æµ‹è¯•éŸ³ä¹');
            formData.append('artist', 'æµ‹è¯•è‰ºæœ¯å®¶');
            
            try {
                const response = await fetch('/api/music/upload', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                
                if (result.success) {
                    alert('æµ‹è¯•ä¸Šä¼ æˆåŠŸï¼');
                    checkMusicData();
                } else {
                    alert('æµ‹è¯•ä¸Šä¼ å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('æµ‹è¯•ä¸Šä¼ é”™è¯¯: ' + error.message);
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        document.addEventListener('DOMContentLoaded', checkMusicData);
    </script>
</body>
</html> 