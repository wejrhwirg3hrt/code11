<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ°ç†å®šä½åŠŸèƒ½æµ‹è¯•</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .location-card {
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            margin: 10px 0;
            background: #f8f9fa;
        }
        .coordinate-input {
            margin: 10px 0;
        }
        .result-section {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center mb-4">
            <i class="fas fa-map-marker-alt text-primary"></i>
            åœ°ç†å®šä½åŠŸèƒ½æµ‹è¯•
        </h1>
        
        <!-- å½“å‰ä½ç½®è·å– -->
        <div class="location-card">
            <h3><i class="fas fa-crosshairs"></i> è·å–å½“å‰ä½ç½®</h3>
            <p class="text-muted">ç‚¹å‡»æŒ‰é’®è·å–æ‚¨çš„å½“å‰åœ°ç†ä½ç½®</p>
            <button class="btn btn-primary" id="getCurrentLocation">
                <i class="fas fa-location-arrow"></i> è·å–å½“å‰ä½ç½®
            </button>
            <div id="currentLocationResult" class="result-section" style="display: none;">
                <h5>å½“å‰ä½ç½®ä¿¡æ¯ï¼š</h5>
                <div id="currentLocationDetails"></div>
            </div>
        </div>
        
        <!-- åæ ‡æµ‹è¯• -->
        <div class="location-card">
            <h3><i class="fas fa-globe"></i> åæ ‡æµ‹è¯•</h3>
            <p class="text-muted">è¾“å…¥ç»çº¬åº¦åæ ‡æµ‹è¯•åœ°å€è§£æåŠŸèƒ½</p>
            
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label">çº¬åº¦ (Latitude):</label>
                    <input type="number" class="form-control" id="testLat" step="0.000001" placeholder="ä¾‹å¦‚: 39.9042">
                </div>
                <div class="col-md-6">
                    <label class="form-label">ç»åº¦ (Longitude):</label>
                    <input type="number" class="form-control" id="testLng" step="0.000001" placeholder="ä¾‹å¦‚: 116.4074">
                </div>
            </div>
            
            <div class="mt-3">
                <button class="btn btn-success" id="testCoordinates">
                    <i class="fas fa-search"></i> è§£æåœ°å€
                </button>
                <button class="btn btn-secondary" id="loadPresets">
                    <i class="fas fa-list"></i> åŠ è½½é¢„è®¾åæ ‡
                </button>
            </div>
            
            <div id="testResult" class="result-section" style="display: none;">
                <h5>è§£æç»“æœï¼š</h5>
                <div id="testLocationDetails"></div>
            </div>
        </div>
        
        <!-- é¢„è®¾åŸå¸‚åæ ‡ -->
        <div class="location-card">
            <h3><i class="fas fa-city"></i> é¢„è®¾åŸå¸‚åæ ‡</h3>
            <p class="text-muted">ç‚¹å‡»åŸå¸‚åç§°å¿«é€Ÿæµ‹è¯•</p>
            <div class="row">
                <div class="col-md-3 mb-2">
                    <button class="btn btn-outline-primary w-100" data-lat="39.9042" data-lng="116.4074">åŒ—äº¬</button>
                </div>
                <div class="col-md-3 mb-2">
                    <button class="btn btn-outline-primary w-100" data-lat="31.2304" data-lng="121.4737">ä¸Šæµ·</button>
                </div>
                <div class="col-md-3 mb-2">
                    <button class="btn btn-outline-primary w-100" data-lat="22.5431" data-lng="114.0579">æ·±åœ³</button>
                </div>
                <div class="col-md-3 mb-2">
                    <button class="btn btn-outline-primary w-100" data-lat="23.1291" data-lng="113.2644">å¹¿å·</button>
                </div>
                <div class="col-md-3 mb-2">
                    <button class="btn btn-outline-primary w-100" data-lat="30.5728" data-lng="104.0668">æˆéƒ½</button>
                </div>
                <div class="col-md-3 mb-2">
                    <button class="btn btn-outline-primary w-100" data-lat="32.0603" data-lng="118.7969">å—äº¬</button>
                </div>
                <div class="col-md-3 mb-2">
                    <button class="btn btn-outline-primary w-100" data-lat="30.2741" data-lng="120.1551">æ­å·</button>
                </div>
                <div class="col-md-3 mb-2">
                    <button class="btn btn-outline-primary w-100" data-lat="36.0671" data-lng="120.3826">é’å²›</button>
                </div>
            </div>
        </div>
        
        <!-- è¿”å›é“¾æ¥ -->
        <div class="text-center mt-4">
            <a href="/posts/publish" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> è¿”å›å‘å¸ƒåŠ¨æ€
            </a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // è·å–å½“å‰ä½ç½®
        document.getElementById('getCurrentLocation').addEventListener('click', function() {
            const btn = this;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> å®šä½ä¸­...';
            
            if (!navigator.geolocation) {
                alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†å®šä½åŠŸèƒ½');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-location-arrow"></i> è·å–å½“å‰ä½ç½®';
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    // è°ƒç”¨APIè§£æåœ°å€
                    fetch(`/api/geocode/reverse?lat=${lat}&lng=${lng}`)
                        .then(response => response.json())
                        .then(data => {
                            displayLocationResult(data, 'currentLocationDetails');
                            document.getElementById('currentLocationResult').style.display = 'block';
                            
                            btn.disabled = false;
                            btn.innerHTML = '<i class="fas fa-location-arrow"></i> è·å–å½“å‰ä½ç½®';
                        })
                        .catch(error => {
                            console.error('åœ°å€è§£æå¤±è´¥:', error);
                            btn.disabled = false;
                            btn.innerHTML = '<i class="fas fa-location-arrow"></i> è·å–å½“å‰ä½ç½®';
                        });
                },
                function(error) {
                    let errorMsg = 'å®šä½å¤±è´¥';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg = 'ç”¨æˆ·æ‹’ç»äº†åœ°ç†å®šä½è¯·æ±‚';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg = 'ä½ç½®ä¿¡æ¯ä¸å¯ç”¨';
                            break;
                        case error.TIMEOUT:
                            errorMsg = 'å®šä½è¯·æ±‚è¶…æ—¶';
                            break;
                    }
                    alert(errorMsg);
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-location-arrow"></i> è·å–å½“å‰ä½ç½®';
                }
            );
        });
        
        // æµ‹è¯•åæ ‡
        document.getElementById('testCoordinates').addEventListener('click', function() {
            const lat = parseFloat(document.getElementById('testLat').value);
            const lng = parseFloat(document.getElementById('testLng').value);
            
            if (isNaN(lat) || isNaN(lng)) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ç»çº¬åº¦åæ ‡');
                return;
            }
            
            fetch(`/api/geocode/reverse?lat=${lat}&lng=${lng}`)
                .then(response => response.json())
                .then(data => {
                    displayLocationResult(data, 'testLocationDetails');
                    document.getElementById('testResult').style.display = 'block';
                })
                .catch(error => {
                    console.error('åœ°å€è§£æå¤±è´¥:', error);
                    alert('åœ°å€è§£æå¤±è´¥');
                });
        });
        
        // é¢„è®¾åŸå¸‚æŒ‰é’®
        document.querySelectorAll('[data-lat][data-lng]').forEach(button => {
            button.addEventListener('click', function() {
                const lat = parseFloat(this.dataset.lat);
                const lng = parseFloat(this.dataset.lng);
                
                document.getElementById('testLat').value = lat;
                document.getElementById('testLng').value = lng;
                
                // è‡ªåŠ¨è§£æ
                fetch(`/api/geocode/reverse?lat=${lat}&lng=${lng}`)
                    .then(response => response.json())
                    .then(data => {
                        displayLocationResult(data, 'testLocationDetails');
                        document.getElementById('testResult').style.display = 'block';
                    })
                    .catch(error => {
                        console.error('åœ°å€è§£æå¤±è´¥:', error);
                    });
            });
        });
        
        // æ˜¾ç¤ºä½ç½®ç»“æœ
        function displayLocationResult(data, containerId) {
            const container = document.getElementById(containerId);
            
            if (data.success) {
                const components = data.addressComponents;
                let html = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-map-marker-alt text-primary"></i> å®Œæ•´åœ°å€</h6>
                            <p class="fw-bold">${data.address}</p>
                            
                            <h6><i class="fas fa-globe text-info"></i> åœ°å€ç»„ä»¶</h6>
                            <ul class="list-unstyled">
                                <li><strong>ğŸŒ å›½å®¶:</strong> ${components.country || 'æœªçŸ¥'}</li>
                                <li><strong>ğŸ›ï¸ çœä»½:</strong> ${components.province || 'æœªçŸ¥'}</li>
                                <li><strong>ğŸ™ï¸ åŸå¸‚:</strong> ${components.city || 'æœªçŸ¥'}</li>
                                <li><strong>ğŸ˜ï¸ åŒºå¿:</strong> ${components.district || 'æœªçŸ¥'}</li>
                                <li><strong>ğŸ›£ï¸ è¡—é“:</strong> ${components.street || 'æœªçŸ¥'}</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-crosshairs text-success"></i> åæ ‡ä¿¡æ¯</h6>
                            <p><strong>çº¬åº¦:</strong> ${data.latitude.toFixed(6)}Â°</p>
                            <p><strong>ç»åº¦:</strong> ${data.longitude.toFixed(6)}Â°</p>
                            
                            <h6><i class="fas fa-layer-group text-warning"></i> åœ°å€çº§åˆ«é€‰æ‹©</h6>
                            <div class="btn-group-vertical w-100">
                                <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard('${components.province} ${components.city}')">
                                    åŸå¸‚çº§åˆ«: ${components.province} ${components.city}
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard('${components.city} ${components.district}')">
                                    åŒºå¿çº§åˆ«: ${components.city} ${components.district}
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard('${data.address}')">
                                    å®Œæ•´åœ°å€: ${data.address}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML = html;
            } else {
                container.innerHTML = `<div class="alert alert-danger">è§£æå¤±è´¥: ${data.error}</div>`;
            }
        }
        
        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(function() {
                alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿: ' + text);
            });
        }
    </script>
</body>
</html>
