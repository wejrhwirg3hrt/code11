<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ€å°åŒ–WebSocketæµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { background: #f5f5f5; padding: 10px; height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px; border: 1px solid #ddd; }
        button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>ğŸ”§ æœ€å°åŒ–WebSocketæµ‹è¯•</h1>
    
    <div>
        <button onclick="testConnection()">æµ‹è¯•è¿æ¥</button>
        <button onclick="testJoin()">æµ‹è¯•åŠ å…¥</button>
        <button onclick="testCall()">æµ‹è¯•é€šè¯</button>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>
    
    <div>
        <h3>æµ‹è¯•æ—¥å¿—</h3>
        <div id="log" class="log"></div>
    </div>

    <script src="/js/sockjs.min.js"></script>
    <script src="/js/stomp.min.js"></script>

    <script>
        let client = null;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('log');
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            logElement.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function testConnection() {
            log('å¼€å§‹æµ‹è¯•WebSocketè¿æ¥...');
            
            try {
                const socket = new SockJS('/ws');
                client = Stomp.over(socket);
                
                // ç¦ç”¨è°ƒè¯•è¾“å‡º
                client.debug = null;

                client.connect({}, function(frame) {
                    log('âœ… WebSocketè¿æ¥æˆåŠŸ!', 'success');
                    log('è¿æ¥å¸§: ' + frame, 'success');
                    
                    // è®¢é˜…æµ‹è¯•æ¶ˆæ¯
                    client.subscribe('/user/queue/webrtc/joined', function(message) {
                        log('ğŸ“¨ æ”¶åˆ°åŠ å…¥æˆåŠŸæ¶ˆæ¯: ' + message.body, 'success');
                    });
                    
                    client.subscribe('/user/queue/webrtc/call-invitation', function(message) {
                        log('ğŸ“ æ”¶åˆ°é€šè¯é‚€è¯·: ' + message.body, 'success');
                    });
                    
                    log('âœ… æ¶ˆæ¯è®¢é˜…å®Œæˆ', 'success');
                    
                }, function(error) {
                    log('âŒ è¿æ¥å¤±è´¥: ' + error, 'error');
                });

            } catch (error) {
                log('âŒ è¿æ¥å¼‚å¸¸: ' + error.message, 'error');
            }
        }

        function testJoin() {
            if (!client || !client.connected) {
                log('âŒ è¯·å…ˆè¿æ¥WebSocket', 'error');
                return;
            }

            log('å‘é€åŠ å…¥æ¶ˆæ¯...');
            
            try {
                const joinMessage = {
                    userId: '999'
                };
                
                client.send('/app/webrtc/join', {}, JSON.stringify(joinMessage));
                log('âœ… åŠ å…¥æ¶ˆæ¯å·²å‘é€: ' + JSON.stringify(joinMessage), 'success');
                
            } catch (error) {
                log('âŒ å‘é€åŠ å…¥æ¶ˆæ¯å¤±è´¥: ' + error.message, 'error');
            }
        }

        function testCall() {
            if (!client || !client.connected) {
                log('âŒ è¯·å…ˆè¿æ¥WebSocket', 'error');
                return;
            }

            log('å‘é€é€šè¯é‚€è¯·...');
            
            try {
                const callMessage = {
                    callerId: '999',
                    calleeId: '888',
                    callType: 'video'
                };
                
                client.send('/app/webrtc/call', {}, JSON.stringify(callMessage));
                log('âœ… é€šè¯é‚€è¯·å·²å‘é€: ' + JSON.stringify(callMessage), 'success');
                
            } catch (error) {
                log('âŒ å‘é€é€šè¯é‚€è¯·å¤±è´¥: ' + error.message, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶çš„æç¤º
        window.addEventListener('load', () => {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œè¯·ç‚¹å‡»"æµ‹è¯•è¿æ¥"å¼€å§‹æµ‹è¯•');
        });
    </script>
</body>
</html>
