<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®€å•é€šè¯æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        .section {
            border: 1px solid #ddd;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        input[type="text"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 200px;
        }
        #log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .call-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 2px solid #007bff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 10000;
            display: none;
        }
        .call-popup.show { display: block; }
        .call-popup h3 { margin-top: 0; }
        .call-buttons { margin-top: 15px; }
        .call-buttons button { margin: 0 10px; }
        .accept-btn { background: #28a745; }
        .reject-btn { background: #dc3545; }
    </style>
</head>
<body>
    <h1>ğŸ“ ç®€å•é€šè¯æµ‹è¯•</h1>
    
    <div class="section">
        <h3>1. è¿æ¥çŠ¶æ€</h3>
        <div id="connectionStatus" class="status info">æœªè¿æ¥</div>
        <button onclick="connect()">è¿æ¥</button>
        <button onclick="disconnect()">æ–­å¼€</button>
    </div>
    
    <div class="section">
        <h3>2. ç”¨æˆ·è®¾ç½®</h3>
        <input type="text" id="userIdInput" placeholder="ç”¨æˆ·ID" value="1">
        <button onclick="setUser()">è®¾ç½®ç”¨æˆ·</button>
        <div id="userStatus" class="status info">æœªè®¾ç½®ç”¨æˆ·</div>
    </div>
    
    <div class="section">
        <h3>3. å‘é€é€šè¯é‚€è¯·</h3>
        <input type="text" id="targetUserInput" placeholder="ç›®æ ‡ç”¨æˆ·ID" value="2">
        <button onclick="sendVideoCall()" id="videoBtn" disabled>è§†é¢‘é€šè¯</button>
        <button onclick="sendAudioCall()" id="audioBtn" disabled>è¯­éŸ³é€šè¯</button>
    </div>
    
    <div class="section">
        <h3>4. é€šè¯çŠ¶æ€</h3>
        <div id="callStatus" class="status info">æ— é€šè¯</div>
        <button onclick="endCall()" id="endBtn" disabled>ç»“æŸé€šè¯</button>
    </div>
    
    <div class="section">
        <h3>5. æ—¥å¿—</h3>
        <button onclick="clearLog()">æ¸…ç©º</button>
        <div id="log"></div>
    </div>

    <!-- æ¥ç”µå¼¹çª— -->
    <div id="callPopup" class="call-popup">
        <h3>ğŸ“ æ¥ç”µ</h3>
        <p id="callerInfo">æ¥è‡ª: æœªçŸ¥ç”¨æˆ·</p>
        <p id="callTypeInfo">é€šè¯ç±»å‹: æœªçŸ¥</p>
        <div class="call-buttons">
            <button class="accept-btn" onclick="acceptCall()">æ¥å¬</button>
            <button class="reject-btn" onclick="rejectCall()">æ‹’ç»</button>
        </div>
    </div>

    <!-- å¼•å…¥åº“ -->
    <script src="/js/sockjs.min.js"></script>
    <script src="/js/stomp.min.js"></script>

    <script>
        let stompClient = null;
        let currentUserId = null;
        let currentCallData = null;

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('log');
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
        }

        function updateStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }

        function setUser() {
            const userId = document.getElementById('userIdInput').value.trim();
            if (!userId) {
                alert('è¯·è¾“å…¥ç”¨æˆ·ID');
                return;
            }
            currentUserId = userId;
            updateStatus('userStatus', `å½“å‰ç”¨æˆ·: ${userId}`, 'success');
            log(`è®¾ç½®ç”¨æˆ·ID: ${userId}`);
        }

        function connect() {
            if (!currentUserId) {
                setUser();
            }

            try {
                log('å¼€å§‹è¿æ¥WebSocket...');
                updateStatus('connectionStatus', 'è¿æ¥ä¸­...', 'warning');

                const socket = new SockJS('/ws');
                stompClient = Stomp.over(socket);
                stompClient.debug = null;

                stompClient.connect({}, function(frame) {
                    log('âœ… WebSocketè¿æ¥æˆåŠŸ');
                    updateStatus('connectionStatus', 'å·²è¿æ¥', 'success');
                    
                    // å¯ç”¨æŒ‰é’®
                    document.getElementById('videoBtn').disabled = false;
                    document.getElementById('audioBtn').disabled = false;
                    
                    // è®¢é˜…æ¶ˆæ¯
                    subscribeMessages();
                    
                    // å‘é€åŠ å…¥æ¶ˆæ¯
                    stompClient.send('/app/webrtc/join', {}, JSON.stringify({
                        userId: currentUserId
                    }));
                    
                }, function(error) {
                    log(`âŒ è¿æ¥å¤±è´¥: ${error}`);
                    updateStatus('connectionStatus', 'è¿æ¥å¤±è´¥', 'error');
                });

            } catch (error) {
                log(`âŒ è¿æ¥å¼‚å¸¸: ${error.message}`);
                updateStatus('connectionStatus', 'è¿æ¥å¼‚å¸¸', 'error');
            }
        }

        function disconnect() {
            if (stompClient) {
                stompClient.disconnect();
                stompClient = null;
            }
            updateStatus('connectionStatus', 'å·²æ–­å¼€', 'info');
            document.getElementById('videoBtn').disabled = true;
            document.getElementById('audioBtn').disabled = true;
            log('è¿æ¥å·²æ–­å¼€');
        }

        function subscribeMessages() {
            if (!stompClient || !currentUserId) return;

            log('è®¢é˜…æ¶ˆæ¯...');

            // è®¢é˜…é€šè¯é‚€è¯· - å¤šç§è·¯å¾„
            stompClient.subscribe(`/user/queue/webrtc/call-invitation`, (message) => {
                const data = JSON.parse(message.body);
                log(`ğŸ”” æ”¶åˆ°é€šè¯é‚€è¯·(ç”¨æˆ·é˜Ÿåˆ—): ${JSON.stringify(data)}`);
                showCallInvitation(data);
            });

            stompClient.subscribe(`/topic/webrtc/call-invitation/${currentUserId}`, (message) => {
                const data = JSON.parse(message.body);
                log(`ğŸ”” æ”¶åˆ°é€šè¯é‚€è¯·(ä¸»é¢˜): ${JSON.stringify(data)}`);
                showCallInvitation(data);
            });

            stompClient.subscribe(`/topic/webrtc/call-invitation-broadcast`, (message) => {
                const data = JSON.parse(message.body);
                log(`ğŸ”” æ”¶åˆ°é€šè¯é‚€è¯·(å¹¿æ’­): ${JSON.stringify(data)}`);
                // åªå¤„ç†å‘ç»™å½“å‰ç”¨æˆ·çš„é‚€è¯·
                if (data.calleeId === currentUserId) {
                    showCallInvitation(data);
                }
            });

            // è®¢é˜…é€šè¯æ¥å—
            stompClient.subscribe(`/user/queue/webrtc/call-accepted`, (message) => {
                const data = JSON.parse(message.body);
                log(`âœ… é€šè¯è¢«æ¥å—: ${JSON.stringify(data)}`);
                updateStatus('callStatus', 'é€šè¯å·²è¿æ¥', 'success');
            });

            // è®¢é˜…é€šè¯æ‹’ç»
            stompClient.subscribe(`/user/queue/webrtc/call-rejected`, (message) => {
                const data = JSON.parse(message.body);
                log(`âŒ é€šè¯è¢«æ‹’ç»: ${JSON.stringify(data)}`);
                updateStatus('callStatus', 'é€šè¯è¢«æ‹’ç»', 'error');
                setTimeout(() => resetCallState(), 3000);
            });

            log('âœ… æ¶ˆæ¯è®¢é˜…å®Œæˆ');
        }

        function sendVideoCall() {
            sendCall('video');
        }

        function sendAudioCall() {
            sendCall('audio');
        }

        function sendCall(callType) {
            const targetUserId = document.getElementById('targetUserInput').value.trim();
            if (!targetUserId) {
                alert('è¯·è¾“å…¥ç›®æ ‡ç”¨æˆ·ID');
                return;
            }

            if (!stompClient) {
                alert('è¯·å…ˆè¿æ¥');
                return;
            }

            try {
                log(`ğŸš€ å‘èµ·${callType}é€šè¯ç»™ç”¨æˆ·: ${targetUserId}`);
                
                const message = {
                    callerId: currentUserId,
                    calleeId: targetUserId,
                    callType: callType
                };

                stompClient.send('/app/webrtc/invite', {}, JSON.stringify(message));
                log('ğŸ“¤ é€šè¯é‚€è¯·å·²å‘é€');
                
                updateStatus('callStatus', `æ­£åœ¨å‘¼å« ${targetUserId}`, 'warning');
                document.getElementById('endBtn').disabled = false;
                
            } catch (error) {
                log(`âŒ å‘é€å¤±è´¥: ${error.message}`);
            }
        }

        function showCallInvitation(data) {
            currentCallData = data;
            
            document.getElementById('callerInfo').textContent = `æ¥è‡ª: ${data.callerName || data.callerId}`;
            document.getElementById('callTypeInfo').textContent = `é€šè¯ç±»å‹: ${data.callType}`;
            document.getElementById('callPopup').classList.add('show');
            
            updateStatus('callStatus', `æ”¶åˆ°æ¥ç”µ: ${data.callType}`, 'warning');
            log('ğŸ“± æ˜¾ç¤ºæ¥ç”µå¼¹çª—');
        }

        function acceptCall() {
            if (!currentCallData || !stompClient) return;

            log('âœ… æ¥å¬é€šè¯');
            
            stompClient.send('/app/webrtc/accept', {}, JSON.stringify({
                roomId: currentCallData.roomId,
                calleeId: currentUserId
            }));

            document.getElementById('callPopup').classList.remove('show');
            updateStatus('callStatus', 'é€šè¯ä¸­', 'success');
            document.getElementById('endBtn').disabled = false;
        }

        function rejectCall() {
            if (!currentCallData || !stompClient) return;

            log('âŒ æ‹’ç»é€šè¯');
            
            stompClient.send('/app/webrtc/reject', {}, JSON.stringify({
                roomId: currentCallData.roomId,
                calleeId: currentUserId
            }));

            document.getElementById('callPopup').classList.remove('show');
            resetCallState();
        }

        function endCall() {
            log('ğŸ“ ç»“æŸé€šè¯');
            
            if (stompClient && currentCallData) {
                stompClient.send('/app/webrtc/end', {}, JSON.stringify({
                    roomId: currentCallData.roomId,
                    userId: currentUserId
                }));
            }

            resetCallState();
        }

        function resetCallState() {
            currentCallData = null;
            updateStatus('callStatus', 'æ— é€šè¯', 'info');
            document.getElementById('endBtn').disabled = true;
            document.getElementById('callPopup').classList.remove('show');
        }

        // é¡µé¢åŠ è½½æ—¶è®¾ç½®ç”¨æˆ·
        window.addEventListener('load', () => {
            log('é¡µé¢åŠ è½½å®Œæˆ');
            setUser();
        });
    </script>
</body>
</html>
