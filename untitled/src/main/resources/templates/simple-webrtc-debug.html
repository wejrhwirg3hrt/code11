<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®€åŒ–WebRTCè°ƒè¯•</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .log-area {
            height: 300px;
            overflow-y: auto;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
        }
        .status-connected { color: green; font-weight: bold; }
        .status-disconnected { color: red; font-weight: bold; }
        .status-connecting { color: orange; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>ğŸ”§ ç®€åŒ–WebRTCè°ƒè¯•</h1>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>ç”¨æˆ·A (ID: 2)</h5>
                        <span id="statusA" class="status-disconnected">æœªè¿æ¥</span>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary" onclick="connectUserA()">è¿æ¥</button>
                        <button class="btn btn-success" onclick="callUserB()">å‘¼å«ç”¨æˆ·B</button>
                        <button class="btn btn-danger" onclick="disconnectUserA()">æ–­å¼€</button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>ç”¨æˆ·B (ID: 3)</h5>
                        <span id="statusB" class="status-disconnected">æœªè¿æ¥</span>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary" onclick="connectUserB()">è¿æ¥</button>
                        <button class="btn btn-success" onclick="callUserA()">å‘¼å«ç”¨æˆ·A</button>
                        <button class="btn btn-danger" onclick="disconnectUserB()">æ–­å¼€</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-4">
            <h5>è°ƒè¯•æ—¥å¿—</h5>
            <button class="btn btn-warning btn-sm" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
            <div id="logArea" class="log-area mt-2"></div>
        </div>
    </div>

    <!-- æ¥ç”µå¼¹çª— -->
    <div class="modal fade" id="callModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ğŸ“ æ¥ç”µ</h5>
                </div>
                <div class="modal-body">
                    <p id="callerInfo">æ¥ç”µä¿¡æ¯</p>
                    <p id="callTypeInfo">é€šè¯ç±»å‹</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" onclick="acceptCall()">æ¥å¬</button>
                    <button type="button" class="btn btn-danger" onclick="rejectCall()">æ‹’ç»</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥å¿…è¦çš„åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/sockjs.min.js"></script>
    <script src="/js/stomp.min.js"></script>

    <script>
        let clientA = null;
        let clientB = null;
        let callModal = null;
        let currentCallData = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            callModal = new bootstrap.Modal(document.getElementById('callModal'));
            log('é¡µé¢åŠ è½½å®Œæˆï¼ŒModalåˆå§‹åŒ–å®Œæˆ');
        });

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logArea = document.getElementById('logArea');
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            logArea.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
            logArea.scrollTop = logArea.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function clearLog() {
            document.getElementById('logArea').innerHTML = '';
        }

        function updateStatus(user, status) {
            const element = document.getElementById(`status${user}`);
            element.textContent = status;
            element.className = status === 'å·²è¿æ¥' ? 'status-connected' : 
                               status === 'è¿æ¥ä¸­...' ? 'status-connecting' : 'status-disconnected';
        }

        // è¿æ¥ç”¨æˆ·A
        function connectUserA() {
            if (clientA && clientA.connected) {
                log('ç”¨æˆ·Aå·²ç»è¿æ¥', 'error');
                return;
            }

            updateStatus('A', 'è¿æ¥ä¸­...');
            log('ç”¨æˆ·Aå¼€å§‹è¿æ¥WebSocket...');

            try {
                const socket = new SockJS('/ws');
                clientA = Stomp.over(socket);
                
                clientA.debug = function(str) {
                    log(`ç”¨æˆ·A STOMP: ${str}`);
                };

                clientA.connect({}, function(frame) {
                    log('âœ… ç”¨æˆ·Aè¿æ¥æˆåŠŸ', 'success');
                    updateStatus('A', 'å·²è¿æ¥');
                    
                    // è®¢é˜…æ¶ˆæ¯
                    subscribeUserAMessages();
                    
                    // å‘é€åŠ å…¥æ¶ˆæ¯
                    setTimeout(() => {
                        clientA.send('/app/webrtc/join', {}, JSON.stringify({
                            userId: '2'
                        }));
                        log('ç”¨æˆ·Aå‘é€åŠ å…¥æ¶ˆæ¯');
                    }, 500);
                    
                }, function(error) {
                    log(`âŒ ç”¨æˆ·Aè¿æ¥å¤±è´¥: ${error}`, 'error');
                    updateStatus('A', 'è¿æ¥å¤±è´¥');
                });

            } catch (error) {
                log(`âŒ ç”¨æˆ·Aè¿æ¥å¼‚å¸¸: ${error.message}`, 'error');
                updateStatus('A', 'è¿æ¥å¼‚å¸¸');
            }
        }

        // è¿æ¥ç”¨æˆ·B
        function connectUserB() {
            if (clientB && clientB.connected) {
                log('ç”¨æˆ·Bå·²ç»è¿æ¥', 'error');
                return;
            }

            updateStatus('B', 'è¿æ¥ä¸­...');
            log('ç”¨æˆ·Bå¼€å§‹è¿æ¥WebSocket...');

            try {
                const socket = new SockJS('/ws');
                clientB = Stomp.over(socket);
                
                clientB.debug = function(str) {
                    log(`ç”¨æˆ·B STOMP: ${str}`);
                };

                clientB.connect({}, function(frame) {
                    log('âœ… ç”¨æˆ·Bè¿æ¥æˆåŠŸ', 'success');
                    updateStatus('B', 'å·²è¿æ¥');
                    
                    // è®¢é˜…æ¶ˆæ¯
                    subscribeUserBMessages();
                    
                    // å‘é€åŠ å…¥æ¶ˆæ¯
                    setTimeout(() => {
                        clientB.send('/app/webrtc/join', {}, JSON.stringify({
                            userId: '3'
                        }));
                        log('ç”¨æˆ·Bå‘é€åŠ å…¥æ¶ˆæ¯');
                    }, 500);
                    
                }, function(error) {
                    log(`âŒ ç”¨æˆ·Bè¿æ¥å¤±è´¥: ${error}`, 'error');
                    updateStatus('B', 'è¿æ¥å¤±è´¥');
                });

            } catch (error) {
                log(`âŒ ç”¨æˆ·Bè¿æ¥å¼‚å¸¸: ${error.message}`, 'error');
                updateStatus('B', 'è¿æ¥å¼‚å¸¸');
            }
        }

        // è®¢é˜…ç”¨æˆ·Aæ¶ˆæ¯
        function subscribeUserAMessages() {
            // è®¢é˜…é€šè¯é‚€è¯·
            clientA.subscribe('/user/queue/webrtc/call-invitation', function(message) {
                const data = JSON.parse(message.body);
                log('ğŸ“ ç”¨æˆ·Aæ”¶åˆ°é€šè¯é‚€è¯·(ç”¨æˆ·é˜Ÿåˆ—): ' + JSON.stringify(data), 'success');
                showCallModal(data, 'A');
            });

            clientA.subscribe('/topic/webrtc/call-invitation/2', function(message) {
                const data = JSON.parse(message.body);
                log('ğŸ“ ç”¨æˆ·Aæ”¶åˆ°é€šè¯é‚€è¯·(å¹¿æ’­é¢‘é“): ' + JSON.stringify(data), 'success');
                showCallModal(data, 'A');
            });

            clientA.subscribe('/topic/webrtc/call-invitation-broadcast', function(message) {
                const data = JSON.parse(message.body);
                log('ğŸ“ ç”¨æˆ·Aæ”¶åˆ°é€šè¯é‚€è¯·(å¼ºåˆ¶å¹¿æ’­): ' + JSON.stringify(data), 'success');
                if (data.calleeId === '2') {
                    showCallModal(data, 'A');
                }
            });

            // è®¢é˜…åŠ å…¥æˆåŠŸæ¶ˆæ¯
            clientA.subscribe('/user/queue/webrtc/joined', function(message) {
                const data = JSON.parse(message.body);
                log('âœ… ç”¨æˆ·AåŠ å…¥æˆåŠŸ: ' + JSON.stringify(data), 'success');
            });

            log('âœ… ç”¨æˆ·Aæ¶ˆæ¯è®¢é˜…å®Œæˆ');
        }

        // è®¢é˜…ç”¨æˆ·Bæ¶ˆæ¯
        function subscribeUserBMessages() {
            // è®¢é˜…é€šè¯é‚€è¯·
            clientB.subscribe('/user/queue/webrtc/call-invitation', function(message) {
                const data = JSON.parse(message.body);
                log('ğŸ“ ç”¨æˆ·Bæ”¶åˆ°é€šè¯é‚€è¯·(ç”¨æˆ·é˜Ÿåˆ—): ' + JSON.stringify(data), 'success');
                showCallModal(data, 'B');
            });

            clientB.subscribe('/topic/webrtc/call-invitation/3', function(message) {
                const data = JSON.parse(message.body);
                log('ğŸ“ ç”¨æˆ·Bæ”¶åˆ°é€šè¯é‚€è¯·(å¹¿æ’­é¢‘é“): ' + JSON.stringify(data), 'success');
                showCallModal(data, 'B');
            });

            clientB.subscribe('/topic/webrtc/call-invitation-broadcast', function(message) {
                const data = JSON.parse(message.body);
                log('ğŸ“ ç”¨æˆ·Bæ”¶åˆ°é€šè¯é‚€è¯·(å¼ºåˆ¶å¹¿æ’­): ' + JSON.stringify(data), 'success');
                if (data.calleeId === '3') {
                    showCallModal(data, 'B');
                }
            });

            // è®¢é˜…åŠ å…¥æˆåŠŸæ¶ˆæ¯
            clientB.subscribe('/user/queue/webrtc/joined', function(message) {
                const data = JSON.parse(message.body);
                log('âœ… ç”¨æˆ·BåŠ å…¥æˆåŠŸ: ' + JSON.stringify(data), 'success');
            });

            log('âœ… ç”¨æˆ·Bæ¶ˆæ¯è®¢é˜…å®Œæˆ');
        }

        // æ˜¾ç¤ºæ¥ç”µå¼¹çª—
        function showCallModal(data, receiverUser) {
            log(`ğŸ”” æ˜¾ç¤ºæ¥ç”µå¼¹çª—ï¼Œæ¥æ”¶è€…: ç”¨æˆ·${receiverUser}`, 'success');
            currentCallData = data;
            currentCallData.receiverUser = receiverUser;

            document.getElementById('callerInfo').textContent = `æ¥è‡ªç”¨æˆ·${data.callerId}çš„é€šè¯é‚€è¯·`;
            document.getElementById('callTypeInfo').textContent = data.callType === 'video' ? 'è§†é¢‘é€šè¯' : 'è¯­éŸ³é€šè¯';

            try {
                callModal.show();
                log('âœ… å¼¹çª—æ˜¾ç¤ºæˆåŠŸ', 'success');
            } catch (error) {
                log(`âŒ å¼¹çª—æ˜¾ç¤ºå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // ç”¨æˆ·Aå‘¼å«ç”¨æˆ·B
        function callUserB() {
            if (!clientA || !clientA.connected) {
                log('âŒ ç”¨æˆ·Aæœªè¿æ¥', 'error');
                return;
            }

            const callData = {
                callerId: '2',
                calleeId: '3',
                callType: 'video'
            };

            log(`ğŸ“ ç”¨æˆ·Aå‘èµ·é€šè¯: ${JSON.stringify(callData)}`);
            
            try {
                clientA.send('/app/webrtc/call', {}, JSON.stringify(callData));
                log('âœ… é€šè¯é‚€è¯·å·²å‘é€', 'success');
            } catch (error) {
                log(`âŒ å‘é€é€šè¯é‚€è¯·å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // ç”¨æˆ·Bå‘¼å«ç”¨æˆ·A
        function callUserA() {
            if (!clientB || !clientB.connected) {
                log('âŒ ç”¨æˆ·Bæœªè¿æ¥', 'error');
                return;
            }

            const callData = {
                callerId: '3',
                calleeId: '2',
                callType: 'video'
            };

            log(`ğŸ“ ç”¨æˆ·Bå‘èµ·é€šè¯: ${JSON.stringify(callData)}`);
            
            try {
                clientB.send('/app/webrtc/call', {}, JSON.stringify(callData));
                log('âœ… é€šè¯é‚€è¯·å·²å‘é€', 'success');
            } catch (error) {
                log(`âŒ å‘é€é€šè¯é‚€è¯·å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ¥å¬é€šè¯
        function acceptCall() {
            if (!currentCallData) return;

            log(`âœ… ç”¨æˆ·${currentCallData.receiverUser}æ¥å—é€šè¯`, 'success');
            callModal.hide();
            currentCallData = null;
        }

        // æ‹’ç»é€šè¯
        function rejectCall() {
            if (!currentCallData) return;

            log(`âŒ ç”¨æˆ·${currentCallData.receiverUser}æ‹’ç»é€šè¯`, 'error');
            callModal.hide();
            currentCallData = null;
        }

        // æ–­å¼€è¿æ¥
        function disconnectUserA() {
            if (clientA) {
                clientA.disconnect();
                clientA = null;
            }
            updateStatus('A', 'å·²æ–­å¼€');
            log('ç”¨æˆ·Aè¿æ¥å·²æ–­å¼€');
        }

        function disconnectUserB() {
            if (clientB) {
                clientB.disconnect();
                clientB = null;
            }
            updateStatus('B', 'å·²æ–­å¼€');
            log('ç”¨æˆ·Bè¿æ¥å·²æ–­å¼€');
        }
    </script>
</body>
</html>
